{% extends 'base.html' %}
{% block content %}

<style>
  :root {
    --glass: rgba(25, 25, 35, 0.82);
    --border: rgba(255,255,255,0.09);
    --blue: #0d6efd;
    --green: #20c997;
    --yellow: #ffc107;
    --orange: #fd7e14;
    --red: #dc3545;
  }

  .detail-card {
    background: var(--glass);
    border: 1px solid var(--border);
    backdrop-filter: blur(20px);
    border-radius: 1.5rem;
    box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    padding: 2.5rem;
  }

  .score-ring {
    position: relative;
    width: 220px;
    height: 220px;
    margin: 0 auto;
  }

  .score-ring svg {
    transform: rotate(-90deg);
  }

  .circle-bg {
    fill: none;
    stroke: rgba(255,255,255,0.08);
    stroke-width: 16;
  }

  .circle {
    fill: none;
    stroke-linecap: round;
    stroke-width: 16;
    transition: stroke-dashoffset 1.4s ease, stroke 0.6s ease;
  }

  .grade-badge {
    font-size: 5.5rem;
    font-weight: 900;
    line-height: 1;
    text-shadow: 0 4px 20px rgba(0,0,0,0.6);
  }

  .metric-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 1.25rem;
    padding: 1.8rem 1.2rem;
    text-align: center;
    transition: transform 0.25s ease;
  }

  .metric-card:hover {
    transform: translateY(-8px);
  }

  .metric-value {
    font-size: 3.2rem;
    font-weight: 800;
    margin: 0.6rem 0 0.3rem;
  }

  .chart-wrapper {
    background: rgba(255,255,255,0.035);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 1.25rem;
    padding: 1.8rem;
    height: 420px;
  }

  .json-box {
    background: #1a1a28;
    border-radius: 1rem;
    padding: 1.5rem;
    max-height: 500px;
    overflow-y: auto;
    font-size: 0.95rem;
    line-height: 1.5;
  }
</style>

<div class="container py-5">
  <div class="detail-card mx-auto" style="max-width: 1100px;">
    <h2 class="fw-bold text-center mb-5">
      <span class="text-primary">FFTech</span> Audit Report
    </h2>

    <div class="text-center mb-5">
      <h5 class="text-muted mb-2">Audited URL</h5>
      <h4 id="auditUrl" class="text-info fw-medium">—</h4>
    </div>

    <!-- Main Score + Ring + Grade -->
    <div class="row justify-content-center mb-5">
      <div class="col-auto text-center">
        <div class="score-ring mb-4">
          <svg viewBox="0 0 240 240">
            <circle class="circle-bg" cx="120" cy="120" r="110"/>
            <circle id="scoreCircle" class="circle" cx="120" cy="120" r="110"
                    stroke-dasharray="691" stroke-dashoffset="691"/>
          </svg>
          <div class="position-absolute top-50 start-50 translate-middle text-center">
            <div id="ovScore" class="display-2 fw-black text-white">—</div>
            <small class="text-muted">/100</small>
          </div>
        </div>
        <div id="grade" class="grade-badge text-primary">—</div>
      </div>
    </div>

    <!-- Breakdown Bar Chart -->
    <div class="chart-wrapper mb-5">
      <h5 class="text-center text-muted mb-4">Score Breakdown</h5>
      <canvas id="breakdownChart"></canvas>
    </div>

    <!-- Four Metric Cards -->
    <div class="row g-4 mb-5">
      <div class="col-md-3">
        <div class="metric-card border-info border-opacity-25">
          <div class="text-muted small text-uppercase fw-bold mb-2">On-page SEO</div>
          <div id="onpageScore" class="metric-value text-info">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card border-success border-opacity-25">
          <div class="text-muted small text-uppercase fw-bold mb-2">Performance</div>
          <div id="perfScore" class="metric-value text-success">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card border-warning border-opacity-25">
          <div class="text-muted small text-uppercase fw-bold mb-2">Link Coverage</div>
          <div id="coverageScore" class="metric-value text-warning">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card border-danger border-opacity-25">
          <div class="text-muted small text-uppercase fw-bold mb-2">AI Trust</div>
          <div id="confidence" class="metric-value text-danger">—</div>
        </div>
      </div>
    </div>

    <!-- Raw JSON (collapsible) -->
    <div class="mt-5">
      <details>
        <summary class="h6 text-muted cursor-pointer mb-3">View Raw JSON Response</summary>
        <div class="json-box">
          <pre id="auditJson"></pre>
        </div>
      </details>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadAudit(url) {
  try {
    const response = await fetch('/api/open-audit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    if (!response.ok) {
      const err = await response.json();
      alert(err.detail || 'Audit failed');
      return;
    }

    const data = await response.json();

    // Basic fields
    document.getElementById('auditUrl').textContent = url;
    document.getElementById('ovScore').textContent = data.overall_score ?? '—';
    document.getElementById('grade').textContent = data.grade ?? '—';
    document.getElementById('confidence').textContent = (data.breakdown?.confidence ?? '—') + '%';

    const bd = data.breakdown || {};
    document.getElementById('onpageScore').textContent = bd.onpage ?? '—';
    document.getElementById('perfScore').textContent = bd.performance ?? '—';
    document.getElementById('coverageScore').textContent = bd.coverage ?? '—';

    // Raw JSON
    document.getElementById('auditJson').textContent = JSON.stringify(data, null, 2);

    // Animated Score Ring
    const score = Number(data.overall_score) || 0;
    const circle = document.getElementById('scoreCircle');
    const circumference = 691; // ≈ 2 * π * 110
    circle.style.strokeDashoffset = circumference * (1 - score / 100);
    circle.style.stroke = score >= 85 ? 'var(--green)' :
                          score >= 70 ? 'var(--yellow)' :
                          score >= 55 ? 'var(--orange)' : 'var(--red)';

    // Bar Chart
    const ctx = document.getElementById('breakdownChart').getContext('2d');
    if (window.breakdownChart) window.breakdownChart.destroy();

    window.breakdownChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['SEO', 'Performance', 'Coverage', 'Trust'],
        datasets: [{
          label: 'Score',
          data: [
            bd.onpage || 0,
            bd.performance || 0,
            bd.coverage || 0,
            bd.confidence || 0
          ],
          backgroundColor: [
            'rgba(13, 110, 253, 0.65)',
            'rgba(32, 201, 151, 0.65)',
            'rgba(255, 193, 7, 0.65)',
            'rgba(220, 53, 69, 0.65)'
          ],
          borderRadius: 12,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

  } catch (err) {
    console.error(err);
    alert('Failed to load audit data');
  }
}

// Auto-load from URL parameter
const params = new URLSearchParams(window.location.search);
const auditUrl = params.get('url');
if (auditUrl) {
  loadAudit(decodeURIComponent(auditUrl));
} else {
  document.getElementById('auditUrl').textContent = 'No URL provided';
}
</script>

{% endblock %}
