<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Debug: confirm script is running at all
console.log("Audit script loaded successfully");

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM fully loaded – attaching event listeners");

  const auditButton = document.getElementById('btnOpenAudit');
  const urlInput = document.getElementById('openUrl');

  if (!auditButton) {
    console.error("Button with id='btnOpenAudit' NOT FOUND in DOM");
    alert("Error: Audit button not found. Page may have loaded incorrectly.");
    return;
  }

  if (!urlInput) {
    console.error("Input with id='openUrl' NOT FOUND");
  }

  // Click handler
  auditButton.addEventListener('click', () => {
    console.log("Run Audit button clicked");
    const url = urlInput?.value?.trim();
    if (url) {
      runAudit(url);
    } else {
      alert("Please enter a valid URL");
    }
  });

  // Enter key on input
  urlInput?.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      console.log("Enter key pressed in URL input");
      auditButton.click();
    }
  });
});

let currentWs = null;

function updateProgress(pct, msg) {
  console.log(`Progress: ${pct}% - ${msg}`);
  const bar = document.getElementById('crawlProgressBar');
  const label = document.getElementById('progressLabel');
  const status = document.getElementById('statusLabel');
  const overlay = document.getElementById('overlayStatus');

  if (bar) bar.style.width = pct + '%';
  if (label) label.textContent = pct + '%';
  if (status) status.textContent = msg;
  if (overlay) overlay.textContent = msg;
}

function showError(msg = "Audit failed – please try again") {
  console.error("Audit error:", msg);
  document.getElementById('loadingOverlay').style.display = 'none';
  document.getElementById('crawlProgressContainer').style.display = 'none';
  document.getElementById('btnOpenAudit').disabled = false;

  const results = document.getElementById('openResults');
  results.innerHTML = `
    <div class="alert alert-danger text-center p-5 rounded-4">
      <h4 class="mb-3">Error</h4>
      <p>${msg}</p>
      <button class="btn btn-outline-light mt-3 px-4" onclick="location.reload()">Retry</button>
    </div>`;
  results.classList.remove('d-none');
}

function initCharts(data) {
  console.log("Initializing charts:", data.chart_data);
  // ... your existing chart code remains here ...
  // (keep your Chart.js initialization code unchanged)
}

function runAudit(url) {
  console.log("runAudit called with:", url);

  if (!url || !/^https?:\/\//i.test(url)) {
    alert("Please enter a valid URL starting with http:// or https://");
    return;
  }

  if (currentWs) {
    currentWs.close();
    currentWs = null;
  }

  document.getElementById('loadingOverlay').style.display = 'flex';
  document.getElementById('crawlProgressContainer').style.display = 'block';
  document.getElementById('openResults').classList.add('d-none');
  document.getElementById('btnOpenAudit').disabled = true;

  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${protocol}//${location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`);
  currentWs = ws;

  let receivedAny = false;

  ws.onopen = () => {
    console.log("WebSocket connected");
  };

  ws.onmessage = (event) => {
    receivedAny = true;
    console.log("WebSocket received:", event.data);
    let data;
    try {
      data = JSON.parse(event.data);
    } catch (err) {
      console.error("Bad JSON:", event.data);
      return;
    }

    if (!data.finished) {
      updateProgress(data.crawl_progress || 0, data.status || "Analyzing…");
      return;
    }

    ws.close();

    if (data.error) {
      showError(data.error);
      return;
    }

    // Fill results (keep your existing code here)
    document.getElementById('ovScore').textContent = data.overall_score ?? '—';
    document.getElementById('grade').textContent = data.grade || '—';
    const bd = data.breakdown || {};
    document.getElementById('onpageScore').textContent = bd.onpage ?? '—';
    document.getElementById('perfScore').textContent = bd.performance ?? '—';
    document.getElementById('coverageScore').textContent = bd.coverage ?? '—';
    document.getElementById('confidence').textContent = bd.confidence ? bd.confidence + '%' : '—';

    initCharts(data);

    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('crawlProgressContainer').style.display = 'none';
    document.getElementById('btnOpenAudit').disabled = false;
    document.getElementById('openResults').classList.remove('d-none');
  };

  ws.onerror = () => {
    console.error("WebSocket error");
    ws.close();
    showError(receivedAny ? "Connection lost" : "Cannot connect to server");
  };

  ws.onclose = () => {
    console.log("WebSocket closed");
    currentWs = null;
  };
}
</script>
