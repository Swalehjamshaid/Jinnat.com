<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF Tech Audit – Graphical Dashboard</title>

<!-- Bootstrap 5 & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root {
  --primary:#fbbf24; --bg:#0f172a; --card:#111827; --border:#1f2937;
  --muted:#94a3b8; --text:#e2e8f0; --success:#22c55e; --warning:#eab308; --danger:#ef4444;
}
body { background: var(--bg); color: var(--text); font-family: system-ui,sans-serif; }
.card { background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.kpi { font-weight:800; font-size:2rem; color:var(--primary);}
.badge-grade { font-size:1.5rem; padding:0.5rem 1rem; border-radius:0.75rem;}
.progress { height:12px; background:#1e293b; border-radius:6px; overflow:hidden;}
pre.code-block { background:#0f172a; border:1px solid var(--border); border-radius:0.5rem; padding:1rem; font-size:0.9rem; max-height:300px; overflow:auto;}
.score-ring { width:200px; height:200px; margin:0 auto; position:relative;}
.score-ring svg { transform: rotate(-90deg);}
.circle-bg { stroke: rgba(255,255,255,0.1); fill:none; stroke-width:16; }
.circle { stroke-width:16; stroke-linecap:round; fill:none; transition:0.5s;}
.section-header { color: var(--primary); margin:2rem 0 1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem;}
</style>
</head>
<body>

<div class="container py-5">

  <header class="text-center mb-5">
    <h1 class="display-5 fw-bold text-warning">FF Tech Audit Dashboard</h1>
    <p class="lead muted">Graphical & fully flexible visualization of website audit</p>
  </header>

  <!-- Input -->
  <section class="card p-4 mb-5">
    <div class="row g-3 align-items-end">
      <div class="col-md-8">
        <label class="form-label fw-semibold">Website URL</label>
        <input id="urlInput" type="text" class="form-control bg-dark text-white border-secondary" placeholder="e.g., www.example.com">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button id="runBtn" class="btn btn-warning w-100">RUN AUDIT</button>
        <button id="resetBtn" class="btn btn-outline-danger w-100">RESET</button>
      </div>
    </div>
    <div id="statusLine" class="mt-3 small fw-semibold text-info">Status: Idle</div>
    <div class="progress mt-2">
      <div id="progressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
    </div>
  </section>

  <div id="errorBox" class="alert alert-danger d-none"></div>

  <!-- Results -->
  <div id="resultsArea" class="d-none">

    <!-- Overall Score -->
    <section class="text-center mb-5">
      <h5 class="muted mb-2">Audited URL</h5>
      <h4 id="auditUrl" class="text-info fw-medium">—</h4>
      <div class="score-ring my-4">
        <svg viewBox="0 0 240 240">
          <circle class="circle-bg" cx="120" cy="120" r="110"/>
          <circle id="scoreCircle" class="circle" cx="120" cy="120" r="110" stroke-dasharray="691" stroke-dashoffset="691"/>
        </svg>
        <div class="position-absolute top-50 start-50 translate-middle text-center">
          <div id="ovScore" class="display-2 fw-black text-white">—</div>
          <small class="text-muted">/100</small>
        </div>
      </div>
      <div id="grade" class="badge-grade bg-primary text-white">—</div>
    </section>

    <!-- KPI Cards -->
    <section class="row g-4" id="kpiSection"></section>

    <!-- Dynamic Cards -->
    <section>
      <h5 class="section-header">Detailed Metrics</h5>
      <div class="row g-4" id="dynamicCards"></div>
    </section>

    <!-- Charts -->
    <section>
      <h5 class="section-header">Charts</h5>
      <div class="row g-4" id="chartsSection"></div>
    </section>

    <!-- Raw JSON -->
    <section>
      <h5 class="section-header">Raw JSON</h5>
      <pre id="auditJson" class="code-block"></pre>
    </section>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);
if(!Element.prototype.empty) Element.prototype.empty=function(){this.innerHTML="";return this;};
const create=(tag,className='',html='')=>{const el=document.createElement(tag);if(className)el.className=className;if(html)el.innerHTML=html;return el;};
const setText=(id,val)=>{$(id)&&( $(id).textContent = val ?? "—");};
const pretty=obj=>JSON.stringify(obj,null,2);

function resetUI(){
  setText("statusLine","Status: Idle");
  $("progressBar").style.width="0%";
  $("kpiSection")?.empty();
  $("dynamicCards")?.empty();
  $("chartsSection")?.empty();
  $("auditJson").textContent="";
  $("resultsArea").classList.add("d-none");
  $("errorBox").classList.add("d-none");
}

function renderChart(container,title,data,type="bar"){
  const card=create("div","card p-4 mb-4");
  card.innerHTML=`<h6 class="muted fw-semibold mb-3">${title}</h6>`;
  const canvas=create("canvas");
  card.appendChild(canvas);
  container.appendChild(card);
  new Chart(canvas.getContext("2d"),{
    type,
    data,
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:"#e2e8f0"}}},
      scales:type==="bar"?{x:{ticks:{color:"#93c5fd"},grid:{color:"#1f2937"}},y:{ticks:{color:"#93c5fd"},grid:{color:"#1f2937"},beginAtZero:true}}:{}
    }
  });
}

function renderAll(msg){
  $("resultsArea").classList.remove("d-none");

  // KPIs
  const kpiSection=$("kpiSection"); kpiSection.empty();
  const kpis = msg.breakdown || {};
  for(const [key,val] of Object.entries(kpis)){
    const col=create("div","col-md-3");
    const card=create("div","card p-4 text-center");
    const displayVal = (typeof val==='object' && val.score!==undefined)?val.score:val;
    card.innerHTML=`<div class="muted small fw-semibold mb-1">${key.charAt(0).toUpperCase()+key.slice(1)}</div><div class="kpi">${displayVal ?? '—'}</div>`;
    col.appendChild(card);
    kpiSection.append(col);
  }

  // Overall Score
  setText("ovScore", msg.overall_score ?? '—');
  setText("grade", msg.grade ?? '—');
  setText("auditUrl", msg.url ?? '—');

  // Score ring
  const score = Number(msg.overall_score) || 0;
  const circle=$("scoreCircle");
  const circumference = 691;
  circle.style.strokeDashoffset = circumference * (1 - score/100);
  circle.style.stroke = score>=85 ? 'var(--success)':score>=70?'var(--warning)':score>=55?'orange':'var(--danger)';

  // Dynamic Cards
  const dyn=$("dynamicCards"); dyn.empty();
  if(msg.dynamic?.cards){
    msg.dynamic.cards.forEach(c=>{
      const col=create("div","col-md-3");
      const card=create("div","card p-3 text-center");
      card.innerHTML=`<div class="muted small mb-1">${c.title}</div><div class="kpi">${c.value}${c.unit??''}</div>`;
      col.appendChild(card);
      dyn.append(col);
    });
  }

  // Charts
  const chartsSection=$("chartsSection"); chartsSection.empty();
  if(msg.chart_data) Object.entries(msg.chart_data).forEach(([key,data])=>{
    renderChart(chartsSection,key.charAt(0).toUpperCase()+key.slice(1),data,key==="doughnut"?"doughnut":"bar");
  });

  // Raw JSON
  $("auditJson").textContent = pretty(msg);
}

// WebSocket
let socket=null;
function makeWsUrl(path){ return `${location.protocol==="https:"?"wss:":"ws:"}//${location.host}${path}`; }
function updateStatus(msg){
  if(msg.status) setText("statusLine",`Status: ${msg.status}`);
  if(typeof msg.crawl_progress==="number") $("progressBar").style.width = `${Math.min(100,Math.max(0,msg.crawl_progress))}%`;
}
function runAudit(url){
  resetUI();
  setText("statusLine","Status: Connecting...");
  $("progressBar").style.width="5%";

  if(socket?.readyState===WebSocket.OPEN) socket.close();
  socket=new WebSocket(makeWsUrl("/ws"));
  socket.addEventListener("open",()=>{ 
    setText("statusLine","Status: Connected. Sending URL…"); 
    socket.send(JSON.stringify({url}));
  });
  socket.addEventListener("message",ev=>{
    let msg;
    try{ msg=JSON.parse(ev.data); }catch(e){console.error("Parse error",e); return;}
    updateStatus(msg);
    if(msg.error){ $("errorBox").textContent=msg.error; $("errorBox").classList.remove("d-none"); }
    if(msg.finished && !msg.error){ updateStatus({status:"✅ Completed",crawl_progress:100}); renderAll(msg); }
  });
  socket.addEventListener("close",()=>{ console.log("WebSocket closed"); });
  socket.addEventListener("error",()=>{$("errorBox").textContent="Connection failed"; $("errorBox").classList.remove("d-none");});
}

// Event listeners
$("runBtn").addEventListener("click",()=>{
  const url=$("urlInput").value.trim();
  if(!url){ $("errorBox").textContent="Please enter a valid URL"; $("errorBox").classList.remove("d-none"); return; }
  runAudit(url);
});
$("resetBtn").addEventListener("click",()=>{ if(socket?.readyState===WebSocket.OPEN) socket.close(); resetUI(); });

// Auto-load from URL param
const params = new URLSearchParams(window.location.search);
const auditUrl = params.get('url');
if(auditUrl){ $("urlInput").value = decodeURIComponent(auditUrl); runAudit(auditUrl); }

</script>
</body>
</html>
