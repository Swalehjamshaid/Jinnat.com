<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF Tech Audit Engine</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:radial-gradient(circle at top right,#1e293b,#020617);
  color:#e5e7eb;
  font-family:system-ui;
}
.card-glass{
  background:rgba(17,24,39,.95);
  border:1px solid rgba(255,215,0,.15);
  border-radius:1rem;
  padding:1.25rem;
}
.metric{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,215,0,.12);
  border-radius:.75rem;
  padding:.75rem;
  text-align:center;
}
.metric h2{ color:#ffd700;font-weight:800 }
#overlay{
  position:fixed;inset:0;
  background:rgba(2,6,23,.96);
  display:none;z-index:9999;
  align-items:center;justify-content:center;
}
#overlay.show{display:flex}
pre{white-space:pre-wrap}
</style>
</head>

<body>

<div id="overlay">
  <div class="spinner-border text-warning"></div>
</div>

<div class="container py-5">

  <h1 class="fw-bold text-warning mb-4">FF Tech Audit Engine</h1>

  <div class="card-glass mb-4">
    <div class="input-group input-group-lg">
      <input id="url" class="form-control bg-dark text-light"
             placeholder="example.com or https://example.com">
      <button id="run" class="btn btn-warning fw-bold">RUN</button>
    </div>
  </div>

  <div id="results" class="card-glass d-none">
    <div class="text-center mb-4">
      <h1 id="overall" class="display-3 text-warning">—</h1>
      <div id="grade" class="text-muted"></div>
    </div>

    <div class="row g-3 mb-4" id="metrics"></div>

    <details open>
      <summary class="text-warning">Raw Backend Payload</summary>
      <pre id="raw" class="mt-2 p-3 bg-dark border rounded small"></pre>
    </details>
  </div>

</div>

<script>
const API = url => `/api/audit?url=${encodeURIComponent(url)}`;
const $ = s => document.querySelector(s);

function show(v){$("#overlay").classList.toggle("show",v)}

function extractScores(obj, path=""){
  let found=[];
  if(typeof obj!=="object"||obj===null) return found;
  for(const [k,v] of Object.entries(obj)){
    if(typeof v==="number"){
      found.push({key:path+k,value:v});
    }else if(typeof v==="object"){
      found=found.concat(extractScores(v,path+k+"."));
    }
  }
  return found;
}

function render(data){
  $("#results").classList.remove("d-none");

  $("#overall").textContent =
    data.overall_score ?? data.score ?? data.total ?? "—";

  $("#grade").textContent =
    data.grade ? `GRADE ${data.grade}` : "";

  $("#metrics").innerHTML="";

  extractScores(data)
    .filter(x=>x.key.toLowerCase().includes("score"))
    .forEach(x=>{
      $("#metrics").innerHTML+=`
      <div class="col-6 col-md-3">
        <div class="metric">
          <small class="text-muted">${x.key.replace(/\\./g," ")}</small>
          <h2>${Math.round(x.value)}</h2>
        </div>
      </div>`;
    });

  $("#raw").textContent = JSON.stringify(data,null,2);
}

$("#run").onclick=async()=>{
  let url=$("#url").value.trim();
  if(!url) return alert("Enter URL");
  if(!/^https?:\\/\\//i.test(url)) url="https://"+url;

  show(true);
  try{
    const res=await fetch(API(url));
    const data=await res.json();
    render(data);
  }catch{
    alert("Audit failed – check backend");
  }
  show(false);
};
</script>

</body>
</html>
