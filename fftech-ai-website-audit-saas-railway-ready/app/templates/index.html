<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FF Tech Audit ‚Äì World-Class Website Auditor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
  <style>
    body {background-color:#1e1e2f; color:#f1f1f1; font-family:sans-serif;}
    .metric-card {background:#2e2e3f; padding:15px; border-radius:12px; margin-bottom:15px; text-align:center;}
    .metric-card .metric-icon {font-size:2rem;}
    .metric-card .metric-value {font-size:1.5rem; font-weight:bold;}
    .progress {height:20px; border-radius:10px;}
    #resultsArea {margin-top:20px;}
    .json-tree {background:#1a1a2e; padding:10px; border-radius:10px; font-family:monospace; max-height:400px; overflow:auto;}
    .chart-container {background:#2e2e3f; padding:15px; border-radius:12px; margin-bottom:15px;}
  </style>
</head>
<body class="p-4">

<div class="container">
  <h1 class="mb-4">üåê FF Tech Audit ‚Äì World-Class Auditor</h1>

  <!-- URL Input -->
  <div class="input-group mb-3">
    <input type="text" id="urlInput" class="form-control" placeholder="Enter website URL e.g. https://example.com">
    <button class="btn btn-primary" id="runBtn">Run Audit</button>
    <button class="btn btn-secondary" id="resetBtn">Reset</button>
  </div>
  <div id="statusLine">Status: Idle</div>
  <div class="progress mt-2">
    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
  </div>

  <!-- Results -->
  <div id="resultsArea" class="d-none mt-4">

    <!-- Overview -->
    <div class="d-flex align-items-center mb-4">
      <div class="me-4 text-center">
        <svg width="120" height="120">
          <circle cx="60" cy="60" r="55" stroke="#444" stroke-width="10" fill="none"/>
          <circle id="scoreCircle" cx="60" cy="60" r="55" stroke="#ffc107" stroke-width="10" fill="none" stroke-dasharray="691" stroke-dashoffset="691" transform="rotate(-90 60 60)"/>
          <text x="50%" y="50%" text-anchor="middle" dy="0.3em" font-size="24px" fill="#fff" id="ovScore">‚Äî</text>
        </svg>
        <div>Overall Score</div>
        <div class="badge bg-info mt-2" id="grade">‚Äî</div>
      </div>
      <div class="flex-grow-1">
        <h5>Website: <span id="auditUrl"></span></h5>
        <div class="row" id="kpiSection"></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row">
      <div class="col-md-6 chart-container">
        <canvas id="barChart"></canvas>
      </div>
      <div class="col-md-6 chart-container">
        <canvas id="doughnutChart"></canvas>
      </div>
    </div>

    <!-- Competitors -->
    <div class="mt-4">
      <h4>Competitor Comparison</h4>
      <div id="competitorTable"></div>
    </div>

    <!-- AI Recommendations -->
    <div class="mt-4">
      <h4>AI Recommendations</h4>
      <div class="row" id="aiRecommendations"></div>
    </div>

    <!-- Raw JSON -->
    <div class="mt-4">
      <h4>Raw JSON Data</h4>
      <pre class="json-tree" id="rawJson"></pre>
      <button class="btn btn-success mt-2" id="exportPDF">Export PDF</button>
    </div>

  </div>
</div>

<script>
let evtSource = null;
const runBtn = document.getElementById("runBtn");
const resetBtn = document.getElementById("resetBtn");
const urlInput = document.getElementById("urlInput");
const statusLine = document.getElementById("statusLine");
const progressBar = document.getElementById("progressBar");
const resultsArea = document.getElementById("resultsArea");
const auditUrl = document.getElementById("auditUrl");
const ovScore = document.getElementById("ovScore");
const gradeBadge = document.getElementById("grade");
const kpiSection = document.getElementById("kpiSection");
const competitorTable = document.getElementById("competitorTable");
const aiRecommendations = document.getElementById("aiRecommendations");
const scoreCircle = document.getElementById("scoreCircle");
const rawJson = document.getElementById("rawJson");
const exportPDF = document.getElementById("exportPDF");

let barChartInstance = null;
let doughnutChartInstance = null;

function resetUI(){
  resultsArea.classList.add("d-none");
  kpiSection.innerHTML = "";
  competitorTable.innerHTML = "";
  aiRecommendations.innerHTML = "";
  ovScore.textContent = "‚Äî";
  gradeBadge.textContent = "‚Äî";
  progressBar.style.width = "0%";
  progressBar.textContent = "0%";
  rawJson.textContent = "";
  if(evtSource){ evtSource.close(); evtSource=null; }
  if(barChartInstance){ barChartInstance.destroy(); barChartInstance=null; }
  if(doughnutChartInstance){ doughnutChartInstance.destroy(); doughnutChartInstance=null; }
  statusLine.textContent="Status: Idle";
}

resetBtn.addEventListener("click", resetUI);

function renderKPI(data){
  kpiSection.innerHTML="";
  const categories = ["seo","performance","trust"];
  categories.forEach(cat=>{
    if(data[cat]){
      const card=document.createElement("div");
      card.className="col-md-4";
      card.innerHTML=`<div class="metric-card">
        <div class="metric-icon">${cat==="seo"?"üîç":cat==="performance"?"‚ö°":"üîí"}</div>
        <div class="metric-value">${data[cat].score||"‚Äî"}</div>
        <div class="kpi-label">${cat.toUpperCase()}</div>
      </div>`;
      kpiSection.appendChild(card);
    }
  });
}

function renderCompetitors(data){
  if(!data.competitors) return;
  let html = `<table class="table table-dark table-striped table-hover">
    <thead>
      <tr><th>Name</th><th>URL</th><th>Score</th><th>SEO</th><th>Performance</th></tr>
    </thead><tbody>`;
  data.competitors.forEach(c=>{
    html+=`<tr>
      <td>${c.competitor_name}</td>
      <td><a href="${c.competitor_url}" target="_blank">${c.competitor_url}</a></td>
      <td>${c.score}</td>
      <td>${c.seo_score}</td>
      <td>${c.performance_score}</td>
    </tr>`;
  });
  html+="</tbody></table>";
  competitorTable.innerHTML=html;
}

function renderAIRecommendations(data){
  if(!data.ai_recommendations) return;
  aiRecommendations.innerHTML="";
  data.ai_recommendations.forEach(r=>{
    const card=document.createElement("div");
    card.className="col-md-4";
    card.innerHTML=`<div class="metric-card">
      <div class="metric-icon">üí°</div>
      <div>${r.recommendation_text}</div>
      <small class="text-muted">Category: ${r.category}, Impact: ${r.impact_score}</small>
    </div>`;
    aiRecommendations.appendChild(card);
  });
}

function renderCharts(data){
  const barData = data.chart_data?.bar;
  const doughData = data.chart_data?.doughnut;

  if(barData){
    const ctx=document.getElementById("barChart").getContext("2d");
    if(barChartInstance) barChartInstance.destroy();
    barChartInstance=new Chart(ctx,{type:"bar",data:barData,options:{responsive:true,plugins:{legend:{display:false}}}});
  }

  if(doughData){
    const ctx=document.getElementById("doughnutChart").getContext("2d");
    if(doughnutChartInstance) doughnutChartInstance.destroy();
    doughnutChartInstance=new Chart(ctx,{type:"doughnut",data:doughData,options:{responsive:true,plugins:{legend:{position:"bottom"}}}});
  }
}

function renderJSONTree(data){
  rawJson.textContent=JSON.stringify(data,null,2);
}

runBtn.addEventListener("click", ()=>{
  const url=urlInput.value.trim();
  if(!url) return alert("Please enter a valid URL");

  resetUI();
  resultsArea.classList.remove("d-none");
  auditUrl.textContent=url;
  statusLine.textContent="Status: Running...";

  evtSource=new EventSource(`/api/audit?url=${encodeURIComponent(url)}`);
  evtSource.onmessage=function(event){
    let data;
    try{ data=JSON.parse(event.data); } catch(e){ console.error(e); return; }

    if(data.progress){ progressBar.style.width=data.progress+"%"; progressBar.textContent=data.progress+"%"; }
    if(data.overall_score){
      ovScore.textContent=data.overall_score;
      const dashoffset=691-(691*data.overall_score/100);
      scoreCircle.style.strokeDashoffset=dashoffset;
    }
    if(data.grade) gradeBadge.textContent=data.grade;

    renderKPI(data);
    renderCompetitors(data);
    renderAIRecommendations(data);
    renderCharts(data);
    renderJSONTree(data);

    if(data.finished||data.error){
      statusLine.textContent=data.error?"Status: Error":"Status: Finished";
      evtSource.close();
    }
  };
  evtSource.onerror=function(){
    statusLine.textContent="Status: Connection Error";
    evtSource.close();
  };
});

// PDF Export
exportPDF.addEventListener("click", ()=>{
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Audit Report: "+(urlInput.value||"Unknown"),10,10);
  doc.text(JSON.stringify(JSON.parse(rawJson.textContent),null,2),10,20);
  doc.save("audit_report.pdf");
});
</script>

</body>
</html>
