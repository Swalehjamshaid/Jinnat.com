<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FF Tech Audit Engine v4.3</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top right, #1e293b, #0a0e17);
      color: #e5e7eb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height: 100vh;
    }
    .card-glass {
      background: rgba(17, 24, 39, 0.92);
      border: 1px solid rgba(255, 215, 0, 0.16);
      border-radius: 1.25rem;
      padding: 1.8rem;
      backdrop-filter: blur(10px);
    }
    .metric-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,215,0,0.10);
      border-radius: 0.85rem;
      padding: 1.2rem;
      text-align: center;
    }
    .metric-value {
      font-size: 2.4rem;
      font-weight: 800;
      color: #ffd700;
    }
    .metric-label {
      font-size: 0.85rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(10,14,23,0.97);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }
    #loadingOverlay.show { display: flex; }
    #auditLog {
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 420px;
      overflow-y: auto;
      background: rgba(0,0,0,0.45);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid #444;
      font-size: 0.9rem;
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-warning mb-4" style="width:3.5rem;height:3.5rem;"></div>
  <h4 id="statusLabel" class="mb-3">Initializing Audit Engine...</h4>
  <div class="progress w-75" style="height:8px;max-width:500px;">
    <div id="loadingBar" class="progress-bar bg-warning" style="width:5%"></div>
  </div>
</div>

<div class="container py-5">
  <h1 class="text-center fw-bold mb-5 text-warning">
    FF Tech Audit Engine <span class="fw-light fs-4">v4.3</span>
  </h1>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card-glass" id="printableArea">
        <div class="input-group input-group-lg mb-4">
          <span class="input-group-text bg-dark text-warning border-secondary">
            <i class="bi bi-globe"></i>
          </span>
          <input id="urlInput" class="form-control bg-dark text-white border-secondary"
                 placeholder="example.com or https://www.example.com" autofocus>
          <button id="btnRun" class="btn btn-warning fw-bold px-5">RUN AUDIT</button>
        </div>

        <div id="resultsPanel" class="d-none">
          <div class="text-center mb-4">
            <h1 id="ovScore" class="display-2 fw-black text-warning">—</h1>
            <h4 id="gradeDisplay" class="text-muted">GRADE: —</h4>
            <div class="mt-3">
              <button id="btnDownload" class="btn btn-outline-warning me-2">
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button id="btnReset" class="btn btn-outline-danger">
                <i class="bi bi-arrow-repeat"></i> Reset
              </button>
            </div>
          </div>

          <div class="row g-3 mb-4 text-center">
            <div class="col-6 col-md-3"><div class="metric-box"><div class="metric-label">SEO</div><div id="seoScore" class="metric-value">—</div></div></div>
            <div class="col-6 col-md-3"><div class="metric-box"><div class="metric-label">LCP (ms)</div><div id="lcpScore" class="metric-value">—</div></div></div>
            <div class="col-6 col-md-3"><div class="metric-box"><div class="metric-label">Competitor</div><div id="compScore" class="metric-value">—</div></div></div>
            <div class="col-6 col-md-3"><div class="metric-box"><div class="metric-label">AI Trust</div><div class="metric-value">95</div></div></div>
          </div>

          <div class="row g-4">
            <div class="col-md-7">
              <canvas id="barChart" height="200"></canvas>
            </div>
            <div class="col-md-5">
              <canvas id="doughnutChart" height="200"></canvas>
              <div class="mt-3 p-3 bg-dark rounded border border-secondary small">
                <div class="d-flex justify-content-between mb-1"><span>Internal Links:</span><span id="intCount">—</span></div>
                <div class="d-flex justify-content-between mb-1"><span>External Links:</span><span id="extCount">—</span></div>
                <div class="d-flex justify-content-between"><span>Broken Links:</span><span id="brkCount" class="text-danger">—</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card-glass h-100">
        <h6 class="text-warning mb-3">Live Audit Log</h6>
        <div id="auditLog" class="small text-secondary mt-3">> Engine ready. Enter URL and click RUN AUDIT</div>
      </div>
    </div>
  </div>
</div>

<script>
let barChart, doughnutChart;
const logEl      = document.getElementById("auditLog");
const statusEl   = document.getElementById("statusLabel");
const loadingBar = document.getElementById("loadingBar");
const overlay    = document.getElementById("loadingOverlay");
const results    = document.getElementById("resultsPanel");

function log(msg, isError = false) {
  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  const entry = document.createElement("div");
  entry.style.color = isError ? "#ef4444" : "#9ca3af";
  entry.textContent = `[${time}] ${msg}`;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

document.getElementById("btnRun").onclick = () => {
  let url = document.getElementById("urlInput").value.trim();
  if (!url) return alert("Please enter a URL");
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  
  overlay.classList.add("show");
  results.classList.add("d-none");
  logEl.innerHTML = "<div>> Starting new audit sequence...</div>";
  statusEl.textContent = "Connecting to FF Engine...";
  loadingBar.style.width = "5%";

  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  // FIXED: Connects to the specific path defined in main.py
  const ws = new WebSocket(`${wsProtocol}//${location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`);

  ws.onopen = () => { log("Connection established"); statusEl.textContent = "Engine initialized..."; };
  
  ws.onmessage = (e) => {
    try {
      const r = JSON.parse(e.data);
      if (r.status) { statusEl.textContent = r.status; log(r.status); }
      if (r.crawl_progress) loadingBar.style.width = Math.min(r.crawl_progress, 100) + "%";
      if (r.error) log(r.error, true);
      
      if (r.finished) {
        overlay.classList.remove("show");
        results.classList.remove("d-none");

        // Map data to UI
        document.getElementById("ovScore").textContent     = r.overall_score ?? "—";
        document.getElementById("gradeDisplay").textContent = `GRADE: ${r.grade ?? "—"}`;
        document.getElementById("seoScore").textContent    = r.breakdown?.seo ?? "—";
        document.getElementById("lcpScore").textContent    = r.breakdown?.performance?.lcp_ms ?? "—";
        document.getElementById("compScore").textContent   = r.breakdown?.competitors?.top_competitor_score ?? "—";
        
        // Link Metrics
        const links = r.breakdown?.links || {};
        document.getElementById("intCount").textContent    = links.internal_links_count ?? "0";
        document.getElementById("extCount").textContent    = links.external_links_count ?? "0";
        document.getElementById("brkCount").textContent    = links.broken_internal_links ?? "0";

        // Update Charts
        barChart?.destroy();
        doughnutChart?.destroy();

        if (r.chart_data?.bar) {
          barChart = new Chart(document.getElementById("barChart"), { 
            type: "bar", 
            data: r.chart_data.bar, 
            options: { scales: { y: { max: 100, beginAtZero: true } }, responsive: true } 
          });
        }
        if (r.chart_data?.doughnut) {
          doughnutChart = new Chart(document.getElementById("doughnutChart"), { 
            type: "doughnut", 
            data: r.chart_data.doughnut, 
            options: { responsive: true } 
          });
        }

        log("Audit complete. Data synchronized.");
        ws.close();
      }
    } catch(err) { log("Data handling error: "+err.message, true); }
  };

  ws.onerror = () => { 
    log("Connection failure", true); 
    overlay.classList.remove("show"); 
    alert("Audit Engine Connection Failed. Ensure backend is running."); 
  };
};

document.getElementById("btnReset").onclick = () => {
  results.classList.add("d-none");
  document.getElementById("urlInput").value = "";
  logEl.innerHTML = "<div>> Results cleared. Ready.</div>";
  document.getElementById("urlInput").focus();
};

document.getElementById("btnDownload").onclick = async () => {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const canvas = await html2canvas(document.getElementById("printableArea"), {scale: 2});
    const imgData = canvas.toDataURL("image/png");
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    doc.save(`audit-report-${new Date().getTime()}.pdf`);
    log("Report exported to PDF.");
  } catch(err) { log("PDF error: "+err.message, true); }
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
