<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FF Tech Website Audit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    :root {
      --bg: #f9fafb;
      --text: #111827;
      --card: #ffffff;
      --border: #e5e7eb;
    }
    [data-theme="dark"] {
      --bg: #111827;
      --text: #f3f4f6;
      --card: #1f2937;
      --border: #374151;
    }
    body {
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
    }
    .progress-bar {
      transition: width 0.5s ease;
    }
    .grade-A  { @apply bg-green-600 text-white; }
    .grade-A\+ { @apply bg-green-700 text-white; }
    .grade-B  { @apply bg-yellow-500 text-white; }
    .grade-C  { @apply bg-orange-500 text-white; }
    .grade-D  { @apply bg-orange-600 text-white; }
    .grade-F  { @apply bg-red-600 text-white; }

    /* Spinner */
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Pulse animation for loading bar */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="min-h-screen font-sans antialiased">

  <!-- Header -->
  <header class="shadow-sm sticky top-0 z-10 backdrop-blur-md bg-opacity-90 transition-colors"
          :class="dark ? 'bg-gray-900' : 'bg-white'">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">
        FF Tech <span class="text-blue-600 dark:text-blue-400">Website Audit</span>
      </h1>
      <div class="flex items-center gap-4">
        <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
          <i id="themeIcon" class="fas fa-moon text-xl"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Input Section -->
    <section class="card rounded-xl shadow-sm p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">Audit a Website</h2>
      <div class="flex flex-col sm:flex-row gap-3">
        <input
          id="urlInput"
          type="url"
          placeholder="https://example.com"
          class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white"
          autocomplete="off"
        />
        <button
          id="startBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <span>Start Audit</span>
        </button>
      </div>
    </section>

    <!-- Progress + Loading Animation -->
    <div id="progressContainer" class="hidden mb-8">
      <div class="flex flex-col items-center gap-3">
        <div class="spinner" id="spinner"></div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
          <div id="progressBar" class="progress-bar bg-blue-600 h-3 w-0 animate-pulse"></div>
        </div>
        <div class="flex justify-between w-full text-sm">
          <span id="statusText" class="font-medium">Initializing...</span>
          <span id="percentText" class="font-medium">0%</span>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div id="errorBox" class="hidden bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 dark:border-red-400 p-5 mb-6 rounded-r-lg">
      <p class="text-red-700 dark:text-red-300 font-medium" id="errorMessage"></p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-10">

      <!-- Hero Score + PDF Button -->
      <section class="card rounded-xl shadow-sm p-8 text-center relative">
        <h2 class="text-2xl font-bold mb-3">Audit Result</h2>
        <div id="overallScore" class="text-7xl font-extrabold mb-2 grade-F">—</div>
        <div id="grade" class="text-4xl font-bold grade-F inline-block px-8 py-3 rounded-full">—</div>
        <p class="mt-4 text-gray-600 dark:text-gray-400" id="auditedUrlBlock">
          Audited: <strong id="auditedUrl">—</strong>
        </p>

        <button id="downloadPdfBtn" class="absolute top-6 right-6 bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-medium flex items-center gap-2 shadow-md transition hidden">
          <i class="fas fa-file-pdf"></i> Download PDF Report
        </button>
      </section>

      <!-- Breakdown Cards (more detailed) -->
      <section>
        <h3 class="text-xl font-semibold mb-5 text-center md:text-left">Category Breakdown</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- SEO -->
          <div class="card rounded-lg shadow-sm p-6">
            <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
              <i class="fas fa-search text-yellow-500"></i> SEO
            </h4>
            <div id="seoScore" class="text-5xl font-bold mb-3">—</div>
            <details class="text-sm">
              <summary class="cursor-pointer text-blue-600 dark:text-blue-400 font-medium">Details</summary>
              <div id="seoDetails" class="mt-3 space-y-2 text-gray-700 dark:text-gray-300"></div>
            </details>
          </div>

          <!-- Performance -->
          <div class="card rounded-lg shadow-sm p-6">
            <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
              <i class="fas fa-tachometer-alt text-cyan-500"></i> Performance
            </h4>
            <div id="perfScore" class="text-5xl font-bold mb-3">—</div>
            <details class="text-sm">
              <summary class="cursor-pointer text-blue-600 dark:text-blue-400 font-medium">Details</summary>
              <div id="perfDetails" class="mt-3 space-y-2 text-gray-700 dark:text-gray-300"></div>
            </details>
          </div>

          <!-- Links -->
          <div class="card rounded-lg shadow-sm p-6">
            <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
              <i class="fas fa-link text-green-500"></i> Links
            </h4>
            <div id="linksScore" class="text-5xl font-bold mb-3">—</div>
            <p id="linksSummary" class="text-sm text-gray-600 dark:text-gray-400"></p>
          </div>

          <!-- Security -->
          <div class="card rounded-lg shadow-sm p-6">
            <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
              <i class="fas fa-shield-alt text-red-500"></i> Security
            </h4>
            <div id="secScore" class="text-5xl font-bold mb-3">—</div>
            <p id="secSummary" class="text-sm text-gray-600 dark:text-gray-400"></p>
          </div>
        </div>
      </section>

      <!-- Chart -->
      <section class="card rounded-xl shadow-sm p-6">
        <h3 class="text-xl font-semibold mb-5">Score Visualization</h3>
        <div class="h-80">
          <canvas id="scoreChart"></canvas>
        </div>
      </section>

      <!-- Quick Facts -->
      <section>
        <h3 class="text-xl font-semibold mb-5">Quick Facts</h3>
        <div id="dynamicCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- Technical Details -->
      <section class="card rounded-xl shadow-sm overflow-hidden">
        <h3 class="text-xl font-semibold p-6 pb-4 bg-gray-50 dark:bg-gray-800 border-b">Technical Details</h3>
        <div class="divide-y dark:divide-gray-700" id="kvContainer"></div>
      </section>

    </div>

  </main>

  <footer class="mt-16 py-8 text-center text-gray-500 dark:text-gray-400 text-sm border-t dark:border-gray-700">
    FF Tech Website Audit Engine • Real-time Analysis • Powered by FastAPI
  </footer>

  <script>
    // ────────────────────────────────────────────────
    //  Theme Toggle
    // ────────────────────────────────────────────────
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;

    function setTheme(isDark) {
      if (isDark) {
        html.setAttribute('data-theme', 'dark');
        themeIcon.classList.replace('fa-moon', 'fa-sun');
      } else {
        html.removeAttribute('data-theme');
        themeIcon.classList.replace('fa-sun', 'fa-moon');
      }
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Init theme
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));

    themeToggle.addEventListener('click', () => {
      const isDark = !html.hasAttribute('data-theme');
      setTheme(isDark);
    });

    // ────────────────────────────────────────────────
    //  Elements
    // ────────────────────────────────────────────────
    const urlInput       = document.getElementById('urlInput');
    const startBtn       = document.getElementById('startBtn');
    const progressCont   = document.getElementById('progressContainer');
    const progressBar    = document.getElementById('progressBar');
    const percentText    = document.getElementById('percentText');
    const statusText     = document.getElementById('statusText');
    const spinner        = document.getElementById('spinner');
    const errorBox       = document.getElementById('errorBox');
    const errorMsg       = document.getElementById('errorMessage');
    const resultsDiv     = document.getElementById('results');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    let ws = null;
    let chart = null;

    // ────────────────────────────────────────────────
    //  WebSocket
    // ────────────────────────────────────────────────
    function startAudit() {
      const url = urlInput.value.trim();
      if (!url) return showError("Please enter a valid URL");

      let cleanUrl = url;
      if (!/^https?:\/\//i.test(cleanUrl)) cleanUrl = 'https://' + cleanUrl;

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        ws.send(JSON.stringify({ url: cleanUrl }));
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Auditing...';
        hideError();
        progressCont.classList.remove('hidden');
        resultsDiv.classList.add('hidden');
        downloadPdfBtn.classList.add('hidden');
        resetUI();
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (err) {
          console.error("Invalid WS message", err);
        }
      };

      ws.onclose = () => {
        startBtn.disabled = false;
        startBtn.innerHTML = 'Start Audit';
      };

      ws.onerror = () => {
        showError("Connection error. Please try again.");
      };
    }

    function handleMessage(data) {
      const { progress, status, payload, error, result } = data;

      if (progress !== undefined) {
        progressBar.style.width = `${progress}%`;
        percentText.textContent = `${progress}%`;
      }

      if (status) {
        statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        if (status === 'error') {
          showError(error || "An unknown error occurred");
        }
      }

      const finalResult = payload || result;
      if (finalResult && (status === 'completed' || progress === 100)) {
        renderResults(finalResult);
        progressCont.classList.add('hidden');
        downloadPdfBtn.classList.remove('hidden');
      }
    }

    // ────────────────────────────────────────────────
    //  Render Results
    // ────────────────────────────────────────────────
    function renderResults(r) {
      if (!r || !r.overall_score) return;

      resultsDiv.classList.remove('hidden');

      // Hero
      document.getElementById('overallScore').textContent = r.overall_score;
      document.getElementById('grade').textContent = r.grade;
      document.getElementById('auditedUrl').textContent = r.audited_url;

      const gradeClass = `grade-${r.grade.replace('+','\\+')}`;
      document.getElementById('overallScore').className = `text-7xl font-extrabold mb-2 ${gradeClass}`;
      document.getElementById('grade').className = `text-4xl font-bold ${gradeClass} inline-block px-8 py-3 rounded-full`;

      // Breakdown scores + details
      const b = r.breakdown || {};

      // SEO
      setScore('seoScore', b.seo?.score, 'text-yellow-600 dark:text-yellow-400');
      renderSeoDetails(b.seo?.extras || {});

      // Performance
      setScore('perfScore', b.performance?.score, 'text-cyan-600 dark:text-cyan-400');
      renderPerfDetails(b.performance?.extras || {});

      // Links
      setScore('linksScore', b.links?.score, 'text-green-600 dark:text-green-400');
      document.getElementById('linksSummary').innerHTML = `
        Internal: <strong>${b.links?.internal_links_count ?? '—'}</strong><br>
        External: <strong>${b.links?.external_links_count ?? '—'}</strong><br>
        Total: <strong>${b.links?.total_links_count ?? '—'}</strong>
      `;

      // Security
      setScore('secScore', b.security?.score, 'text-red-600 dark:text-red-400');
      document.getElementById('secSummary').innerHTML = `
        HTTPS: <strong>${b.security?.https ? 'Yes' : 'No'}</strong><br>
        HSTS: <strong>${b.security?.hsts ? 'Yes' : 'No'}</strong><br>
        Status: <strong>${b.security?.status_code ?? '—'}</strong>
      `;

      // Chart
      renderChart(r.chart_data?.[0]);

      // Dynamic cards
      const cardsCont = document.getElementById('dynamicCards');
      cardsCont.innerHTML = '';
      (r.dynamic?.cards || []).forEach(card => {
        const div = document.createElement('div');
        div.className = "card rounded-lg shadow-sm p-6";
        div.innerHTML = `
          <h4 class="font-semibold text-lg mb-2">${card.title}</h4>
          <p class="text-2xl font-bold">${card.body}</p>
        `;
        cardsCont.appendChild(div);
      });

      // KV
      const kvCont = document.getElementById('kvContainer');
      kvCont.innerHTML = '';
      (r.dynamic?.kv || []).forEach(item => {
        const row = document.createElement('div');
        row.className = "flex justify-between px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-700";
        row.innerHTML = `
          <dt class="font-medium">${item.key.replace(/_/g,' ').toUpperCase()}</dt>
          <dd class="font-mono">${escapeHtml(item.value ?? '—')}</dd>
        `;
        kvCont.appendChild(row);
      });

      // PDF download
      downloadPdfBtn.onclick = () => {
        fetch('/api/audit/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: r.audited_url })
        })
        .then(res => {
          if (!res.ok) throw new Error('PDF generation failed');
          return res.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `audit_${r.audited_url.replace(/[^a-z0-9]/gi,'_')}_${new Date().toISOString().split('T')[0]}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        })
        .catch(err => showError("Could not download PDF: " + err.message));
      };
    }

    function setScore(id, value, colorClass = '') {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value ?? '—';
        if (value !== undefined) {
          const cls = value >= 80 ? 'text-green-600 dark:text-green-400' :
                      value >= 60 ? 'text-yellow-600 dark:text-yellow-400' :
                      'text-red-600 dark:text-red-400';
          el.className = `text-5xl font-bold mb-3 ${cls} ${colorClass}`;
        }
      }
    }

    function renderSeoDetails(extras) {
      const cont = document.getElementById('seoDetails');
      cont.innerHTML = `
        <p><strong>Title:</strong> ${escapeHtml(extras.title || '—')}</p>
        <p><strong>Meta Description:</strong> ${extras.meta_description_present ? 'Present' : 'Missing'}</p>
        <p><strong>Canonical:</strong> ${extras.canonical ? 'Present' : 'Missing'}</p>
        <p><strong>H1 Count:</strong> ${extras.h1_count ?? '—'}</p>
        <p><strong>Images:</strong> ${extras.images_total ?? 0} total, ${extras.images_missing_alt ?? 0} missing alt</p>
      `;
    }

    function renderPerfDetails(extras) {
      const cont = document.getElementById('perfDetails');
      cont.innerHTML = `
        <p><strong>Load Time:</strong> ${extras.load_ms ?? '—'} ms</p>
        <p><strong>Page Size:</strong> ${(extras.bytes / 1024).toFixed(1) ?? '—'} KB</p>
        <p><strong>Scripts:</strong> ${extras.scripts ?? '—'}</p>
        <p><strong>Stylesheets:</strong> ${extras.styles ?? '—'}</p>
        <p><strong>Fetched via:</strong> ${extras.fetcher ?? '—'}</p>
      `;
    }

    function renderChart(chartDef) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: chartDef?.type || 'bar',
        data: chartDef?.data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, max: 100 } },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ────────────────────────────────────────────────
    //  UI Helpers
    // ────────────────────────────────────────────────
    function showError(msg) {
      errorMsg.textContent = msg;
      errorBox.classList.remove('hidden');
      progressCont.classList.add('hidden');
    }

    function hideError() {
      errorBox.classList.add('hidden');
    }

    function resetUI() {
      resultsDiv.classList.add('hidden');
      progressBar.style.width = '0%';
      percentText.textContent = '0%';
      statusText.textContent = 'Starting...';
      if (chart) chart.destroy();
      chart = null;
    }

    function escapeHtml(unsafe) {
      return (unsafe || '').toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ────────────────────────────────────────────────
    //  Event Listeners
    // ────────────────────────────────────────────────
    startBtn.addEventListener('click', startAudit);
    urlInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') startAudit();
    });

    urlInput.focus();
  </script>
</body>
</html>
