{% extends 'base.html' %}
{% block content %}

<div class="row">

  <!-- AUDIT CARD -->
  <div class="col-lg-7">
    <div class="card bg-body-tertiary mb-4 position-relative" id="auditCard">

      <!-- LOADING OVERLAY -->
      <div id="loadingOverlay"
           style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.6); z-index:10; border-radius:0.5rem; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="text-center text-white">
          <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status"></div>
          <div class="mt-3 fw-bold h5" id="overlayStatus">Initializing Audit...</div>
          <div class="small text-white-50" id="overlayHint">This may take a few seconds</div>
        </div>
      </div>

      <div class="card-body">
        <h4 class="card-title fw-bold">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL — no sign-in required.</p>

        <!-- URL INPUT -->
        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com" value="https://">
          <button id="btnOpenAudit" class="btn btn-primary px-4">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
            <span id="btnText">Audit</span>
          </button>
        </div>

        <!-- PROGRESS BAR -->
        <div id="crawlProgressContainer" class="mb-4" style="display:none;">
          <div class="d-flex justify-content-between mb-1">
            <span class="text-primary small fw-bold" id="statusLabel">Initializing...</span>
            <span id="progressLabel" class="text-secondary small">0%</span>
          </div>
          <div class="progress" style="height:12px; border-radius:10px;">
            <div id="crawlProgressBar"
                 class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                 role="progressbar" style="width:0%"></div>
          </div>
        </div>

        <!-- RESULTS CARD -->
        <div id="openResults" class="mt-3 d-none">
          <h5 class="mb-3">Audit Results</h5>
          <div class="row g-3">

            <!-- OVERALL SCORE -->
            <div class="col-md-4">
              <div class="p-4 rounded bg-dark-subtle text-center h-100 border">
                <b class="text-uppercase small ls-widest text-secondary">Overall Score</b>
                <div id="ovScore" class="display-5 fw-bold text-primary mt-2">-</div>
                <div id="grade" class="h4 fw-bold mt-1">-</div>
              </div>
            </div>

            <!-- BREAKDOWN CHART -->
            <div class="col-md-8">
              <div class="p-2 border rounded h-100">
                <canvas id="breakdownChart" height="160"></canvas>
              </div>
            </div>

          </div>

          <!-- METRIC DETAILS -->
          <div class="mt-4">
            <h6 class="fw-bold">Metric Details</h6>
            <div class="row g-2">
              <div class="col-6"><div class="p-2 border rounded small bg-light">SEO: <span id="onpageScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Speed: <span id="perfScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Links: <span id="coverageScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">AI Confidence: <span id="confidence" class="fw-bold float-end">-</span></div></div>
            </div>
          </div>

          <!-- RAW JSON DATA -->
          <pre id="openJson" class="small mt-4 bg-dark text-info p-3 rounded d-none" style="max-height:200px; overflow:auto;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- PASSWORDLESS SIGN-IN -->
  <div class="col-lg-5">
    <div class="card bg-body-tertiary mb-4 border-0 shadow-sm">
      <div class="card-body p-4">
        <h4 class="card-title fw-bold">Passwordless Sign-in</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label text-secondary small">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100 fw-bold">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-3">Free users can run up to 10 audits; subscribe to unlock scheduling &amp; history.</p>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let breakdownChartInstance = null;
let currentEventSource = null;

function normalizeUrl(u) {
    if (!u) return "";
    const t = u.trim();
    return /^https?:\/\//i.test(t) ? t : "https://" + t.replace(/^\/+/, '');
}

function updateProgress(percent, msg="Auditing...") {
    document.getElementById('crawlProgressBar').style.width = percent + '%';
    document.getElementById('progressLabel').textContent = percent + '%';
    document.getElementById('statusLabel').textContent = msg;
    document.getElementById('overlayStatus').textContent = msg;
}

function resetUI() {
    document.getElementById('btnOpenAudit').disabled = false;
    document.getElementById('btnText').textContent = "Audit";
    document.getElementById('btnSpinner').classList.add("d-none");
    document.getElementById('loadingOverlay').style.display = "none";
    document.getElementById('crawlProgressContainer').style.display = "none";
}

async function runAudit(url) {
    try { if (currentEventSource) currentEventSource.close(); } catch (_) {}

    // UI reset
    resetUI();
    document.getElementById('btnOpenAudit').disabled = true;
    document.getElementById('btnText').textContent = "Processing...";
    document.getElementById('btnSpinner').classList.remove("d-none");
    document.getElementById('loadingOverlay').style.display = "flex";
    document.getElementById('crawlProgressContainer').style.display = "block";
    document.getElementById('openResults').classList.add("d-none");

    updateProgress(5, "Preparing audit…");

    // SSE from Python
    const evtSource = new EventSource(`/api/open-audit-progress?url=${encodeURIComponent(url)}`);
    currentEventSource = evtSource;

    evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data || "{}");
        const percent = Math.round(((data.crawl_progress ?? 0) + (data.psi_progress ?? 0)) / 2 * 100);
        updateProgress(percent, percent < 50 ? "Crawling..." : "Analyzing...");

        if (!data.finished) return;

        evtSource.close();
        document.getElementById('openResults').classList.remove("d-none");

        // Populate Python data
        document.getElementById('ovScore').textContent = data.overall_score ?? "-";
        document.getElementById('grade').textContent   = data.grade ?? "-";
        document.getElementById('onpageScore').textContent = data.breakdown?.onpage ?? "-";
        document.getElementById('perfScore').textContent = data.breakdown?.performance ?? "-";
        document.getElementById('coverageScore').textContent = data.breakdown?.coverage ?? "-";
        document.getElementById('confidence').textContent = (data.breakdown?.confidence ?? "-") + "%";
        document.getElementById('openJson').textContent = JSON.stringify(data, null, 2);
        document.getElementById('openJson').classList.remove("d-none");

        // Chart
        const chartData = [
            Number(data.breakdown?.onpage ?? 0),
            Number(data.breakdown?.performance ?? 0),
            Number(data.breakdown?.coverage ?? 0),
            Number(data.breakdown?.confidence ?? 0)
        ];

        const ctx = document.getElementById('breakdownChart').getContext('2d');
        if (breakdownChartInstance) breakdownChartInstance.destroy();
        breakdownChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['SEO','Speed','Links','AI Confidence'],
                datasets: [{ data: chartData, backgroundColor: ["#0d6efd","#20c997","#ffc107","#dc3545"], borderRadius: 6 }]
            },
            options: { maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } } }
        });

        resetUI();
    };

    evtSource.onerror = () => { evtSource.close(); resetUI(); alert("Audit failed. Could not reach server."); };
}

document.getElementById('btnOpenAudit').addEventListener('click', () => {
    const input = document.getElementById('openUrl');
    const url = normalizeUrl(input.value);
    if (!/^https?:\/\/.+\..+/.test(url)) { alert("Enter valid URL."); return; }
    runAudit(url);
});

window.addEventListener('beforeunload', () => {
    try { if (currentEventSource) currentEventSource.close(); } catch (_) {}
});
</script>

{% endblock %}
