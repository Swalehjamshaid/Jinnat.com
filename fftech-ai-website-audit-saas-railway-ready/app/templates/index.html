<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Class Website Auditor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background-color:#1e1e2f; color:#f8f9fa; }
.card { margin:0.5rem; background:#2a2a40; color:#fff; }
#cards-container { display:flex; flex-wrap:wrap; }
#json-output { background:#0d0d1a; padding:1rem; overflow:auto; max-height:400px; border-radius:5px; }
</style>
</head>
<body>
<div class="container my-3">
<h1 class="text-center">World Class Website Auditor</h1>
<div class="mb-3">
<input type="text" id="url-input" class="form-control" placeholder="Enter website URL">
<button id="start-btn" class="btn btn-primary mt-2">Start Audit</button>
</div>

<div id="status" class="mb-2">Status: Waiting...</div>

<div class="row mb-4">
<div class="col-md-6"><canvas id="barChart"></canvas></div>
<div class="col-md-6"><canvas id="doughnutChart"></canvas></div>
</div>

<h3>Top Metrics</h3>
<div id="cards-container"></div>

<h3>Full JSON Output</h3>
<pre id="json-output"></pre>
</div>

<script>
let barChart, doughnutChart;

function renderCharts(data) {
    const barCtx = document.getElementById('barChart').getContext('2d');
    const doughCtx = document.getElementById('doughnutChart').getContext('2d');

    if(!barChart) {
        barChart = new Chart(barCtx, {
            type:'bar',
            data:data.chart_data.bar,
            options:{responsive:true, plugins:{legend:{display:false}, title:{display:true,text:'Overall Scores'}}}
        });
    } else { barChart.data = data.chart_data.bar; barChart.update(); }

    if(!doughnutChart) {
        doughnutChart = new Chart(doughCtx, {
            type:'doughnut',
            data:data.chart_data.doughnut,
            options:{responsive:true, plugins:{title:{display:true,text:'Link Health'}}}
        });
    } else { doughnutChart.data = data.chart_data.doughnut; doughnutChart.update(); }
}

function renderCards(cards) {
    const container = document.getElementById('cards-container');
    container.innerHTML = '';
    cards.forEach(c=>{
        const unit = c.unit ? ` ${c.unit}` : '';
        container.innerHTML += `<div class="card p-2"><strong>${c.title}:</strong> ${c.value}${unit}</div>`;
    });
}

document.getElementById('start-btn').addEventListener('click',()=>{
    const url = document.getElementById('url-input').value.trim();
    if(!url){ alert("Enter URL"); return; }

    document.getElementById('status').textContent = "Status: Connecting...";

    const evtSource = new EventSource(`/api/audit?url=${encodeURIComponent(url)}`);
    evtSource.onmessage = function(event){
        const data = JSON.parse(event.data);
        document.getElementById('status').textContent = `Status: ${data.status || 'Running...'}`;
        if(data.finished || data.error){
            evtSource.close();
            document.getElementById('status').textContent = data.error ? `Error: ${data.error}` : "Status: Finished!";
        }
        if(data.chart_data){ renderCharts(data); }
        if(data.dynamic && data.dynamic.cards){ renderCards(data.dynamic.cards); }
        document.getElementById('json-output').textContent = JSON.stringify(data, null, 2);
    };
});
</script>
</body>
</html>
