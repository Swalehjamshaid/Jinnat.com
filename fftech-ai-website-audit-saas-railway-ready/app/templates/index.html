<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FF Tech Audit Engine v6</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Charts & Export -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --gold:#ffd700; --panel:#111827; }
    body {
      background: radial-gradient(circle at top right, #1e293b, #020617);
      color:#e5e7eb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto;
      min-height:100vh;
    }
    .card-glass {
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,215,0,.18);
      border-radius:1.2rem;
      padding:1.3rem;
    }
    .metric {
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,215,0,.12);
      border-radius:.8rem;
      padding:.8rem;
      text-align:center;
    }
    .metric h2 { color:var(--gold); font-weight:800; }
    #overlay {
      position:fixed; inset:0;
      background:rgba(2,6,23,.96);
      display:none; z-index:9999;
      align-items:center; justify-content:center;
      flex-direction:column;
    }
    #overlay.show { display:flex; }
    #log {
      background:#020617;
      border:1px solid #334155;
      border-radius:.75rem;
      padding:.75rem;
      font-family:ui-monospace,monospace;
      font-size:.85rem;
      max-height:420px;
      overflow:auto;
    }
  </style>
</head>

<body>

<!-- LOADER -->
<div id="overlay">
  <div class="spinner-border text-warning mb-3" style="width:3rem;height:3rem"></div>
  <div id="statusText" class="mb-2">Connecting to audit engine…</div>
  <div class="progress w-75" style="max-width:420px;height:7px">
    <div id="progressBar" class="progress-bar bg-warning" style="width:5%"></div>
  </div>
</div>

<div class="container py-5">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-end mb-4">
    <h1 class="fw-bold text-warning">FF Tech Audit Engine <span class="fw-light fs-4">v6</span></h1>
    <button class="btn btn-outline-warning" id="btnReset"><i class="bi bi-arrow-repeat"></i> Reset</button>
  </div>

  <div class="row g-4">
    <!-- MAIN -->
    <div class="col-lg-8">
      <div class="card-glass" id="printArea">

        <!-- INPUT -->
        <div class="input-group input-group-lg mb-4">
          <span class="input-group-text bg-dark text-warning"><i class="bi bi-globe"></i></span>
          <input id="urlInput" class="form-control bg-dark text-light"
                 placeholder="example.com or https://example.com">
          <button id="btnRun" class="btn btn-warning fw-bold px-4">RUN</button>
        </div>

        <!-- RESULTS -->
        <div id="results" class="d-none">
          <div class="text-center mb-4">
            <h1 id="score" class="display-2 fw-bold text-warning">—</h1>
            <h5 id="grade" class="text-muted">GRADE —</h5>
          </div>

          <div class="row g-3 mb-4" id="metrics"></div>

          <div class="row g-4 mb-4" id="charts"></div>

          <details open>
            <summary class="text-warning fw-semibold">Raw Payload</summary>
            <pre id="rawJson" class="mt-2 p-3 bg-dark border rounded small"></pre>
          </details>

        </div>
      </div>
    </div>

    <!-- LOG -->
    <div class="col-lg-4">
      <div class="card-glass h-100">
        <h6 class="text-warning mb-3">Live Log</h6>
        <div id="log">&gt; Engine ready</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ─────────────────────────────
   BACKEND ROUTES (matches main.py)
───────────────────────────── */
const API = {
  ws:  url => `${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`,
  sse: url => `${location.protocol}//${location.host}/sse/audit-progress?url=${encodeURIComponent(url)}`,
  start: url => `${location.protocol}//${location.host}/api/audit-start?url=${encodeURIComponent(url)}`,
  poll: id  => `${location.protocol}//${location.host}/api/audit-poll?job_id=${id}`
};

const $ = s => document.querySelector(s);
let charts = [];
let finalPayload = null;

/* ─────────────────────────────
   UI helpers
───────────────────────────── */
function log(msg, err=false){
  const t = new Date().toLocaleTimeString();
  $("#log").innerHTML += `\n[${t}] ${msg}`;
  $("#log").scrollTop = 999999;
}
function showLoader(txt){
  $("#overlay").classList.add("show");
  $("#statusText").textContent = txt;
}
function hideLoader(){ $("#overlay").classList.remove("show"); }

/* ─────────────────────────────
   Rendering
───────────────────────────── */
function render(payload){
  $("#results").classList.remove("d-none");
  $("#score").textContent = payload.overall_score ?? payload.score ?? "—";
  $("#grade").textContent = "GRADE " + (payload.grade ?? "—");

  $("#metrics").innerHTML = "";
  Object.entries(payload.breakdown || {}).forEach(([k,v])=>{
    if(typeof v?.score === "number"){
      $("#metrics").innerHTML += `
        <div class="col-6 col-md-3">
          <div class="metric">
            <small class="text-muted">${k.toUpperCase()}</small>
            <h2>${Math.round(v.score)}</h2>
          </div>
        </div>`;
    }
  });

  $("#rawJson").textContent = JSON.stringify(payload,null,2);
}

/* ─────────────────────────────
   Transport handlers
───────────────────────────── */
function handle(data){
  if(data.status) log(data.status);
  if(data.crawl_progress!=null)
    $("#progressBar").style.width = Math.min(100,data.crawl_progress)+"%";

  if(data.partial){
    finalPayload = {...finalPayload,...data.partial};
    render(finalPayload);
  }

  if(data.finished){
    hideLoader();
    finalPayload = data;
    render(data);
    log("Audit finished");
  }
}

/* ─────────────────────────────
   WS → SSE → POLL
───────────────────────────── */
async function startAudit(url){
  showLoader("Connecting…");
  try{
    await wsAudit(url); return;
  }catch{}
  try{
    await sseAudit(url); return;
  }catch{}
  await pollAudit(url);
}

function wsAudit(url){
  return new Promise((res,rej)=>{
    const ws = new WebSocket(API.ws(url));
    ws.onopen=()=>{ log("WS connected"); res(); };
    ws.onerror=()=>rej();
    ws.onmessage=e=>handle(JSON.parse(e.data));
  });
}

function sseAudit(url){
  return new Promise((res,rej)=>{
    const es = new EventSource(API.sse(url));
    es.onopen=()=>{ log("SSE connected"); res(); };
    es.onerror=()=>{ es.close(); rej(); };
    es.onmessage=e=>handle(JSON.parse(e.data));
  });
}

async function pollAudit(url){
  log("Polling mode");
  const r = await fetch(API.start(url));
  const {job_id} = await r.json();
  while(true){
    const res = await fetch(API.poll(job_id));
    const data = await res.json();
    handle(data);
    if(data.finished) break;
    await new Promise(r=>setTimeout(r,1500));
  }
}

/* ─────────────────────────────
   Controls
───────────────────────────── */
$("#btnRun").onclick=()=>{
  let url=$("#urlInput").value.trim();
  if(!url) return alert("Enter URL");
  if(!/^https?:\/\//i.test(url)) url="https://"+url;
  $("#log").textContent="> Starting audit";
  finalPayload=null;
  startAudit(url);
};

$("#btnReset").onclick=()=>{
  $("#results").classList.add("d-none");
  $("#log").textContent="> Ready";
  finalPayload=null;
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
