<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Website Audit Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #1f1f1f; color: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        h1 { text-align: center; }
        input[type=text] { width: 70%; padding: 0.5rem; font-size: 1rem; }
        button { padding: 0.6rem 1rem; font-size: 1rem; margin-left: 0.5rem; cursor: pointer; }
        .progress-bar { width: 100%; background: #333; height: 25px; border-radius: 5px; margin-top: 1rem; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.2s; }
        .section { margin-top: 2rem; }
        .section h2 { margin-bottom: 0.5rem; }
        .grid { display: grid; gap: 1rem; }
        .card { padding: 1rem; background: #2d2d2d; border-radius: 6px; }
        .error { color: #f87171; font-weight: bold; margin-top: 1rem; }
    </style>
</head>
<body>
<div class="container">
    <h1>Website Audit Pro</h1>
    <div>
        <input type="text" id="auditUrl" placeholder="Enter website URL..." />
        <button id="runAuditBtn">Run Audit</button>
    </div>
    <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="progressText" style="margin-top:5px;">0%</div>
    <div id="errorMessage" class="error"></div>

    <div class="section">
        <h2>Summary</h2>
        <div>Audited URL: <span id="auditedUrl"></span></div>
        <div>Overall Score: <span id="overallScore"></span></div>
        <div>Grade: <span id="grade"></span></div>
    </div>

    <div class="section">
        <h2>Breakdown</h2>
        <div id="breakdownList" class="grid"></div>
    </div>

    <div class="section">
        <h2>Dynamic Cards</h2>
        <div id="dynamicCards" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));"></div>
    </div>

    <div class="section">
        <h2>Key-Value Pairs</h2>
        <div id="dynamicKV" class="grid"></div>
    </div>

    <div class="section">
        <h2>Chart</h2>
        <canvas id="chartCanvas" height="150"></canvas>
    </div>
</div>

<script>
let ws;
let chart;

const auditUrlInput = document.getElementById("auditUrl");
const runBtn = document.getElementById("runAuditBtn");
const progressFill = document.getElementById("progressFill");
const progressText = document.getElementById("progressText");
const errorMessage = document.getElementById("errorMessage");
const auditedUrlElem = document.getElementById("auditedUrl");
const overallScoreElem = document.getElementById("overallScore");
const gradeElem = document.getElementById("grade");
const breakdownList = document.getElementById("breakdownList");
const dynamicCards = document.getElementById("dynamicCards");
const dynamicKV = document.getElementById("dynamicKV");

function getGradeClass(grade) {
    switch((grade||"").toUpperCase()) {
        case "A": return "text-green-400";
        case "B": return "text-lime-400";
        case "C": return "text-yellow-400";
        case "D": return "text-orange-400";
        case "F": return "text-red-400";
        default: return "";
    }
}

runBtn.addEventListener("click", () => {
    const url = auditUrlInput.value.trim();
    if (!url) return alert("Please enter a website URL.");

    if (ws) ws.close();

    const protocol = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${protocol}://${location.host}/ws`);

    ws.onopen = () => {
        ws.send(JSON.stringify({ url }));
        errorMessage.textContent = "";
        progressFill.style.width = "0%";
        progressText.textContent = "0%";

        auditedUrlElem.textContent = "";
        overallScoreElem.textContent = "";
        gradeElem.textContent = "";
        breakdownList.innerHTML = "";
        dynamicCards.innerHTML = "";
        dynamicKV.innerHTML = "";
        if (chart) chart.destroy();
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        progressFill.style.width = msg.progress + "%";
        progressText.textContent = msg.progress + "%";

        if (msg.status === "error") {
            errorMessage.textContent = msg.payload?.error || "Unknown error";
            return;
        }

        if (msg.status === "completed") {
            const result = msg.result;

            auditedUrlElem.textContent = result.audited_url || "";
            overallScoreElem.textContent = result.overall_score || "";
            gradeElem.textContent = result.grade || "";
            gradeElem.className = getGradeClass(result.grade);

            breakdownList.innerHTML = "";
            if (result.breakdown) {
                for (const [k, v] of Object.entries(result.breakdown)) {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.textContent = `${k}: ${v}`;
                    breakdownList.appendChild(div);
                }
            }

            dynamicCards.innerHTML = "";
            if (result.dynamic?.cards) {
                result.dynamic.cards.forEach(card => {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.innerHTML = `<div><strong>${card.title || "Title"}</strong></div>
                                     <div style="font-size:1.5rem">${card.value || ""}</div>`;
                    dynamicCards.appendChild(div);
                });
            }

            dynamicKV.innerHTML = "";
            if (result.dynamic?.kv) {
                result.dynamic.kv.forEach(kv => {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.textContent = `${kv.key}: ${kv.value}`;
                    dynamicKV.appendChild(div);
                });
            }

            if (result.chart_data) {
                const ctx = document.getElementById("chartCanvas").getContext("2d");
                chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: result.chart_data.map(d => d.label || d.name || "Metric"),
                        datasets: [{
                            label: "Score",
                            data: result.chart_data.map(d => d.value || 0),
                            backgroundColor: "rgba(59, 130, 246, 0.8)"
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    };

    ws.onerror = (e) => {
        errorMessage.textContent = "WebSocket error";
        console.error(e);
    };

    ws.onclose = () => console.log("WebSocket closed");
});
</script>
</body>
</html>
