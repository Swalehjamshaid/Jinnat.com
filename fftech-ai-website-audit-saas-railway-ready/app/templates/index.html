<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Flexible Audit Runner</title>

  <!-- TailwindCSS (for fast layout). If you prefer plain CSS, you can replace this. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Simple pulse for status dot */
    .pulse {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      background: #22c55e;
      box-shadow: 0 0 0 rgba(34,197,94, 0.7);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(34,197,94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94, 0); }
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .card {
      @apply bg-white rounded-lg shadow-sm border border-slate-200 p-4;
    }
    .badge {
      @apply rounded-md px-2 py-1 text-xs font-semibold bg-slate-100 text-slate-700;
    }
    .badge-green { @apply bg-emerald-100 text-emerald-700; }
    .badge-amber { @apply bg-amber-100 text-amber-700; }
    .badge-red { @apply bg-rose-100 text-rose-700; }
    .badge-indigo { @apply bg-indigo-100 text-indigo-700; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="text-xl font-bold">Flexible Audit Runner</span>
        <span class="badge">v1.0</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="pulse" id="liveDot" title="Live"></span>
        <span class="text-sm text-slate-500" id="liveText">Idle</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-6">
    <!-- Controls -->
    <section class="card">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
        <div class="flex-1">
          <label for="urlInput" class="block text-sm font-medium mb-1">Website URL</label>
          <input
            id="urlInput"
            type="text"
            placeholder="https://www.haier.com.pk"
            class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Transport</label>
          <select id="transportSelect" class="rounded-md border border-slate-300 px-3 py-2">
            <option value="sse" selected>Server-Sent Events (SSE)</option>
            <option value="post">One-shot (POST)</option>
            <option value="ws">WebSocket</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button
            id="startBtn"
            class="rounded-md bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700"
          >Start Audit</button>
          <button
            id="cancelBtn"
            class="rounded-md bg-slate-200 text-slate-700 px-4 py-2 hover:bg-slate-300"
            disabled
          >Cancel</button>
        </div>
      </div>

      <!-- Progress -->
      <div class="mt-4">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600" id="statusLine">Status: Idle</div>
          <div class="text-sm text-slate-500" id="progressPct">0%</div>
        </div>
        <div class="w-full bg-slate-200 rounded h-2 mt-2">
          <div id="progressBar" class="h-2 rounded bg-indigo-500" style="width: 0%"></div>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <section class="grid md:grid-cols-4 gap-4">
      <div class="card">
        <div class="text-sm text-slate-500">Overall Score</div>
        <div class="text-3xl font-bold" id="overallScore">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-500">Grade</div>
        <div class="text-3xl font-bold" id="grade">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-500">SEO Score</div>
        <div class="text-3xl font-bold text-amber-600" id="seoScore">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-500">Performance Score</div>
        <div class="text-3xl font-bold text-indigo-600" id="perfScore">—</div>
        <div class="text-xs text-slate-500 mt-1">LCP (ms): <span id="lcpValue">—</span></div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Scores</h3>
          <span class="badge-indigo badge">Bar</span>
        </div>
        <canvas id="barChart" height="160"></canvas>
      </div>
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Link Health</h3>
          <span class="badge-indigo badge">Doughnut</span>
        </div>
        <canvas id="doughnutChart" height="160"></canvas>
      </div>
    </section>

    <!-- Links & Competitors -->
    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Links Summary</h3>
          <span class="badge">from runner</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">
          <div class="p-3 rounded bg-slate-100">
            <div class="text-xs text-slate-500">Internal</div>
            <div class="text-xl font-semibold" id="lnkInternal">0</div>
          </div>
          <div class="p-3 rounded bg-slate-100">
            <div class="text-xs text-slate-500">External</div>
            <div class="text-xl font-semibold" id="lnkExternal">0</div>
          </div>
          <div class="p-3 rounded bg-amber-50">
            <div class="text-xs text-amber-700">Warning</div>
            <div class="text-xl font-semibold text-amber-700" id="lnkWarning">0</div>
          </div>
          <div class="p-3 rounded bg-rose-50">
            <div class="text-xs text-rose-700">Broken</div>
            <div class="text-xl font-semibold text-rose-700" id="lnkBroken">0</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-500">Additional link fields (if any) are visible below in <strong>Dynamic → Links</strong>.</div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Competitors</h3>
          <span class="badge">top 3 (if available)</span>
        </div>
        <div class="mt-2 text-sm">
          <div>Top Competitor Score: <span class="font-semibold" id="compScore">—</span></div>
        </div>
        <ul id="compNames" class="list-disc pl-6 mt-2 text-sm space-y-1">
          <!-- Competitor names will render here -->
        </ul>
        <div id="compItemsWrap" class="mt-3 hidden">
          <div class="text-xs text-slate-500 mb-2">With scores:</div>
          <div id="compItems" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <!-- {name, score} chips -->
          </div>
        </div>
      </div>
    </section>

    <!-- Dynamic Cards -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Dynamic Cards</h3>
        <span class="badge">auto-generated</span>
      </div>
      <div id="dynCards" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- filled programmatically -->
      </div>
    </section>

    <!-- Dynamic Key/Value blocks -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Dynamic Details</h3>
        <span class="badge">performance • seo • links • competitors • plugins</span>
      </div>
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <h4 class="font-semibold text-slate-700">Performance</h4>
          <ul id="kvPerformance" class="mt-2 space-y-1 text-sm"></ul>
        </div>
        <div>
          <h4 class="font-semibold text-slate-700">SEO</h4>
          <ul id="kvSEO" class="mt-2 space-y-1 text-sm"></ul>
        </div>
        <div>
          <h4 class="font-semibold text-slate-700">Links</h4>
          <ul id="kvLinks" class="mt-2 space-y-1 text-sm"></ul>
        </div>
        <div>
          <h4 class="font-semibold text-slate-700">Competitors</h4>
          <ul id="kvCompetitors" class="mt-2 space-y-1 text-sm"></ul>
        </div>
      </div>

      <!-- Plugins -->
      <div class="mt-6">
        <h4 class="font-semibold text-slate-700">Plugins</h4>
        <div id="pluginsWrap" class="mt-2 space-y-4">
          <!-- Each plugin renders its own cards and kv -->
        </div>
      </div>
    </section>

    <!-- Raw JSON -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Raw JSON</h3>
        <div class="flex gap-2">
          <button id="copyJsonBtn" class="rounded bg-slate-200 px-3 py-1 text-sm">Copy</button>
          <button id="downloadJsonBtn" class="rounded bg-indigo-600 text-white px-3 py-1 text-sm">Download</button>
        </div>
      </div>
      <pre id="rawJson" class="mono text-xs bg-slate-900 text-slate-50 rounded mt-3 p-3 overflow-auto max-h-96">—</pre>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-xs text-slate-500">
    Built for the flexible audit engine. Streaming via SSE / WebSocket, or one‑shot POST.
  </footer>

  <script>
    // --------------- State ---------------
    let es = null;              // EventSource
    let ws = null;              // WebSocket
    let abortController = null; // For POST cancel (if needed)
    let barChart = null;
    let doughnutChart = null;
    let lastPayload = null;

    // --------------- Elements ---------------
    const urlInput = document.getElementById('urlInput');
    const startBtn = document.getElementById('startBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const liveDot = document.getElementById('liveDot');
    const liveText = document.getElementById('liveText');
    const statusLine = document.getElementById('statusLine');
    const progressPct = document.getElementById('progressPct');
    const progressBar = document.getElementById('progressBar');

    const overallScoreEl = document.getElementById('overallScore');
    const gradeEl = document.getElementById('grade');
    const seoScoreEl = document.getElementById('seoScore');
    const perfScoreEl = document.getElementById('perfScore');
    const lcpValueEl = document.getElementById('lcpValue');

    const lnkInternalEl = document.getElementById('lnkInternal');
    const lnkExternalEl = document.getElementById('lnkExternal');
    const lnkWarningEl = document.getElementById('lnkWarning');
    const lnkBrokenEl = document.getElementById('lnkBroken');

    const compScoreEl = document.getElementById('compScore');
    const compNamesEl = document.getElementById('compNames');
    const compItemsWrapEl = document.getElementById('compItemsWrap');
    const compItemsEl = document.getElementById('compItems');

    const dynCardsEl = document.getElementById('dynCards');
    const kvPerformanceEl = document.getElementById('kvPerformance');
    const kvSEOEl = document.getElementById('kvSEO');
    const kvLinksEl = document.getElementById('kvLinks');
    const kvCompetitorsEl = document.getElementById('kvCompetitors');
    const pluginsWrapEl = document.getElementById('pluginsWrap');

    const rawJsonEl = document.getElementById('rawJson');
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const transportSelect = document.getElementById('transportSelect');

    // --------------- Helpers ---------------
    function setLive(stateText, isActive) {
      liveText.textContent = stateText;
      liveDot.style.background = isActive ? '#22c55e' : '#94a3b8';
    }

    function setProgress(pct, statusText) {
      const v = Math.max(0, Math.min(100, Math.round(pct || 0)));
      progressBar.style.width = v + '%';
      progressPct.textContent = v + '%';
      if (statusText) statusLine.textContent = 'Status: ' + statusText;
    }

    function clearResults() {
      overallScoreEl.textContent = '—';
      gradeEl.textContent = '—';
      seoScoreEl.textContent = '—';
      perfScoreEl.textContent = '—';
      lcpValueEl.textContent = '—';

      lnkInternalEl.textContent = '0';
      lnkExternalEl.textContent = '0';
      lnkWarningEl.textContent = '0';
      lnkBrokenEl.textContent = '0';

      compScoreEl.textContent = '—';
      compNamesEl.innerHTML = '';
      compItemsEl.innerHTML = '';
      compItemsWrapEl.classList.add('hidden');

      dynCardsEl.innerHTML = '';
      kvPerformanceEl.innerHTML = '';
      kvSEOEl.innerHTML = '';
      kvLinksEl.innerHTML = '';
      kvCompetitorsEl.innerHTML = '';
      pluginsWrapEl.innerHTML = '';

      rawJsonEl.textContent = '—';

      destroyCharts();
    }

    function destroyCharts() {
      try { barChart && barChart.destroy(); } catch(e) {}
      try { doughnutChart && doughnutChart.destroy(); } catch(e) {}
      barChart = null;
      doughnutChart = null;
    }

    function ensureUrl(u) {
      if (!u) return '';
      const s = u.trim();
      if (!s) return '';
      return s.startsWith('http') ? s : 'https://' + s;
    }

    function chip(text) {
      const span = document.createElement('span');
      span.className = 'inline-flex items-center gap-2 rounded-full bg-slate-100 text-slate-700 px-3 py-1 text-xs';
      span.textContent = text;
      return span;
    }

    function kvLi(key, value) {
      const li = document.createElement('li');
      const k = document.createElement('span');
      k.className = 'mono text-slate-500';
      k.textContent = key + ': ';
      const v = document.createElement('span');
      v.className = 'mono font-semibold';
      v.textContent = (value === null || value === undefined) ? '—' : String(value);
      li.appendChild(k);
      li.appendChild(v);
      return li;
    }

    function cardEl(title, value, unit) {
      const div = document.createElement('div');
      div.className = 'p-3 rounded border border-slate-200 bg-white';
      const t = document.createElement('div');
      t.className = 'text-xs text-slate-500';
      t.textContent = title;
      const v = document.createElement('div');
      v.className = 'text-xl font-semibold';
      v.textContent = value === undefined ? '—' : String(value);
      div.appendChild(t);
      div.appendChild(v);
      if (unit) {
        const u = document.createElement('div');
        u.className = 'text-[10px] text-slate-400';
        u.textContent = unit;
        div.appendChild(u);
      }
      return div;
    }

    function renderCharts(chartData) {
      if (!chartData) return;
      destroyCharts();
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: chartData.bar || { labels: [], datasets: [] },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });

      const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
      doughnutChart = new Chart(doughnutCtx, {
        type: 'doughnut',
        data: chartData.doughnut || { labels: [], datasets: [] },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });
    }

    function renderFinal(payload) {
      // Summary
      overallScoreEl.textContent = payload.overall_score ?? '—';
      gradeEl.textContent = payload.grade ?? '—';

      const br = payload.breakdown || {};
      const perf = br.performance || {};
      const links = br.links || {};
      const comp = br.competitors || {};

      seoScoreEl.textContent = br.seo ?? '—';
      perfScoreEl.textContent = perf.score ?? '—';
      lcpValueEl.textContent = perf.lcp_ms ?? '—';

      lnkInternalEl.textContent = Number(links.internal_links_count || 0);
      lnkExternalEl.textContent = Number(links.external_links_count || 0);
      lnkWarningEl.textContent = Number(links.warning_links_count || 0);
      lnkBrokenEl.textContent = Number(links.broken_internal_links || 0);

      compScoreEl.textContent = comp.top_competitor_score ?? '—';
      compNamesEl.innerHTML = '';
      (Array.isArray(comp.names) ? comp.names : []).forEach(n => {
        const li = document.createElement('li');
        li.textContent = n;
        compNamesEl.appendChild(li);
      });

      compItemsEl.innerHTML = '';
      const items = Array.isArray(comp.items) ? comp.items : [];
      if (items.length) {
        compItemsWrapEl.classList.remove('hidden');
        items.forEach(it => {
          const wrap = document.createElement('div');
          wrap.className = 'flex items-center justify-between rounded bg-slate-100 px-3 py-2 text-sm';
          const nm = document.createElement('span'); nm.textContent = it.name ?? '—';
          const sc = document.createElement('span'); sc.className = 'mono font-semibold'; sc.textContent = (it.score ?? '—');
          wrap.appendChild(nm); wrap.appendChild(sc);
          compItemsEl.appendChild(wrap);
        });
      } else {
        compItemsWrapEl.classList.add('hidden');
      }

      // Charts
      renderCharts(payload.chart_data);

      // Dynamic blocks
      const dynamic = payload.dynamic || {};
      dynCardsEl.innerHTML = '';
      (dynamic.cards || []).forEach(c => {
        dynCardsEl.appendChild(cardEl(c.title ?? '—', c.value, c.unit));
      });

      kvPerformanceEl.innerHTML = '';
      (dynamic.kv?.performance || []).forEach(({key, value}) => kvPerformanceEl.appendChild(kvLi(key, value)));

      kvSEOEl.innerHTML = '';
      (dynamic.kv?.seo || []).forEach(({key, value}) => kvSEOEl.appendChild(kvLi(key, value)));

      kvLinksEl.innerHTML = '';
      (dynamic.kv?.links || []).forEach(({key, value}) => kvLinksEl.appendChild(kvLi(key, value)));

      kvCompetitorsEl.innerHTML = '';
      (dynamic.kv?.competitors || []).forEach(({key, value}) => kvCompetitorsEl.appendChild(kvLi(key, value)));

      // Plugins (cards + kv per plugin)
      pluginsWrapEl.innerHTML = '';
      const plugins = dynamic.plugins || {};
      Object.keys(plugins).forEach(name => {
        const sec = document.createElement('div');
        sec.className = 'border border-slate-200 rounded p-3 bg-white';
        const head = document.createElement('div');
        head.className = 'flex items-center justify-between mb-2';
        const h = document.createElement('h5');
        h.className = 'font-semibold text-slate-700';
        h.textContent = name;
        const b = document.createElement('span');
        b.className = 'badge';
        b.textContent = 'plugin';
        head.appendChild(h); head.appendChild(b);
        sec.appendChild(head);

        // cards
        const cardsWrap = document.createElement('div');
        cardsWrap.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2';
        (plugins[name].cards || []).forEach(c => cardsWrap.appendChild(cardEl(c.title ?? '—', c.value, c.unit)));
        sec.appendChild(cardsWrap);

        // kv
        const kvList = document.createElement('ul');
        kvList.className = 'mt-2 space-y-1 text-sm';
        (plugins[name].kv || []).forEach(({key, value}) => kvList.appendChild(kvLi(key, value)));
        sec.appendChild(kvList);

        pluginsWrapEl.appendChild(sec);
      });

      // Raw JSON
      rawJsonEl.textContent = JSON.stringify(payload, null, 2);
      lastPayload = payload;
    }

    function handleStreamMessage(msg) {
      // Status update
      if (msg.status) {
        setProgress(msg.crawl_progress ?? 0, msg.status);
      }
      // Final payload
      if (msg.finished || msg.overall_score !== undefined || msg.grade !== undefined) {
        setProgress(100, 'Finished');
        setLive('Completed', false);
        startBtn.disabled = false;
        cancelBtn.disabled = true;
        renderFinal(msg);
      }
      // Error
      if (msg.error) {
        setLive('Error', false);
        startBtn.disabled = false;
        cancelBtn.disabled = true;
        rawJsonEl.textContent = JSON.stringify(msg, null, 2);
      }
    }

    // --------------- Transports ---------------
    function startSSE(url) {
      const target = '/api/audit?url=' + encodeURIComponent(url);
      es = new EventSource(target);
      es.onmessage = (evt) => {
        try {
          const data = JSON.parse(evt.data);
          handleStreamMessage(data);
        } catch (e) {
          console.warn('Bad SSE message', e);
        }
      };
      es.onerror = () => {
        // Fallback to POST if SSE fails early
        if (progressPct.textContent === '0%') {
          console.warn('SSE failed. Falling back to POST.');
          es && es.close();
          startPOST(url);
        } else {
          setLive('SSE Error', false);
        }
      };
    }

    async function startPOST(url) {
      try {
        abortController = new AbortController();
        setProgress(10, 'Submitting (POST)...');
        const res = await fetch('/api/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
          signal: abortController.signal
        });
        const data = await res.json();
        handleStreamMessage(data);
      } catch (e) {
        handleStreamMessage({ error: String(e), finished: true });
      }
    }

    function startWS(url) {
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
      ws.onopen = () => {
        ws.send(JSON.stringify({ url }));
      };
      ws.onmessage = (evt) => {
        try {
          const data = JSON.parse(evt.data);
          handleStreamMessage(data);
        } catch (e) {}
      };
      ws.onerror = () => {
        setLive('WS Error', false);
      };
      ws.onclose = () => {
        // ignore
      };
    }

    function cancelActive() {
      try { es && es.close(); } catch(e) {}
      try { ws && ws.close(); } catch(e) {}
      try { abortController && abortController.abort(); } catch(e) {}
      es = null; ws = null; abortController = null;
      setLive('Canceled', false);
      startBtn.disabled = false;
      cancelBtn.disabled = true;
    }

    // --------------- Actions ---------------
    startBtn.addEventListener('click', () => {
      const u = ensureUrl(urlInput.value);
      if (!u) {
        alert('Enter a valid URL');
        return;
      }
      clearResults();
      setLive('Running…', true);
      setProgress(0, 'Queued');
      startBtn.disabled = true;
      cancelBtn.disabled = false;

      const mode = transportSelect.value;
      if (mode === 'post') {
        startPOST(u);
      } else if (mode === 'ws') {
        startWS(u);
      } else {
        startSSE(u);
      }
    });

    cancelBtn.addEventListener('click', cancelActive);

    copyJsonBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(rawJsonEl.textContent || '');
        copyJsonBtn.textContent = 'Copied';
        setTimeout(() => copyJsonBtn.textContent = 'Copy', 1200);
      } catch (e) {
        alert('Copy failed');
      }
    });

    downloadJsonBtn.addEventListener('click', () => {
      const blob = new Blob([rawJsonEl.textContent || '{}'], { type: 'application/json' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = 'audit-result.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    // Pre-fill sample for convenience (you can remove this)
    urlInput.value = 'https://www.haier.com.pk';
  </script>
</body>
</html>
