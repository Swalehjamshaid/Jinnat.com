
{% extends 'base.html' %}
{% block content %}

<div class="row">

  <!-- Audit Section -->
  <div class="col-lg-7">
    <div class="card bg-body-tertiary mb-4 position-relative" id="auditCard">

      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay d-flex">
        <div class="text-center text-white">
          <div class="spinner-border text-light"></div>
          <div class="mt-2">Processing...</div>
        </div>
      </div>

      <div class="card-body">
        <h4 class="card-title">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL â€” no sign-in required.</p>

        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com">
          <button id="btnOpenAudit" class="btn btn-primary">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
            <span id="btnText">Audit</span>
          </button>
        </div>

        <!-- Progress Bar -->
        <div id="crawlProgressContainer" class="progress mb-3 d-none" style="height:20px;">
          <div id="crawlProgressBar"
               class="progress-bar progress-bar-striped progress-bar-animated bg-info"
               role="progressbar"
               style="width:0%;"
               aria-valuemin="0"
               aria-valuemax="100"
               aria-valuenow="0">0%
          </div>
        </div>

        <!-- Results -->
        <div id="openResults" class="mt-3 d-none">
          <h6>Results</h6>

          <div class="row">
            <div class="col-md-4">
              <div class="p-3 rounded bg-dark-subtle">
                <strong>Overall Score</strong>
                <div id="ovScore" class="fs-3">-</div>
                <div id="grade" class="fs-4 fw-bold">-</div>
              </div>
            </div>

            <div class="col-md-8">
              <canvas id="breakdownChart" height="140"></canvas>
            </div>
          </div>

          <div class="mt-3">
            <h6>Details</h6>
            <ul class="list-group">
              <li class="list-group-item">On-page SEO: <span id="onpageScore">-</span></li>
              <li class="list-group-item">Performance: <span id="perfScore">-</span></li>
              <li class="list-group-item">Coverage: <span id="coverageScore">-</span></li>
              <li class="list-group-item">Confidence: <span id="confidence">-</span></li>
            </ul>
          </div>

          <pre id="openJson" class="small mt-3 bg-light p-2 rounded d-none"></pre>
        </div>

      </div>
    </div>
  </div>

  <!-- Passwordless Sign-in -->
  <div class="col-lg-5">
    <div class="card bg-body-tertiary mb-4">
      <div class="card-body">
        <h4 class="card-title">Passwordless Sign-in</h4>

        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>

          <button class="btn btn-success w-100">Send Magic Link</button>
        </form>

        <p class="small text-secondary mt-2">
          Free users can run up to 10 audits; subscribe to unlock scheduling & history.
        </p>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart instance
let breakdownChartInstance = null;

// Update progress bar
function updateProgress(percent) {
    const bar = document.getElementById('crawlProgressBar');
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';
    bar.setAttribute('aria-valuenow', percent);
}

async function runAudit(url) {
    const ui = {
        results: document.getElementById('openResults'),
        btn: document.getElementById('btnOpenAudit'),
        btnText: document.getElementById('btnText'),
        btnSpinner: document.getElementById('btnSpinner'),
        progress: document.getElementById('crawlProgressContainer'),
        overlay: document.getElementById('loadingOverlay'),
        ovScore: document.getElementById('ovScore'),
        grade: document.getElementById('grade'),
        onpage: document.getElementById('onpageScore'),
        perf: document.getElementById('perfScore'),
        coverage: document.getElementById('coverageScore'),
        conf: document.getElementById('confidence'),
        json: document.getElementById('openJson')
    };

    // Reset UI state
    ui.btn.disabled = true;
    ui.btnText.textContent = "Auditing...";
    ui.btnSpinner.classList.remove("d-none");
    ui.overlay.classList.add("active");
    ui.progress.classList.remove("d-none");
    updateProgress(0);

    ui.results.classList.add("d-none");
    [ui.ovScore, ui.grade, ui.onpage, ui.perf, ui.coverage, ui.conf].forEach(el => el.textContent = "-");
    ui.json.classList.add("d-none");

    try {
        const evtSource = new EventSource(`/api/open-audit-progress?url=${encodeURIComponent(url)}`);

        evtSource.onmessage = e => {
            const data = JSON.parse(e.data);

            if (data.crawl_progress !== undefined) updateProgress(Math.round(data.crawl_progress * 100));

            if (!data.finished) return;

            evtSource.close();

            ui.ovScore.textContent = data.overall_score ?? "-";
            ui.grade.textContent = data.grade ?? "-";
            ui.onpage.textContent = data.breakdown.onpage ?? "-";
            ui.perf.textContent = data.breakdown.performance ?? "-";
            ui.coverage.textContent = data.breakdown.coverage ?? "-";
            ui.conf.textContent = (data.breakdown.confidence ?? "-") + "%";

            ui.json.textContent = JSON.stringify(data, null, 2);
            ui.json.classList.remove("d-none");

            // Render chart
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChartInstance) breakdownChartInstance.destroy();

            breakdownChartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["On-page", "Performance", "Coverage", "Confidence"],
                    datasets: [{
                        label: "Score",
                        data: [
                            data.breakdown.onpage || 0,
                            data.breakdown.performance || 0,
                            data.breakdown.coverage || 0,
                            data.breakdown.confidence || 0
                        ],
                        backgroundColor: "rgba(59,130,246,0.6)",
                        borderColor: "rgba(59,130,246,1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 }},
                    plugins: { legend: { display: false }}
                }
            });

            // Restore UI
            ui.results.classList.remove("d-none");
            ui.btn.disabled = false;
            ui.btnSpinner.classList.add("d-none");
            ui.btnText.textContent = "Audit";
            ui.progress.classList.add("d-none");
            ui.overlay.classList.remove("active");
        };

        evtSource.onerror = () => {
            evtSource.close();
            alert("Error during live audit.");
            ui.btn.disabled = false;
            ui.btnSpinner.classList.add("d-none");
            ui.btnText.textContent = "Audit";
            ui.progress.classList.add("d-none");
            ui.overlay.classList.remove("active");
        };

    } catch (error) {
        console.error(error);
        alert("Audit error occurred.");
        ui.btn.disabled = false;
        ui.btnSpinner.classList.add("d-none");
        ui.btnText.textContent = "Audit";
        ui.progress.classList.add("d-none");
        ui.overlay.classList.remove("active");
    }
}

// Button handler
document.getElementById('btnOpenAudit').addEventListener('click', () => {
    const url = document.getElementById('openUrl').value.trim();
    if (!url || !/^https?:\/\//i.test(url)) return alert("Please enter a valid URL (http/https)");
    runAudit(url);
});
</script>

<style>
/* Clean centralized overlay CSS */
#loadingOverlay {
  display: none;
  position: absolute;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.4);
  border-radius: .5rem;
  z-index:10;
  align-items:center;
  justify-content:center;
}

#loadingOverlay.active {
  display: flex;
}
</style>

{% endblock %}
