<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <title>SEO Audit – Flexible Runner</title>

  <!-- Bootstrap (optional for styling) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border: 1px solid #1f2937; }
    .progress { background-color: #1f2937; height: 10px; }
    .badge-grade { font-size: 1.25rem; }
    .muted { color: #94a3b8; }
    .kpi { font-weight: 600; font-size: 1.1rem; }
    .small-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #93c5fd; }
    .error { color: #fecaca; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-3">SEO Audit <span class="muted">– Flexible Runner</span></h1>

    <!-- Input -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-8">
          <label for="urlInput" class="form-label mb-1">Website URL</label>
          <input id="urlInput" type="text" class="form-control"
                 placeholder="e.g., www.haier.com.pk" />
        </div>
        <div class="col-md-4 d-flex align-items-end gap-2">
          <button id="runBtn" class="btn btn-primary w-100">Run Audit</button>
          <button id="resetBtn" class="btn btn-outline-light w-100">Reset</button>
        </div>
      </div>
      <div id="statusLine" class="mt-3 small small-mono">Status: Idle</div>
      <div class="progress mt-2">
        <div id="progressBar" class="progress-bar bg-info" style="width: 0%"></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted">Overall Score</div>
          <div id="overallScore" class="kpi">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted">Grade</div>
          <div id="grade" class="kpi badge bg-warning text-dark badge-grade">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted">SEO Score</div>
          <div id="seoScore" class="kpi">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted">Speed Score</div>
          <div id="perfScore" class="kpi">—</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <div class="card p-3">
          <div class="muted mb-2">Score Breakdown</div>
          <canvas id="barChart" height="140"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <div class="muted mb-2">Link Health</div>
          <canvas id="doughnutChart" height="140"></canvas>
        </div>
      </div>
    </div>

    <!-- Details -->
    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <div class="card p-3">
          <div class="muted mb-2">Links</div>
          <div id="linksSummary" class="small">
            Internal: — | External: — | Warnings: — | Broken: —
          </div>
          <pre id="linksRaw" class="mt-2 small small-mono" style="max-height: 220px; overflow:auto;"></pre>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <div class="muted mb-2">Performance</div>
          <div id="perfSummary" class="small">
            LCP (ms): — | Score: —
          </div>
          <pre id="perfExtras" class="mt-2 small small-mono" style="max-height: 220px; overflow:auto;"></pre>
        </div>
      </div>
    </div>

    <!-- Competitors -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="muted">Competitors (Top 3)</div>
            <div class="small text-info">Flexible: uses names or name+score if provided</div>
          </div>
          <ul id="competitorList" class="mt-2 mb-0"></ul>
          <pre id="competitorItems" class="mt-2 small small-mono" style="max-height: 220px; overflow:auto;"></pre>
        </div>
      </div>
    </div>

    <!-- Errors -->
    <div id="errorBox" class="mt-3 error"></div>

    <footer class="mt-4 small muted">
      <div>© Audit Runner – Works with flexible analyzer inputs/outputs.</div>
    </footer>
  </div>

  <script>
    // --------- Utilities
    const $ = (id) => document.getElementById(id);
    const setText = (id, val) => { $(id).textContent = val; };
    const pretty = (obj) => JSON.stringify(obj, null, 2);
    const deepGet = (obj, path, fallback = undefined) => {
      try {
        return path.split(".").reduce((a, k) => (a && a[k] !== undefined ? a[k] : undefined), obj) ?? fallback;
      } catch { return fallback; }
    };

    // --------- Charts
    let barChart, doughnutChart;

    function destroyCharts() {
      if (barChart) { barChart.destroy(); barChart = null; }
      if (doughnutChart) { doughnutChart.destroy(); doughnutChart = null; }
    }

    function renderBarChart(data) {
      const ctx = $("barChart").getContext("2d");
      destroyCharts();
      barChart = new Chart(ctx, {
        type: "bar",
        data: data,
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#e2e8f0" } },
            title: { display: false }
          },
          scales: {
            x: { ticks: { color: "#93c5fd" }, grid: { color: "#1f2937" } },
            y: { ticks: { color: "#93c5fd" }, grid: { color: "#1f2937" }, beginAtZero: true, max: 100 }
          }
        }
      });
    }

    function renderDoughnutChart(data) {
      const ctx = $("doughnutChart").getContext("2d");
      doughnutChart = new Chart(ctx, { type: "doughnut", data: data, options: { responsive: true } });
    }

    function resetUI() {
      setText("statusLine", "Status: Idle");
      $("progressBar").style.width = "0%";
      setText("overallScore", "—");
      setText("grade", "—");
      setText("seoScore", "—");
      setText("perfScore", "—");
      setText("linksSummary", "Internal: — | External: — | Warnings: — | Broken: —");
      setText("perfSummary", "LCP (ms): — | Score: —");
      $("linksRaw").textContent = "";
      $("perfExtras").textContent = "";
      $("competitorList").innerHTML = "";
      $("competitorItems").textContent = "";
      $("errorBox").textContent = "";
      destroyCharts();
    }

    // --------- WebSocket handling
    function makeWsUrl(path) {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      return `${proto}://${location.host}${path}`;
    }

    let socket = null;

    $("resetBtn").addEventListener("click", () => {
      if (socket && socket.readyState === WebSocket.OPEN) socket.close();
      resetUI();
    });

    $("runBtn").addEventListener("click", () => {
      const url = $("urlInput").value.trim();
      if (!url) {
        $("errorBox").textContent = "Please enter a URL.";
        return;
      }
      runAudit(url);
    });

    function updateStatus(msg) {
      const status = msg.status || null;
      const progress = msg.crawl_progress || null;
      if (status) setText("statusLine", `Status: ${status}`);
      if (typeof progress === "number") {
        $("progressBar").style.width = `${Math.max(0, Math.min(100, progress))}%`;
      }
    }

    function renderCompetitors(block) {
      const ul = $("competitorList");
      ul.innerHTML = "";
      const names = (block && Array.isArray(block.names)) ? block.names : [];
      const items = (block && Array.isArray(block.items)) ? block.items : [];

      if (items.length > 0) {
        // Prefer name + score if provided
        items.slice(0, 3).forEach(it => {
          const li = document.createElement("li");
          li.textContent = `${it.name} — ${("score" in it ? it.score : "—")}`;
          ul.appendChild(li);
        });
        $("competitorItems").textContent = pretty(items);
      } else if (names.length > 0) {
        names.slice(0, 3).forEach(n => {
          const li = document.createElement("li");
          li.textContent = n;
          ul.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "No competitors detected by analyzer.";
        ul.appendChild(li);
      }
    }

    function renderFinalPayload(msg) {
      const overall = msg.overall_score ?? "—";
      const grade = msg.grade ?? "—";
      const seo = deepGet(msg, "breakdown.seo", "—");
      const perfScore = deepGet(msg, "breakdown.performance.score", "—");
      const lcp = deepGet(msg, "breakdown.performance.lcp_ms", "—");
      setText("overallScore", overall);
      setText("grade", grade);
      setText("seoScore", seo);
      setText("perfScore", perfScore);

      // Links
      const links = deepGet(msg, "breakdown.links", {});
      const il = parseInt(links.internal_links_count ?? 0, 10);
      const el = parseInt(links.external_links_count ?? 0, 10);
      const wl = parseInt(links.warning_links_count ?? 0, 10);
      const bl = parseInt(links.broken_internal_links ?? 0, 10);
      setText("linksSummary", `Internal: ${il} | External: ${el} | Warnings: ${wl} | Broken: ${bl}`);
      $("linksRaw").textContent = pretty(links);

      // Performance
      setText("perfSummary", `LCP (ms): ${lcp} | Score: ${perfScore}`);
      const perfExtras = deepGet(msg, "breakdown.performance.extras", {});
      $("perfExtras").textContent = pretty(perfExtras);

      // Charts
      const bar = deepGet(msg, "chart_data.bar", null);
      const dough = deepGet(msg, "chart_data.doughnut", null);
      if (bar) renderBarChart(bar);
      if (dough) renderDoughnutChart(dough);

      // Competitors
      const compBlock = deepGet(msg, "breakdown.competitors", { names: [], items: [] });
      renderCompetitors(compBlock);
    }

    function runAudit(url) {
      resetUI();
      $("statusLine").textContent = "Status: Connecting…";
      $("progressBar").style.width = "5%";

      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }

      socket = new WebSocket(makeWsUrl("/ws/audit"));

      socket.addEventListener("open", () => {
        $("statusLine").textContent = "Status: Connected. Starting audit…";
        socket.send(JSON.stringify({ url }));
      });

      socket.addEventListener("message", (ev) => {
        let msg = {};
        try { msg = JSON.parse(ev.data); } catch { /* ignore */ }

        // Streamed status updates
        if (msg.status || typeof msg.crawl_progress === "number") {
          updateStatus(msg);
        }

        // Error
        if (msg.error) {
          $("errorBox").textContent = msg.error;
        }

        // Final payload
        if (msg.finished && !msg.error) {
          updateStatus({ status: "✅ Completed", crawl_progress: 100 });
          renderFinalPayload(msg);
        }
      });

      socket.addEventListener("close", () => {
        // No-op; final message already handled
      });

      socket.addEventListener("error", () => {
        $("errorBox").textContent = "WebSocket error";
      });
    }
  </script>
</body>
</html>
