{% extends 'base.html' %}
{% block content %}

<div class="row">

  <!-- AUDIT CARD -->
  <div class="col-lg-7">
    <div class="card bg-body-tertiary mb-4 position-relative" id="auditCard">

      <!-- LOADING OVERLAY -->
      <div id="loadingOverlay" style="display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 10; border-radius: 0.5rem; display:flex; align-items:center; justify-content:center; flex-direction: column;">
        <div class="text-center text-white">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
          <div class="mt-3 fw-bold h5" id="overlayStatus">Initializing AI Audit...</div>
          <div class="small text-white-50">This may take a few seconds</div>
        </div>
      </div>

      <div class="card-body">
        <h4 class="card-title fw-bold">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL â€” no sign-in required.</p>

        <!-- URL INPUT -->
        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com" value="https://">
          <button id="btnOpenAudit" class="btn btn-primary px-4">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
            <span id="btnText">Audit</span>
          </button>
        </div>

        <!-- PROGRESS BAR -->
        <div id="crawlProgressContainer" class="mb-4" style="display:none;">
          <div class="d-flex justify-content-between mb-1">
            <span class="text-primary small fw-bold" id="statusLabel">Initializing...</span>
            <span id="progressLabel" class="text-secondary small">0%</span>
          </div>
          <div class="progress" style="height: 12px; border-radius: 10px;">
            <div id="crawlProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
          </div>
        </div>

        <!-- RESULTS CARD -->
        <div id="openResults" class="mt-3 d-none">
          <h5 class="mb-3">Audit Results</h5>
          <div class="row g-3">

            <!-- OVERALL SCORE -->
            <div class="col-md-4">
              <div class="p-4 rounded bg-dark-subtle text-center h-100 border">
                <b class="text-uppercase small ls-widest text-secondary">Overall Score</b>
                <div id="ovScore" class="display-5 fw-bold text-primary mt-2">-</div>
                <div id="grade" class="h4 fw-bold mt-1">-</div>
              </div>
            </div>

            <!-- BREAKDOWN CHART -->
            <div class="col-md-8">
              <div class="p-2 border rounded h-100">
                <canvas id="breakdownChart" height="160"></canvas>
              </div>
            </div>

          </div>

          <!-- METRIC DETAILS -->
          <div class="mt-4">
            <h6 class="fw-bold">Metric Details</h6>
            <div class="row g-2">
              <div class="col-6"><div class="p-2 border rounded small bg-light">SEO: <span id="onpageScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Speed: <span id="perfScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Links: <span id="coverageScore" class="fw-bold float-end">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">AI Confidence: <span id="confidence" class="fw-bold float-end">-</span></div></div>
            </div>
          </div>

          <!-- RAW JSON DATA -->
          <pre id="openJson" class="small mt-4 bg-dark text-info p-3 rounded d-none" style="max-height: 200px; overflow: auto;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- PASSWORDLESS SIGN-IN -->
  <div class="col-lg-5">
    <div class="card bg-body-tertiary mb-4 border-0 shadow-sm">
      <div class="card-body p-4">
        <h4 class="card-title fw-bold">Passwordless Sign-in</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label text-secondary small">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100 fw-bold">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-3">Free users can run up to 10 audits; subscribe to unlock scheduling & history.</p>
      </div>
    </div>
  </div>

</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let breakdownChartInstance = null;

// -----------------------------
// Progress bar & overlay updates
// -----------------------------
function updateProgress(percent, msg = "Auditing...") {
    const bar = document.getElementById('crawlProgressBar');
    const label = document.getElementById('progressLabel');
    const statusLabel = document.getElementById('statusLabel');
    const overlayStatus = document.getElementById('overlayStatus');
    
    bar.style.width = percent + '%';
    label.textContent = percent + '%';
    if(statusLabel) statusLabel.textContent = msg;
    if(overlayStatus) overlayStatus.textContent = msg;
}

// -----------------------------
// Run Audit (SSE + Python Integration)
// -----------------------------
async function runAudit(url) {
    const ui = {
        results: document.getElementById('openResults'),
        btn: document.getElementById('btnOpenAudit'),
        btnText: document.getElementById('btnText'),
        btnSpinner: document.getElementById('btnSpinner'),
        progress: document.getElementById('crawlProgressContainer'),
        overlay: document.getElementById('loadingOverlay'),
        ovScore: document.getElementById('ovScore'),
        grade: document.getElementById('grade'),
        onpage: document.getElementById('onpageScore'),
        perf: document.getElementById('perfScore'),
        coverage: document.getElementById('coverageScore'),
        conf: document.getElementById('confidence'),
        json: document.getElementById('openJson')
    };

    // UI Reset
    ui.btn.disabled = true;
    ui.btnText.textContent = "Processing...";
    ui.btnSpinner.classList.remove("d-none");
    ui.overlay.style.display = "flex";
    ui.progress.style.display = "block";
    ui.results.classList.add("d-none");
    updateProgress(10, "Connecting to AI Audit Engine...");

    try {
        const evtSource = new EventSource(`/api/open-audit-progress?url=${encodeURIComponent(url)}`);
        
        evtSource.onmessage = e => {
            const data = JSON.parse(e.data);

            // Incremental progress
            const crawlP = Math.round((data.crawl_progress ?? 0) * 100);
            const psiP = Math.round((data.psi_progress ?? 0) * 100);
            const combined = Math.round((crawlP + psiP) / 2);
            updateProgress(combined, combined < 50 ? "Crawling Website..." : "Analyzing Performance...");

            if (!data.finished) return;

            evtSource.close();

            if (data.error) {
                alert("Audit failed: " + data.error);
                ui.btn.disabled = false;
                ui.btnText.textContent = "Audit";
                ui.btnSpinner.classList.add("d-none");
                ui.overlay.style.display = "none";
                ui.progress.style.display = "none";
                return;
            }

            // Populate results
            ui.ovScore.textContent = data.overall_score ?? "-";
            ui.grade.textContent = data.grade ?? "-";
            ui.onpage.textContent = data.breakdown.onpage ?? "-";
            ui.perf.textContent = data.breakdown.performance ?? "-";
            ui.coverage.textContent = data.breakdown.coverage ?? "-";
            ui.conf.textContent = (data.breakdown.confidence ?? "-") + "%";

            ui.json.textContent = JSON.stringify(data, null, 2);
            ui.json.classList.remove("d-none");

            // Chart
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChartInstance) breakdownChartInstance.destroy();
            breakdownChartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["SEO", "Speed", "Links", "AI Confidence"],
                    datasets: [{
                        data: [data.breakdown.onpage, data.breakdown.performance, data.breakdown.coverage, data.breakdown.confidence],
                        backgroundColor: "#0d6efd",
                        borderRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // UI reset
            ui.results.classList.remove("d-none");
            ui.btn.disabled = false;
            ui.btnText.textContent = "Audit";
            ui.btnSpinner.classList.add("d-none");
            ui.overlay.style.display = "none";
            ui.progress.style.display = "none";
        };

        evtSource.onerror = () => {
            evtSource.close();
            ui.overlay.style.display = "none";
            ui.btn.disabled = false;
            ui.btnText.textContent = "Audit";
            ui.btnSpinner.classList.add("d-none");
            ui.progress.style.display = "none";
            alert("Audit failed: Unable to reach server.");
        };

    } catch (error) {
        ui.overlay.style.display = "none";
        ui.btn.disabled = false;
        ui.btnText.textContent = "Audit";
        ui.btnSpinner.classList.add("d-none");
        ui.progress.style.display = "none";
        alert("Unexpected error occurred: " + error.message);
    }
}

// Event Listener
document.getElementById('btnOpenAudit').addEventListener('click', () => {
    const url = document.getElementById('openUrl').value.trim();
    if (url.startsWith('http')) runAudit(url);
    else alert("Please enter a valid URL (https://...)");
});
</script>

{% endblock %}
