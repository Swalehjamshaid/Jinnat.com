<script>
  // ──────────────────────────────────────────────
  // Utilities
  // ──────────────────────────────────────────────
  const $ = id => document.getElementById(id);
  if (!Element.prototype.empty) {
    Element.prototype.empty = function () { this.innerHTML = ""; return this; }
  }
  const create = (tag, className = '', html = '') => {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (html) el.innerHTML = html;
    return el;
  };
  const setText = (id, val) => { if ($(id)) $(id).textContent = val ?? "—"; };
  const pretty = obj => JSON.stringify(obj, null, 2);
  const deepGet = (obj, path, fallback = "—") => {
    try { return path.split(".").reduce((a, k) => (a && a[k] !== undefined ? a[k] : undefined), obj) ?? fallback; }
    catch { return fallback; }
  };
  function logDebug(...args) {
    console.log(...args);
    const s = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(" ");
    const log = $("debugLog");
    if (log) {
      log.textContent += s + "\n";
      log.scrollTop = log.scrollHeight;
    }
  }

  // ──────────────────────────────────────────────
  // API helpers
  // ──────────────────────────────────────────────
  async function apiPost(path, body) {
    const res = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {})
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }
  async function apiGet(path) {
    const res = await fetch(path, { method: "GET" });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  // ──────────────────────────────────────────────
  // Auth management
  // ──────────────────────────────────────────────
  const Auth = {
    get token() { return localStorage.getItem("auth_token") || ""; },
    set token(v) { v ? localStorage.setItem("auth_token", v) : localStorage.removeItem("auth_token"); },
    get email() { return localStorage.getItem("auth_email") || ""; },
    set email(v) { v ? localStorage.setItem("auth_email", v) : localStorage.removeItem("auth_email"); }
  };
  function updateAuthUI() {
    const isAuthed = !!Auth.token && !!Auth.email;
    $("authUserBadge").classList.toggle("d-none", !isAuthed);
    $("signOutBtn").classList.toggle("d-none", !isAuthed);
    $("authBtn").classList.toggle("d-none", isAuthed);
    setText("authUserEmail", Auth.email || "—");
  }
  function signOut() {
    Auth.token = "";
    Auth.email = "";
    updateAuthUI();
    logDebug("Signed out");
  }

  // ──────────────────────────────────────────────
  // Charts rendering
  // ──────────────────────────────────────────────
  function renderChart(container, title, data, type = "bar") {
    const card = create("div", "card p-4 mb-4");
    card.innerHTML = `<h6 class="muted fw-semibold mb-3">${title}</h6>`;
    const canvas = create("canvas");
    card.appendChild(canvas);
    container.appendChild(card);

    const ctx = canvas.getContext("2d");
    new Chart(ctx, {
      type,
      data,
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#e2e8f0" } } },
        scales: type === "bar" ? {
          x: { ticks: { color: "#93c5fd" }, grid: { color: "#1f2937" } },
          y: { ticks: { color: "#93c5fd" }, grid: { color: "#1f2937" }, beginAtZero: true }
        } : {}
      }
    });
  }

  // ──────────────────────────────────────────────
  // Reset UI
  // ──────────────────────────────────────────────
  function resetUI() {
    setText("statusLine", "Status: Idle");
    $("progressBar").style.width = "0%";
    $("kpiSection").empty();
    $("chartsSection").empty();
    $("breakdownSection").empty();
    $("resultsArea").classList.add("d-none");
    $("errorBox").textContent = "";
    $("errorBox").classList.add("d-none");
    $("debugPanel").classList.add("d-none");
    $("debugLog").textContent = "";
  }

  // ──────────────────────────────────────────────
  // Render all results
  // ──────────────────────────────────────────────
  function renderAll(msg) {
    $("resultsArea").classList.remove("d-none");

    // KPIs
    const kpiSection = $("kpiSection");
    kpiSection.empty();
    const possibleKpis = [
      { label: "Overall Score", path: "overall_score" },
      { label: "Grade", path: "grade", badge: true },
      { label: "SEO Score", path: "breakdown.seo" },
      { label: "Speed Score", path: "breakdown.performance.score" },
      { label: "Competitor Score", path: "breakdown.competitors.top_competitor_score" }
    ];
    possibleKpis.forEach(k => {
      const val = deepGet(msg, k.path);
      if (val !== "—" && val !== undefined) {
        const col = create("div", "col-md-3");
        const card = create("div", "card p-4 text-center");
        card.innerHTML = `
          <div class="muted small fw-semibold mb-1">${k.label}</div>
          ${k.badge ? `<div class="badge badge-grade bg-success">${val}</div>` : `<div class="kpi">${val}</div>`}`;
        col.appendChild(card);
        kpiSection.append(col);
      }
    });

    // Charts
    const chartsSection = $("chartsSection");
    chartsSection.empty();
    if (msg.chart_data) {
      Object.entries(msg.chart_data).forEach(([key, data]) => {
        renderChart(chartsSection, key.charAt(0).toUpperCase() + key.slice(1), data);
      });
    }

    // Breakdown
    const breakdownSection = $("breakdownSection");
    breakdownSection.empty();
    if (msg.breakdown) {
      const h2 = create("h4", "section-header");
      h2.textContent = "Detailed Breakdown";
      breakdownSection.append(h2);

      Object.entries(msg.breakdown).forEach(([sectionName, data]) => {
        const section = create("div", "card p-4 mb-4");
        section.innerHTML = `<h5 class="text-warning mb-3">${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}</h5>`;
        const pre = create("pre", "code-block");
        pre.textContent = pretty(data);
        section.appendChild(pre);
        breakdownSection.append(section);
      });
    }

    // Raw JSON
    const rawSection = create("div", "card p-4 mt-5");
    rawSection.innerHTML = `<h5 class="text-warning mb-3">Raw Payload (Debug)</h5>`;
    const pre = create("pre", "code-block");
    pre.textContent = pretty(msg);
    rawSection.appendChild(pre);
    breakdownSection.append(rawSection);
  }

  // ──────────────────────────────────────────────
  // WebSocket
  // ──────────────────────────────────────────────
  function makeWsUrl(path) {
    const proto = location.protocol === "https:" ? "wss:" : "ws:";
    return `${proto}//${location.host}${path}`;
  }

  let socket = null;

  $("resetBtn").addEventListener("click", () => {
    if (socket?.readyState === WebSocket.OPEN) socket.close();
    resetUI();
  });

  $("runBtn").addEventListener("click", () => {
    console.log("RUN AUDIT button clicked"); // debug
    const url = $("urlInput").value.trim();
    if (!url) {
      $("errorBox").textContent = "Please enter a valid URL.";
      $("errorBox").classList.remove("d-none");
      return;
    }
    runAudit(url);
  });

  function updateStatus(msg) {
    if (msg.status) setText("statusLine", `Status: ${msg.status}`);
    if (typeof msg.crawl_progress === "number") {
      $("progressBar").style.width = `${Math.min(100, Math.max(0, msg.crawl_progress))}%`;
    }
  }

  function runAudit(url) {
    resetUI();
    setText("statusLine", "Status: Connecting to WebSocket…");
    $("progressBar").style.width = "5%";
    $("errorBox").classList.add("d-none");
    $("debugPanel").classList.remove("d-none");
    logDebug(`Starting audit for: ${url}`);

    if (socket?.readyState === WebSocket.OPEN) {
      logDebug("Closing old socket...");
      socket.close();
    }

    const wsUrl = makeWsUrl("/ws");
    logDebug(`Connecting to WebSocket: ${wsUrl}`);
    socket = new WebSocket(wsUrl);

    socket.addEventListener("open", () => {
      logDebug("WebSocket connected!");
      setText("statusLine", "Status: Connected. Sending URL…");
      const payload = { url, token: Auth.token || undefined };
      socket.send(JSON.stringify(payload));
      logDebug("Sent: " + JSON.stringify(payload));
    });

    socket.addEventListener("message", ev => {
      logDebug("Received raw:", ev.data);
      let msg;
      try { msg = JSON.parse(ev.data); } catch (e) { logDebug("Parse error:", e); return; }

      if (msg.status || typeof msg.crawl_progress === "number") updateStatus(msg);
      if (msg.error) {
        $("errorBox").textContent = msg.error;
        $("errorBox").classList.remove("d-none");
        logDebug("Error from server:", msg.error);
      }
      if (msg.finished && !msg.error) {
        updateStatus({ status: "✅ Completed", crawl_progress: 100 });
        logDebug("Audit finished – rendering results");
        renderAll(msg);
      }
    });

    socket.addEventListener("close", ev => {
      logDebug(`WebSocket closed. Code: ${ev.code}, Reason: ${ev.reason || "none"}`);
      $("statusLine").textContent += " (connection closed)";
    });

    socket.addEventListener("error", ev => {
      logDebug("WebSocket error event fired");
      console.error("WebSocket error:", ev);
      $("errorBox").textContent = "Connection failed. Check console (F12) for details.";
      $("errorBox").classList.remove("d-none");
    });
  }

  // ──────────────────────────────────────────────
  // Auth events
  // ──────────────────────────────────────────────
  $("signOutBtn").addEventListener("click", signOut);

  document.addEventListener("DOMContentLoaded", () => {
    updateAuthUI();
  });
</script>
