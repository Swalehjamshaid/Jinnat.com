{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-7">
    <div class="card bg-body-tertiary">
      <div class="card-body">
        <h4 class="card-title">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL - no sign-in required.</p>
        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com">
          <button id="btnOpenAudit" class="btn btn-primary">Audit</button>
        </div>
        
        <div id="openResults" class="mt-3 d-none">
          <h6>Results</h6>
          <div class="row">
            <div class="col-md-4">
              <div class="p-3 rounded bg-dark-subtle text-center">
                <b>Overall Score</b>
                <div id="ovScore" class="display-6 font-monospace">-</div>
                <div id="ovGrade" class="badge bg-success mt-2"></div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="p-2 border rounded">
                <canvas id="breakdownChart" height="120"></canvas>
              </div>
            </div>
          </div>
          <pre id="openJson" class="small mt-3 bg-dark p-2 text-info rounded overflow-auto" style="max-height: 200px;"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card bg-body-tertiary">
      <div class="card-body">
        <h4 class="card-title">Passwordless Sign-in</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-2">Free users can run up to 10 audits; subscribe to unlock scheduling & history.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInstance = null;

  document.getElementById('btnOpenAudit').onclick = async function() {
    const urlInput = document.getElementById('openUrl').value;
    const btn = this;
    const resultsDiv = document.getElementById('openResults');

    if (!urlInput) {
      alert("Please enter a valid URL");
      return;
    }

    // 1. Visual loading state
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Auditing...';
    btn.disabled = true;
    resultsDiv.classList.add('d-none');

    try {
      // 2. Fetch data from Python (api_router)
      const response = await fetch('/api/open-audit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: urlInput })
      });

      if (!response.ok) throw new Error('Audit failed');

      const data = await response.json();

      // 3. Update HTML with Python data
      resultsDiv.classList.remove('d-none');
      document.getElementById('ovScore').innerText = data.overall_score;
      document.getElementById('ovGrade').innerText = data.grade || '';
      document.getElementById('openJson').innerText = JSON.stringify(data, null, 2);

      // 4. Render Chart
      renderChart(data);

    } catch (err) {
      alert("Error: " + err.message);
    } finally {
      btn.innerHTML = 'Audit';
      btn.disabled = false;
    }
  };

  function renderChart(data) {
    const ctx = document.getElementById('breakdownChart').getContext('2d');
    
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Performance', 'On-Page', 'Coverage'],
        datasets: [{
          label: 'Scores',
          data: [data.performance || 0, data.onpage || 0, data.coverage || 0],
          backgroundColor: ['#0d6efd', '#198754', '#ffc107']
        }]
      },
      options: {
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { min: 0, max: 100 } }
      }
    });
  }
</script>
{% endblock %}
