<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ──────────────────────────────────────────────
// Audit logic – WebSocket version
// ──────────────────────────────────────────────

let charts = {};
let currentWs = null;

function updateProgress(pct, msg) {
  console.log(`Progress: ${pct}% - ${msg}`);
  const bar = document.getElementById('crawlProgressBar');
  const label = document.getElementById('progressLabel');
  const status = document.getElementById('statusLabel');
  const overlay = document.getElementById('overlayStatus');

  if (bar) bar.style.width = pct + '%';
  if (label) label.textContent = pct + '%';
  if (status) status.textContent = msg;
  if (overlay) overlay.textContent = msg;
}

function showError(msg = "Audit failed – please try again") {
  console.error("Audit error:", msg);
  document.getElementById('loadingOverlay').style.display = 'none';
  document.getElementById('crawlProgressContainer').style.display = 'none';
  document.getElementById('btnOpenAudit').disabled = false;

  const results = document.getElementById('openResults');
  results.innerHTML = `
    <div class="alert alert-danger text-center p-5 rounded-4">
      <h4 class="mb-3">Audit Error</h4>
      <p>${msg}</p>
      <button class="btn btn-outline-light mt-3 px-4" onclick="location.reload()">Retry</button>
    </div>`;
  results.classList.remove('d-none');
}

function initCharts(data) {
  console.log("Initializing charts with:", data.chart_data);
  const cd = data.chart_data || {};
  if (!cd.bar || !cd.radar || !cd.doughnut) {
    console.warn("Missing chart data");
    return;
  }

  Object.values(charts).forEach(c => c?.destroy());

  // Bar Chart
  charts.bar = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: cd.bar.labels,
      datasets: [{
        data: cd.bar.data,
        backgroundColor: cd.bar.colors,
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.08)' } },
        x: { grid: { display: false } }
      }
    }
  });

  // Radar Chart
  charts.radar = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: cd.radar.labels,
      datasets: [{
        data: cd.radar.data,
        backgroundColor: 'rgba(13,110,253,0.28)',
        borderColor: '#0d6efd',
        pointBackgroundColor: '#0d6efd',
        pointBorderColor: '#fff',
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: { stepSize: 25, backdropColor: 'transparent', color: '#aaa' },
          grid: { color: 'rgba(255,255,255,0.1)' },
          angleLines: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Doughnut Chart
  charts.doughnut = new Chart(document.getElementById('doughnutChart'), {
    type: 'doughnut',
    data: {
      labels: cd.doughnut.labels,
      datasets: [{
        data: cd.doughnut.data,
        backgroundColor: cd.doughnut.colors,
        borderWidth: 2,
        borderColor: 'rgba(10,10,15,0.9)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '68%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#ccc', font: { size: 13 }, padding: 20 }
        }
      }
    }
  });
}

function runAudit(url) {
  console.log("Starting audit for:", url);

  if (!url || !/^https?:\/\//i.test(url)) {
    alert("Please enter a valid URL starting with http:// or https://");
    return;
  }

  if (currentWs) {
    currentWs.close();
    currentWs = null;
  }

  document.getElementById('loadingOverlay').style.display = 'flex';
  document.getElementById('crawlProgressContainer').style.display = 'block';
  document.getElementById('openResults').classList.add('d-none');
  document.getElementById('btnOpenAudit').disabled = true;

  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`;
  const ws = new WebSocket(wsUrl);
  currentWs = ws;

  let receivedAnyMessage = false;

  ws.onopen = () => {
    console.log("WebSocket connection opened");
  };

  ws.onmessage = (event) => {
    receivedAnyMessage = true;
    console.log("WebSocket message:", event.data);

    let data;
    try {
      data = JSON.parse(event.data);
    } catch (err) {
      console.error("Invalid JSON from WS:", err, event.data);
      return;
    }

    if (!data.finished) {
      updateProgress(data.crawl_progress || 0, data.status || "Analyzing…");
      return;
    }

    ws.close();
    currentWs = null;

    if (data.error) {
      showError(data.error);
      return;
    }

    // Fill results
    document.getElementById('ovScore').textContent = data.overall_score ?? '—';
    document.getElementById('grade').textContent = data.grade || '—';
    const bd = data.breakdown || {};
    document.getElementById('onpageScore').textContent = bd.onpage ?? '—';
    document.getElementById('perfScore').textContent = bd.performance ?? '—';
    document.getElementById('coverageScore').textContent = bd.coverage ?? '—';
    document.getElementById('confidence').textContent = bd.confidence ? bd.confidence + '%' : '—';

    initCharts(data);

    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('crawlProgressContainer').style.display = 'none';
    document.getElementById('btnOpenAudit').disabled = false;
    document.getElementById('openResults').classList.remove('d-none');
  };

  ws.onerror = (err) => {
    console.error("WebSocket error:", err);
    ws.close();
    currentWs = null;
    if (!receivedAnyMessage) {
      showError("Could not connect to audit service. Server may be down.");
    } else {
      showError("Connection lost during audit.");
    }
  };

  ws.onclose = () => {
    console.log("WebSocket closed");
    currentWs = null;
  };
}

// Button & Enter key
document.getElementById('btnOpenAudit')?.addEventListener('click', () => {
  const url = document.getElementById('openUrl')?.value?.trim();
  if (url) runAudit(url);
});

document.getElementById('openUrl')?.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    document.getElementById('btnOpenAudit')?.click();
  }
});
</script>
