{% extends 'base.html' %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .scan-box { background: #0f172a; border-radius: 12px; padding: 30px; border: 1px solid #1e293b; }
    .bar-bg { background: #1e293b; border-radius: 4px; overflow: hidden; height: 10px; }
    .bar-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); width: 0%; transition: width 0.5s; }
    .cat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; }
</style>

<div class="container py-5">
    <div class="card bg-primary text-white p-5 rounded-4 border-0 mb-5">
        <h1 class="fw-bold">Global AI Audit SaaS</h1>
        <div class="input-group input-group-lg mt-4 shadow-sm">
            <input id="url" type="url" class="form-control" placeholder="https://domain.com">
            <button id="start" class="btn btn-dark px-5 fw-bold">START SCAN</button>
        </div>
    </div>

    <div id="scanner" class="d-none">
        <div class="scan-box mb-5 shadow-lg">
            <div class="d-flex justify-content-between text-white mb-2">
                <span id="stTxt">Initializing AI Crawler...</span>
                <span id="stPerc">0%</span>
            </div>
            <div class="bar-bg">
                <div id="bar" class="bar-fill"></div>
            </div>
        </div>
    </div>

    <div id="results" class="d-none">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card bg-dark text-white p-4 text-center rounded-4 h-100 border-0">
                    <div class="display-3 fw-bold" id="ovS">0%</div>
                    <div class="badge bg-primary fs-6 mt-2" id="ovG">GRADE -</div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row g-3" id="grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
const phases = [
    {p: 25, m: "> Crawling site architecture..."},
    {p: 50, m: "> Analyzing SEO & Meta data..."},
    {p: 75, m: "> Running Performance & Speed tests..."},
    {p: 100, m: "> Finalizing international report..."}
];

document.getElementById('start').onclick = async function() {
    const url = document.getElementById('url').value;
    if(!url) return;
    
    this.disabled = true;
    document.getElementById('scanner').classList.remove('d-none');
    document.getElementById('results').classList.add('d-none');
    
    let step = 0;
    const interval = setInterval(() => {
        if(step < phases.length) {
            document.getElementById('bar').style.width = phases[step].p + '%';
            document.getElementById('stPerc').innerText = phases[step].p + '%';
            document.getElementById('stTxt').innerText = phases[step].m;
            step++;
        }
    }, 1500);

    const res = await fetch('/api/open-audit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    });
    const data = await res.json();
    
    clearInterval(interval);
    document.getElementById('scanner').classList.add('d-none');
    document.getElementById('results').classList.remove('d-none');
    
    document.getElementById('ovS').innerText = data.overall_score + '%';
    document.getElementById('ovG').innerText = "GRADE " + data.grade;
    
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    Object.entries(data.categories).forEach(([name, info], i) => {
        const cid = `c-${i}`;
        grid.innerHTML += `
            <div class="col-md-6">
                <div class="cat-card h-100 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="small fw-bold text-uppercase text-secondary">${name}</span>
                        <span style="color:${info.color}" class="fw-bold">${info.score}%</span>
                    </div>
                    <div style="height:120px; position:relative;"><canvas id="${cid}"></canvas></div>
                    <div class="mt-3 small border-top pt-2">
                        ${Object.entries(info.metrics).slice(0,3).map(([k,v]) => `<div>${k}: ${v}</div>`).join('')}
                    </div>
                </div>
            </div>`;
        
        setTimeout(() => {
            new Chart(document.getElementById(cid), {
                type: 'doughnut',
                data: { datasets: [{ data: [info.score, 100-info.score], backgroundColor: [info.color, '#f1f5f9'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false } } }
            });
        }, 100);
    });
    this.disabled = false;
};
</script>
{% endblock %}
