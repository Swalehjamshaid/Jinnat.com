<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF Tech Website Audit Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  .tab-content { display: none; }
  .tab-active { display: block; }
  .progress-bar { transition: width 0.3s; }
</style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-4">Website Audit Dashboard</h1>

  <!-- URL input -->
  <div class="mb-4 flex gap-2">
    <input type="text" id="urlInput" placeholder="Enter website URL" class="flex-grow p-2 border rounded">
    <button id="auditBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Start Audit</button>
  </div>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-300 rounded h-4 mb-4">
    <div id="progressBar" class="bg-green-500 h-4 rounded progress-bar" style="width:0%"></div>
  </div>
  <div id="progressStatus" class="mb-4 text-gray-700">Idle...</div>

  <!-- Metric Cards -->
  <div id="metricCards" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4"></div>

  <!-- Key-Value Details -->
  <div id="kvContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 mb-4"></div>

  <!-- Tabs -->
  <div class="mb-4">
    <ul class="flex border-b">
      <li class="mr-2"><button class="tab-btn py-2 px-4 font-semibold border-b-2 border-blue-500" data-tab="seo">SEO</button></li>
      <li class="mr-2"><button class="tab-btn py-2 px-4 font-semibold border-b-2 border-transparent" data-tab="performance">Performance</button></li>
      <li class="mr-2"><button class="tab-btn py-2 px-4 font-semibold border-b-2 border-transparent" data-tab="links">Links</button></li>
      <li class="mr-2"><button class="tab-btn py-2 px-4 font-semibold border-b-2 border-transparent" data-tab="security">Security</button></li>
      <li><button class="tab-btn py-2 px-4 font-semibold border-b-2 border-transparent" data-tab="competitors">Competitors</button></li>
    </ul>

    <div id="tabContents" class="mt-4">
      <div id="seo" class="tab-content">
        <canvas id="seoChart"></canvas>
      </div>
      <div id="performance" class="tab-content">
        <canvas id="performanceChart"></canvas>
      </div>
      <div id="links" class="tab-content">
        <canvas id="linksChart"></canvas>
      </div>
      <div id="security" class="tab-content">
        <canvas id="securityChart"></canvas>
      </div>
      <div id="competitors" class="tab-content">
        <canvas id="competitorsChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Export Button -->
  <button id="exportPdfBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Export to PDF</button>
</div>

<script>
let ws;
const charts = {};

function initTabs() {
  const buttons = document.querySelectorAll(".tab-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("tab-active"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("border-blue-500"));
      document.getElementById(btn.dataset.tab).classList.add("tab-active");
      btn.classList.add("border-blue-500");
    });
  });
  buttons[0].click(); // Activate first tab by default
}

function updateProgress(progress, status) {
  document.getElementById("progressBar").style.width = progress + "%";
  document.getElementById("progressStatus").innerText = status;
}

function renderCards(cards) {
  const container = document.getElementById("metricCards");
  container.innerHTML = "";
  cards.forEach(c => {
    const div = document.createElement("div");
    div.className = "bg-white shadow p-4 rounded";
    div.innerHTML = `<h3 class="font-bold">${c.title}</h3><p class="text-xl">${c.body}</p>`;
    container.appendChild(div);
  });
}

function renderKV(kv) {
  const container = document.getElementById("kvContainer");
  container.innerHTML = "";
  kv.forEach(item => {
    const div = document.createElement("div");
    div.className = "bg-white shadow p-2 rounded";
    div.innerHTML = `<span class="font-semibold">${item.key}:</span> ${item.value}`;
    container.appendChild(div);
  });
}

function renderChart(id, data) {
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id + "Chart").getContext("2d");
  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: { responsive: true, plugins: { legend: { display: true } } }
  });
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Website Audit Report", 10, 10);
  let y = 20;
  document.querySelectorAll("#metricCards div").forEach(card => {
    doc.text(card.innerText, 10, y);
    y += 10;
  });
  // Capture charts as images
  Object.keys(charts).forEach(key => {
    const chartCanvas = document.getElementById(key + "Chart");
    const imgData = chartCanvas.toDataURL("image/png");
    doc.addPage();
    doc.addImage(imgData, "PNG", 10, 10, 180, 100);
  });
  doc.save("audit-report.pdf");
}

function connectWebSocket(url) {
  ws = new WebSocket(url);
  ws.onopen = () => console.log("WebSocket connected");
  ws.onmessage = evt => {
    const msg = JSON.parse(evt.data);
    if (msg.progress !== undefined) updateProgress(msg.progress, msg.status);
    if (msg.result) {
      renderCards(msg.result.dynamic.cards);
      renderKV(msg.result.dynamic.kv);

      const breakdown = msg.result.breakdown;
      Object.keys(breakdown).forEach(key => {
        if (breakdown[key].chart_data) renderChart(key, breakdown[key].chart_data);
      });
    }
  };
  ws.onclose = () => console.log("WebSocket closed");
}

document.getElementById("auditBtn").addEventListener("click", () => {
  const url = document.getElementById("urlInput").value;
  if (!url) return alert("Enter a URL");
  updateProgress(0, "Connecting...");
  connectWebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => ws.send(JSON.stringify({ url }));
});

document.getElementById("exportPdfBtn").addEventListener("click", exportPDF);

initTabs();
</script>

</body>
</html>
