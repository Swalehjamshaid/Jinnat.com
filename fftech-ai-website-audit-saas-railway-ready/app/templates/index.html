{% extends 'base.html' %}
{% block content %}

<style>
  body {
    background: radial-gradient(1200px 600px at 20% -10%, rgba(13, 110, 253, 0.08), transparent),
                radial-gradient(900px 500px at 90% 0%, rgba(32, 201, 151, 0.08), transparent);
    background-attachment: fixed;
  }
  .card-elevated {
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    backdrop-filter: blur(6px);
  }
  #loadingOverlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.60); z-index: 10; border-radius: 0.5rem;
    display: none; align-items: center; justify-content: center; flex-direction: column;
  }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: .5rem; }
  .status-warn { background-color: #ffc107; }
  .status-ok   { background-color: #20c997; }
  .status-err  { background-color: #dc3545; }
  .ls-widest { letter-spacing: .08em; }
  #crawlProgressBar { transition: width .3s ease; }
  .metric-chip { font-variant-numeric: tabular-nums; }
  .demo-links a { text-decoration: none; }
  .demo-links a:hover { text-decoration: underline; }
</style>

<div class="row gy-4">
  <!-- Audit Panel -->
  <div class="col-lg-7">
    <div class="card bg-body-tertiary card-elevated mb-4 position-relative" id="auditCard">

      <!-- Loading Overlay -->
      <div id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="text-center text-white px-3">
          <div class="spinner-border text-primary" style="width:3rem; height:3rem;" role="status" aria-label="Loading"></div>
          <div class="mt-3 fw-bold h5" id="overlayStatus">Initializing Audit…</div>
          <div class="small text-white-50" id="overlayHint">This may take a few seconds</div>
        </div>
      </div>

      <!-- Audit Input -->
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h4 class="card-title fw-bold mb-0">Open Access Audit</h4>
          <span class="text-secondary small"><span class="status-dot status-ok"></span>Status: Ready</span>
        </div>
        <p class="text-secondary mb-3">Quickly audit any URL — no sign-in required.</p>

        <div class="input-group mb-2">
          <span class="input-group-text bg-transparent"><i class="bi bi-globe2"></i></span>
          <input id="openUrl" type="url" inputmode="url" autocomplete="url"
                 class="form-control" placeholder="https://example.com" value="https://">
          <button id="btnOpenAudit" class="btn btn-primary px-4">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" aria-hidden="true"></span>
            <span id="btnText">Audit</span>
          </button>
        </div>

        <div class="demo-links small text-secondary mb-4">
          Try:&nbsp;
          <a href="#" class="me-2 demo-link" data-url="https://example.com">example.com</a>
          <a href="#" class="me-2 demo-link" data-url="https://www.wikipedia.org">wikipedia.org</a>
          <a href="#" class="demo-link" data-url="https://developer.mozilla.org">developer.mozilla.org</a>
        </div>

        <!-- Progress Bar -->
        <div id="crawlProgressContainer" class="mb-4" style="display:none;">
          <div class="d-flex justify-content-between mb-1">
            <span class="text-primary small fw-bold" id="statusLabel">Initializing…</span>
            <span id="progressLabel" class="text-secondary small">0%</span>
          </div>
          <div class="progress" style="height:12px; border-radius:10px;">
            <div id="crawlProgressBar"
                 class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                 role="progressbar" style="width:0%"></div>
          </div>
        </div>

        <!-- Audit Results -->
        <div id="openResults" class="mt-3 d-none">
          <h5 class="mb-3">Audit Results</h5>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="p-4 rounded bg-dark-subtle text-center h-100 border">
                <b class="text-uppercase small ls-widest text-secondary">Overall Score</b>
                <div id="ovScore" class="display-5 fw-bold text-primary mt-2 metric-chip">-</div>
                <div id="grade" class="h4 fw-bold mt-1">-</div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="p-2 border rounded h-100">
                <canvas id="breakdownChart" height="160"></canvas>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h6 class="fw-bold">Metric Details</h6>
            <div class="row g-2">
              <div class="col-6"><div class="p-2 border rounded small bg-light">SEO: <span id="onpageScore" class="fw-bold float-end metric-chip">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Speed: <span id="perfScore" class="fw-bold float-end metric-chip">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">Links: <span id="coverageScore" class="fw-bold float-end metric-chip">-</span></div></div>
              <div class="col-6"><div class="p-2 border rounded small bg-light">AI Confidence: <span id="confidence" class="fw-bold float-end metric-chip">-</span></div></div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <a id="downloadExcel" href="#" class="btn btn-sm btn-outline-primary">Download XLSX</a>
            <a id="downloadPPT" href="#" class="btn btn-sm btn-outline-success">Download PPTX</a>
          </div>

          <pre id="openJson" class="small mt-4 bg-dark text-info p-3 rounded d-none" style="max-height:220px; overflow:auto;"></pre>
        </div>

      </div>
    </div>
  </div>

  <!-- Sign-in Panel -->
  <div class="col-lg-5">
    <div class="card bg-body-tertiary card-elevated mb-4">
      <div class="card-body p-4">
        <h4 class="card-title fw-bold">Passwordless Sign‑in</h4>
        <form method="post" action="/request-login" novalidate>
          <div class="mb-3">
            <label class="form-label text-secondary small">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100 fw-bold">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-3">Free users can run up to 10 audits; subscribe to unlock scheduling &amp; history.</p>
      </div>
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div id="appToastBody" class="toast-body">Message</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let breakdownChartInstance = null;
let currentEventSource = null;

function toast(msg, variant='dark') {
  const el = document.getElementById('appToast');
  const body = document.getElementById('appToastBody');
  el.className = `toast align-items-center text-bg-${variant} border-0`;
  body.textContent = msg;
  new bootstrap.Toast(el, { delay: 4000 }).show();
}

function normalizeUrl(u) {
  if (!u) return "";
  const t = u.trim();
  return /^https?:\/\//i.test(t) ? t : "https://" + t.replace(/^\/+/, '');
}

function updateProgress(percent, msg="Auditing…") {
  percent = Math.max(0, Math.min(100, Number(percent) || 0));
  document.getElementById('crawlProgressBar').style.width = percent + '%';
  document.getElementById('progressLabel').textContent = percent + '%';
  document.getElementById('statusLabel').textContent = msg;
  document.getElementById('overlayStatus').textContent = msg;
}

function setOverlay(show, hintText) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = show ? 'flex' : 'none';
  if (hintText !== undefined) document.getElementById('overlayHint').textContent = hintText;
}

function resetUI() {
  document.getElementById('btnOpenAudit').disabled = false;
  document.getElementById('btnText').textContent = "Audit";
  document.getElementById('btnSpinner').classList.add("d-none");
  setOverlay(false);
  document.getElementById('crawlProgressContainer').style.display = "none";
}

// Run audit via SSE
function runAudit(url) {
  try { if (currentEventSource) currentEventSource.close(); } catch (_) {}
  resetUI();
  document.getElementById('btnOpenAudit').disabled = true;
  document.getElementById('btnText').textContent = "Processing…";
  document.getElementById('btnSpinner').classList.remove("d-none");
  setOverlay(true, "This may take a few seconds");
  document.getElementById('crawlProgressContainer').style.display = "block";
  document.getElementById('openResults').classList.add("d-none");

  const evtSource = new EventSource(`/api/open-audit-progress?url=${encodeURIComponent(url)}`);
  currentEventSource = evtSource;

  evtSource.onmessage = (e) => {
    let data;
    try { data = JSON.parse(e.data || "{}"); } catch { data = {}; }
    if (!data.finished) {
      updateProgress(Number(data.crawl_progress ?? 0), "Auditing…");
      return;
    }
    evtSource.close();

    document.getElementById('openResults').classList.remove("d-none");
    const breakdown = data.breakdown || {};
    document.getElementById('ovScore').textContent = data.overall_score ?? "-";
    document.getElementById('grade').textContent   = data.grade ?? "-";
    document.getElementById('onpageScore').textContent = breakdown.seo ?? "-";
    document.getElementById('perfScore').textContent   = breakdown.performance ?? "-";
    document.getElementById('coverageScore').textContent= breakdown.links ?? "-";
    const conf = breakdown.confidence ?? "-";
    document.getElementById('confidence').textContent = (typeof conf==='number'? conf+"%" : conf);

    // Render chart safely
    const chartData = [
      Number(breakdown.seo ?? 0),
      Number(breakdown.performance ?? 0),
      Number(breakdown.links ?? 0),
      Number(breakdown.confidence ?? 0)
    ];
    const ctx = document.getElementById('breakdownChart').getContext('2d');
    if (breakdownChartInstance) breakdownChartInstance.destroy();
    breakdownChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['SEO','Speed','Links','AI Confidence'],
        datasets:[{data:chartData,backgroundColor:["#0d6efd","#20c997","#ffc107","#dc3545"],borderRadius:6}]
      },
      options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}
    });

    document.getElementById('downloadExcel').href = data.excel_path ?? "#";
    document.getElementById('downloadPPT').href   = data.pptx_path ?? "#";

    resetUI();
    toast("Audit completed!", "success");
  };

  evtSource.onerror = (err) => {
    try { evtSource.close(); } catch (_) {}
    resetUI();
    console.error("SSE error:", err);
    toast("Audit failed. Could not reach server.", "danger");
  };
}

document.getElementById('btnOpenAudit').addEventListener('click', () => {
  const url = normalizeUrl(document.getElementById('openUrl').value);
  if (!url) { toast("Enter a valid URL.", "warning"); return; }
  runAudit(url);
});

document.querySelectorAll('.demo-link').forEach(a => a.addEventListener('click', e => {
  e.preventDefault();
  const url = normalizeUrl(a.getAttribute('data-url'));
  if (url) runAudit(url);
}));

</script>

{% endblock %}
