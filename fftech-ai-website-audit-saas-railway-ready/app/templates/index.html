{% extends 'base.html' %}
{% block content %}
<style>
  /* Professional UI Improvements */
  .scan-container { background: #0f172a; border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid #1e293b; }
  .prog-track { height: 12px; background: #1e293b; border-radius: 6px; overflow: hidden; }
  .prog-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.4s ease; }
  .scan-log { color: #10b981; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; margin-top: 10px; }

  .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 25px; }
  .cat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 15px; padding: 20px; text-align: center; transition: transform 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
  .cat-card:hover { transform: translateY(-5px); }
  
  .donut-box { position: relative; height: 110px; width: 110px; margin: 0 auto 12px; }
  .donut-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 800; font-size: 1.2rem; }
  
  #ovScore { font-size: 3.5rem; font-weight: 900; color: #0f172a; }
  .grade-badge { font-size: 1rem; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-top: 5px; display: inline-block; }
</style>

<div class="row">
  <div class="col-lg-7">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <h4 class="fw-bold">Open Access Audit</h4>
        <p class="text-secondary">Analyze 200+ international metrics instantly.</p>
        
        <div class="input-group mb-4">
          <input id="openUrl" type="url" class="form-control form-control-lg" placeholder="https://example.com">
          <button id="btnOpenAudit" class="btn btn-primary px-4 fw-bold">Start Audit</button>
        </div>

        <div id="scanningSection" class="d-none">
          <div class="scan-container">
            <div class="d-flex justify-content-between text-white mb-2 small fw-bold">
              <span id="scanStatus">Initializing AI Engine...</span>
              <span id="scanPercent">0%</span>
            </div>
            <div class="prog-track"><div id="scanFill" class="prog-fill"></div></div>
            <div id="scanLog" class="scan-log">> Establishing secure connection...</div>
          </div>
        </div>

        <div id="openResults" class="mt-3 d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Audit Report</h5>
            <button id="btnDownloadPdf" class="btn btn-outline-danger btn-sm fw-bold">
              <i class="fas fa-file-pdf"></i> Download Certified PDF
            </button>
          </div>

          <div class="row mb-4 g-3">
            <div class="col-md-5">
              <div class="p-4 rounded-4 bg-light text-center border">
                <small class="text-uppercase fw-bold text-secondary">Global Health Score</small>
                <div id="ovScore">-</div>
                <div id="ovGrade" class="grade-badge bg-primary text-white">GRADE -</div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="p-3 border rounded-4 h-100 bg-white">
                <canvas id="breakdownChart" height="160"></canvas>
              </div>
            </div>
          </div>

          <div id="categoryContainer" class="category-grid"></div>
          <pre id="openJson" class="small mt-3 d-none"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card border-0 shadow-sm bg-dark text-white p-2">
      <div class="card-body">
        <h4 class="fw-bold">Professional Access</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label small text-secondary fw-bold">Work Email</label>
            <input type="email" name="email" class="form-control bg-secondary text-white border-0" required>
          </div>
          <button class="btn btn-success w-100 fw-bold py-2">Get Magic Link</button>
        </form>
        <p class="small text-secondary mt-3">Verified users get priority crawling, history, and full competitor heatmaps.</p>
      </div>
    </div>
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInstance = null;
  const statusSteps = [
    { p: 20, m: "> Crawling site architecture (Metrics 21-40)..." },
    { p: 40, m: "> Analyzing SEO & Content (Metrics 41-75)..." },
    { p: 65, m: "> Running Performance & Core Web Vitals (Metrics 76-150)..." },
    { p: 85, m: "> Comparing Competitor Benchmarks (Metrics 151-180)..." },
    { p: 100, m: "> Finalizing International Standard Report..." }
  ];

  document.getElementById('btnOpenAudit').onclick = async function() {
    const urlInput = document.getElementById('openUrl').value;
    const btn = this;
    const resultsDiv = document.getElementById('openResults');
    const scanDiv = document.getElementById('scanningSection');

    if (!urlInput) { alert("Please enter a valid URL"); return; }

    btn.disabled = true;
    scanDiv.classList.remove('d-none');
    resultsDiv.classList.add('d-none');

    let step = 0;
    const progressInt = setInterval(() => {
      if(step < statusSteps.length) {
        document.getElementById('scanFill').style.width = statusSteps[step].p + '%';
        document.getElementById('scanPercent').innerText = statusSteps[step].p + '%';
        document.getElementById('scanStatus').innerText = statusSteps[step].m;
        step++;
      }
    }, 1500);

    try {
      const response = await fetch('/api/open-audit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: urlInput })
      });
      const data = await response.json();

      clearInterval(progressInt);
      scanDiv.classList.add('d-none');
      resultsDiv.classList.remove('d-none');

      // Update Health Score and Grade
      document.getElementById('ovScore').innerText = Math.round(data.overall_score) + '%';
      document.getElementById('ovGrade').innerText = "GRADE " + (data.grade || 'B');
      
      // Metric 10: PDF Trigger
      document.getElementById('btnDownloadPdf').onclick = () => {
        window.location.href = `/api/download-full-audit?url=${encodeURIComponent(urlInput)}`;
      };

      renderMainChart(data);
      renderCategoryCharts(data.categories);

    } catch (err) {
      alert("Audit Failed. Please check the URL and try again.");
      clearInterval(progressInt);
      scanDiv.classList.add('d-none');
    } finally {
      btn.disabled = false;
    }
  };

  function renderMainChart(data) {
    const ctx = document.getElementById('breakdownChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    
    // Safely extract scores for the bar chart
    const seoScore = data.categories?.['D. On-Page SEO']?.score || 0;
    const perfScore = data.categories?.['E. Performance']?.score || 0;
    const linkScore = data.categories?.['H. Broken Links Intelligence']?.score || 100;

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Performance', 'SEO', 'Links'],
        datasets: [{
          data: [perfScore, seoScore, linkScore],
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
          borderRadius: 8
        }]
      },
      options: { 
        indexAxis: 'y', 
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { max: 100, display: false }, y: { grid: { display: false } } }
      }
    });
  }

  function renderCategoryCharts(categories) {
    const container = document.getElementById('categoryContainer');
    container.innerHTML = '';
    
    Object.entries(categories).forEach(([name, info], i) => {
      const id = `catChart-${i}`;
      container.innerHTML += `
        <div class="cat-card">
          <div class="donut-box">
            <canvas id="${id}"></canvas>
            <div class="donut-val" style="color:${info.color}">${Math.round(info.score)}%</div>
          </div>
          <div class="small fw-bold text-uppercase text-muted">${name.split('. ')[1] || name}</div>
        </div>
      `;

      setTimeout(() => {
        new Chart(document.getElementById(id), {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [info.score, 100 - info.score],
              backgroundColor: [info.color, '#f1f5f9'],
              borderWidth: 0
            }]
          },
          options: { cutout: '80%', plugins: { legend: { display: false } }, events: [] }
        });
      }, 50);
    });
  }
</script>
{% endblock %}
