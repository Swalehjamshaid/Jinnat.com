<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website Audit Pro</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.12);
      --shadow: 0 12px 35px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 30% 20%, rgba(14,165,233,0.25), transparent 55%),
        radial-gradient(900px 500px at 70% 10%, rgba(34,197,94,0.18), transparent 50%),
        radial-gradient(800px 500px at 60% 80%, rgba(239,68,68,0.12), transparent 50%),
        linear-gradient(180deg, rgba(2,6,23,1) 0%, rgba(3,7,18,1) 100%);
    }

    .app-shell { max-width: 1200px; margin: 0 auto; padding: 22px 16px 60px; }

    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand-badge {
      width: 46px; height: 46px; border-radius: 14px;
      display: grid; place-items: center;
      font-weight: 800; letter-spacing: 0.5px;
      background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(99,102,241,0.85));
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 12px 30px rgba(14,165,233,0.22);
    }

    .subtle { color: rgba(255,255,255,0.70); }
    .muted-2 { color: rgba(255,255,255,0.65); }

    .pill {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.78);
    }

    .score-ring {
      width: 180px; height: 180px; border-radius: 999px;
      position: relative; display: grid; place-items: center;
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 35%, transparent 60%),
        conic-gradient(from 180deg, rgba(14,165,233,0.95) var(--deg), rgba(255,255,255,0.08) 0);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .score-ring .inside {
      width: 132px; height: 132px; border-radius: 999px;
      background: rgba(2,6,23,0.75);
      border: 1px solid rgba(255,255,255,0.12);
      display: grid; place-items: center; text-align: center; padding: 10px;
    }
    .score-ring .inside .score { font-size: 40px; font-weight: 900; line-height: 1; }
    .score-ring .inside .grade { font-weight: 800; margin-top: 4px; opacity: 0.9; }

    .btn-glow {
      background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(99,102,241,0.9));
      border: none;
      box-shadow: 0 18px 40px rgba(14,165,233,0.22);
    }
    .btn-glow:hover { filter: brightness(1.05); }

    .mini-card {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      padding: 14px 14px;
      height: 100%;
    }
    .mini-card .label { font-size: 12px; opacity: 0.8; }
    .mini-card .value { font-size: 34px; font-weight: 850; line-height: 1.1; }
    .mini-card .hint  { font-size: 12px; opacity: 0.72; margin-top: 8px; }

    .kv-table td, .kv-table th { border-color: rgba(255,255,255,0.10) !important; }
    .progress { height: 10px; }
    .progress-bar { transition: width .25s ease; }

    .fade-in { animation: fadeIn .35s ease both; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-badge text-white">FF</div>
        <div>
          <div class="h4 mb-0 fw-bold">Website Audit Pro</div>
          <div class="subtle small">Live WebSocket progress + REST audit result ‚Ä¢ Railway Ready</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span id="wsStatus" class="pill">WS: Disconnected</span>
        <button class="btn btn-sm btn-outline-secondary" id="themeToggle" type="button">üåô / ‚òÄÔ∏è</button>
      </div>
    </div>

    <!-- Input -->
    <div class="glass p-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-7">
          <label class="form-label fw-semibold">Website URL</label>
          <input id="urlInput" type="text" class="form-control form-control-lg"
                 placeholder="example.com or https://example.com"
                 value="https://www.haier.com.pk/#/login" />
          <div class="small muted-2 mt-1">Tip: Just paste domain ‚Äî system will auto-normalize.</div>
        </div>

        <div class="col-lg-5">
          <div class="d-grid gap-2 d-lg-flex justify-content-lg-end">
            <button id="startBtn" class="btn btn-lg btn-glow text-white fw-semibold" type="button">
              ‚ñ∂ Start Audit
            </button>
            <button id="pdfBtn" class="btn btn-lg btn-outline-info fw-semibold" type="button" disabled>
              ‚¨á Download Professional PDF Report
            </button>
          </div>
        </div>
      </div>

      <hr class="my-4 border-0" style="border-top:1px solid rgba(255,255,255,0.12)">

      <!-- Progress -->
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">Progress</div>
        <div class="subtle"><span id="progressText">0%</span> ‚Ä¢ <span id="statusText">idle</span></div>
      </div>
      <div class="progress glass" style="border-radius:999px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>

      <!-- Alerts -->
      <div id="alertArea" class="mt-3"></div>
    </div>

    <!-- Results Summary -->
    <div id="resultsArea" class="row g-3 mb-4" style="display:none;">
      <div class="col-lg-4">
        <div class="glass p-4 h-100 text-center">
          <div class="score-ring mx-auto" id="scoreRing" style="--deg: 0deg;">
            <div class="inside">
              <div class="score" id="overallScore">0</div>
              <div class="grade" id="gradeText">F</div>
              <div class="small muted-2 mt-1" id="auditedUrl">Audited: -</div>
            </div>
          </div>
          <div class="mt-3 subtle">Overall score is computed from category scores.</div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="glass p-4 h-100">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="h5 mb-0 fw-bold">Score Breakdown</div>
              <div class="subtle small">SEO ‚Ä¢ Performance ‚Ä¢ Links ‚Ä¢ Security</div>
            </div>
            <span class="pill" id="lastRunAt">‚Äî</span>
          </div>
          <canvas id="breakdownChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Category Cards -->
    <div id="cardsArea" class="row g-3 mb-4" style="display:none;">
      <div class="col-md-6 col-lg-3">
        <div class="mini-card">
          <div class="label">SEO</div>
          <div class="value" id="seoScore">0</div>
          <div class="hint">Title, meta desc, H1, canonical, ALT</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="mini-card">
          <div class="label">Performance</div>
          <div class="value" id="perfScore">0</div>
          <div class="hint">Load time, size, scripts, styles</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="mini-card">
          <div class="label">Links</div>
          <div class="value" id="linksScore">0</div>
          <div class="hint">Internal vs external structure</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="mini-card">
          <div class="label">Security</div>
          <div class="value" id="secScore">0</div>
          <div class="hint">HTTPS, HSTS, response status</div>
        </div>
      </div>
    </div>

    <!-- Dynamic Output -->
    <div id="dynamicArea" class="row g-3" style="display:none;">
      <div class="col-lg-6">
        <div class="glass p-4 h-100">
          <div class="h5 fw-bold mb-3">Highlights</div>
          <div id="dynamicCards" class="d-grid gap-2"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="glass p-4 h-100">
          <div class="h5 fw-bold mb-3">Details</div>
          <div class="table-responsive">
            <table class="table table-sm kv-table align-middle mb-0">
              <tbody id="kvBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5 subtle small">
      ¬© FF Tech ‚Ä¢ Progress via <code>/ws</code> ‚Ä¢ Audit via <code>POST /api/audit/run</code>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    let ws = null;
    let lastResult = null;
    let chart = null;

    const el = (id) => document.getElementById(id);

    // -----------------------------
    // Theme toggle
    // -----------------------------
    const themeKey = "fftech_theme";
    function setTheme(theme) {
      document.documentElement.setAttribute("data-bs-theme", theme);
      localStorage.setItem(themeKey, theme);
    }
    (function initTheme() {
      const saved = localStorage.getItem(themeKey);
      if (saved) setTheme(saved);
    })();
    el("themeToggle").addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-bs-theme") || "dark";
      setTheme(current === "dark" ? "light" : "dark");
    });

    // -----------------------------
    // Alerts
    // -----------------------------
    function showAlert(message, type="info", persist=false) {
      const area = el("alertArea");
      const div = document.createElement("div");
      div.className = `alert alert-${type} ${persist ? "" : "fade-in"} mb-2`;
      div.innerHTML = `
        <div class="d-flex align-items-start justify-content-between gap-3">
          <div>${message}</div>
          <button type="button" class="btn-close" aria-label="Close"></button>
        </div>
      `;
      div.querySelector(".btn-close").onclick = () => div.remove();
      area.prepend(div);
      if (!persist) setTimeout(() => { try { div.remove(); } catch(e) {} }, 6500);
    }

    // -----------------------------
    // Progress
    // -----------------------------
    function setProgress(percent, status) {
      const p = Math.max(0, Math.min(100, parseInt(percent || 0)));
      el("progressBar").style.width = `${p}%`;
      el("progressText").textContent = `${p}%`;
      el("statusText").textContent = status || "working";
      el("progressBar").className = "progress-bar";
      el("progressBar").classList.add(p < 100 ? "bg-info" : "bg-success");
    }

    // -----------------------------
    // WebSocket helpers
    // -----------------------------
    function wsUrl() {
      const loc = window.location;
      const proto = loc.protocol === "https:" ? "wss:" : "ws:";
      return `${proto}//${loc.host}/ws`;
    }
    function setWsStatus(connected) {
      el("wsStatus").textContent = connected ? "WS: Connected" : "WS: Disconnected";
      el("wsStatus").style.opacity = connected ? "1" : "0.75";
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    // -----------------------------
    // WS message handler: matches YOUR backend broadcast shape
    // {type:"progress", message:"...", percent: 10, payload: {...}}
    // -----------------------------
    function handleWsMessage(msg) {
      if (!msg || typeof msg !== "object") return;

      if (msg.type === "progress") {
        setProgress(msg.percent ?? 0, msg.message ?? "working");

        // Sometimes runner sends final result inside payload at status "completed"
        if (msg.payload && msg.payload.audited_url) {
          renderResult(msg.payload);
          showAlert("Audit completed ‚úÖ", "success");
        }

        // If runner sends an error payload
        if (msg.payload && msg.payload.error) {
          showAlert(`Audit failed: <b>${escapeHtml(msg.payload.error)}</b>`, "danger", true);
        }
      }
    }

    function ensureWsConnected() {
      // Keep a single WS connection
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;

      ws = new WebSocket(wsUrl());
      ws.onopen = () => setWsStatus(true);
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleWsMessage(msg);
        } catch (e) {
          console.error("WS parse error", e);
        }
      };
      ws.onclose = () => setWsStatus(false);
      ws.onerror = () => setWsStatus(false);
    }

    // -----------------------------
    // Start Audit:
    // 1) connect WS for progress
    // 2) call REST /api/audit/run to run audit and get final result
    // -----------------------------
    async function startAudit() {
      const url = el("urlInput").value.trim();
      if (!url) {
        showAlert("Please enter a URL.", "warning");
        return;
      }

      // Reset UI
      lastResult = null;
      el("pdfBtn").disabled = true;
      el("resultsArea").style.display = "none";
      el("cardsArea").style.display = "none";
      el("dynamicArea").style.display = "none";

      setProgress(1, "starting");
      showAlert("Audit started‚Ä¶ Please wait.", "info");

      // Connect to WS (for progress)
      ensureWsConnected();

      // Trigger audit via REST (THIS is required by your backend)
      try {
        setProgress(5, "requesting");
        const res = await fetch("/api/audit/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }

        const j = await res.json();

        // Your backend returns: { ok: true, data: audit_result }
        const result = j.data || j.result || j.payload || j;

        if (result && result.audited_url) {
          renderResult(result);
          showAlert("Audit completed ‚úÖ", "success");
        } else {
          showAlert("Audit finished but result format was unexpected.", "warning", true);
          console.warn("Unexpected response:", j);
        }
      } catch (e) {
        console.error(e);
        showAlert(`Audit request failed: <b>${escapeHtml(e.message || String(e))}</b>`, "danger", true);
        setProgress(0, "error");
      }
    }

    // -----------------------------
    // Render result
    // -----------------------------
    function renderResult(result) {
      lastResult = result;

      el("resultsArea").style.display = "";
      el("cardsArea").style.display = "";
      el("dynamicArea").style.display = "";

      el("lastRunAt").textContent = new Date().toLocaleString();

      const score = parseInt(result.overall_score || 0);
      const deg = Math.max(0, Math.min(360, (score / 100) * 360));
      el("scoreRing").style.setProperty("--deg", `${deg}deg`);
      el("overallScore").textContent = score;
      el("gradeText").textContent = result.grade || "-";
      el("auditedUrl").textContent = `Audited: ${result.audited_url || "-"}`;

      const breakdown = result.breakdown || {};
      const seo = breakdown.seo?.score ?? 0;
      const perf = breakdown.performance?.score ?? 0;
      const links = breakdown.links?.score ?? 0;
      const sec = breakdown.security?.score ?? 0;

      el("seoScore").textContent = seo;
      el("perfScore").textContent = perf;
      el("linksScore").textContent = links;
      el("secScore").textContent = sec;

      const ctx = el("breakdownChart").getContext("2d");
      const data = {
        labels: ["SEO", "Performance", "Links", "Security"],
        datasets: [{
          label: "Score",
          data: [seo, perf, links, sec],
          backgroundColor: ["#fbbf24", "#38bdf8", "#22c55e", "#ef4444"],
          borderRadius: 12,
          borderSkipped: false
        }]
      };

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data,
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100, grid: { color: "rgba(255,255,255,0.10)" } },
            x: { grid: { display: false } }
          }
        }
      });

      const dyn = result.dynamic || {};
      const cards = dyn.cards || [];
      const kv = dyn.kv || [];

      const cardsWrap = el("dynamicCards");
      cardsWrap.innerHTML = "";
      for (const c of cards) {
        const div = document.createElement("div");
        div.className = "mini-card fade-in";
        div.innerHTML = `<div class="fw-semibold mb-1">${escapeHtml(c.title || "")}</div>
                         <div class="subtle">${escapeHtml(c.body || "")}</div>`;
        cardsWrap.appendChild(div);
      }

      const kvBody = el("kvBody");
      kvBody.innerHTML = "";
      for (const item of kv) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<th class="text-nowrap" style="width:40%">${escapeHtml(item.key || "")}</th>
                        <td>${escapeHtml(String(item.value ?? ""))}</td>`;
        kvBody.appendChild(tr);
      }

      el("pdfBtn").disabled = false;
      setProgress(100, "completed");
    }

    // -----------------------------
    // PDF: (You haven't implemented /api/audit/pdf in your main.py)
    // Keep button disabled or implement backend route later.
    // -----------------------------
    async function downloadPdf() {
      showAlert("PDF endpoint not implemented in current backend (main.py).", "warning", true);
    }

    el("startBtn").addEventListener("click", startAudit);
    el("pdfBtn").addEventListener("click", downloadPdf);

    // Connect WS once for progress updates
    ensureWsConnected();
  </script>
</body>
</html>
