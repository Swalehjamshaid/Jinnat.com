<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FF Tech Audit – Professional Website Auditor v4.2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --glass: rgba(17, 24, 39, 0.88);
      --border: rgba(255, 215, 0, 0.18);
      --gold: #ffd700;
      --gold-dark: #d4af37;
      --success: #10b981;
      --danger: #ef4444;
      --info: #3b82f6;
    }
    body {
      background: linear-gradient(135deg, var(--bg) 0%, var(--card) 100%);
      color: #e2e8f0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
    }
    .main-container { max-width: 1400px; margin: 0 auto; padding: 4rem 1.5rem; }
    .header-title {
      font-size: 3.8rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--gold), #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 3rem;
      text-align: center;
      letter-spacing: -1px;
    }
    .card-glass {
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(16px);
      border-radius: 1.6rem;
      padding: 2.8rem;
      box-shadow: 0 25px 60px rgba(0,0,0,0.45);
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(10,14,23,0.97);
      color: var(--gold);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }
    #loadingOverlay.show { display: flex; opacity: 1; }
    .metric-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,215,0,0.12);
      border-radius: 1.2rem;
      padding: 1.8rem 1.2rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    .metric-box:hover {
      border-color: var(--gold);
      transform: translateY(-6px);
      box-shadow: 0 15px 35px rgba(255,215,0,0.1);
    }
    .metric-value { font-size: 2.8rem; font-weight: 800; color: var(--gold); line-height: 1; }
    .metric-label { font-size: 0.95rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.2px; margin-top: 0.4rem; }
    .chart-container {
      background: rgba(255,255,255,0.025);
      border-radius: 1.2rem;
      padding: 1.8rem;
      margin-bottom: 2.2rem;
      border: 1px solid rgba(255,215,0,0.08);
    }
    .btn-gold {
      background: linear-gradient(90deg, var(--gold), var(--gold-dark));
      border: none;
      color: #000;
      font-weight: 700;
      padding: 0.8rem 2.5rem;
    }
    .btn-gold:hover { opacity: 0.92; transform: scale(1.03); }
    .toast-container { position: fixed; top: 25px; right: 25px; z-index: 10000; }
    .badge-soft {
      background: rgba(255,215,0,0.14);
      border: 1px solid rgba(255,215,0,0.28);
      color: var(--gold);
      font-weight: 500;
    }
    .links-info { font-size: 0.95rem; }
    .links-info strong { font-weight: 600; }
    footer { margin-top: 5rem; text-align: center; color: #6b7280; font-size: 0.9rem; }
  </style>
</head>
<body>
<div id="loadingOverlay">
  <div class="spinner-border text-warning mb-5" style="width:5rem;height:5rem;"></div>
  <h3 id="statusLabel" class="mb-4">Initializing Audit Engine...</h3>
  <div class="w-50 mt-3">
    <div class="progress" style="height:12px; border-radius:6px; background:rgba(255,255,255,0.08);">
      <div id="loadingBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width:5%"></div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastArea"></div>

<div class="main-container">
  <h1 class="header-title">FF Tech Audit Engine <span style="font-weight:300; opacity:0.9;">v4.2</span></h1>

  <div class="row g-4">
    <!-- Left Panel – Main Audit Area -->
    <div class="col-lg-8">
      <div class="card-glass" id="printableArea">
        <div class="input-group input-group-lg mb-4 no-print">
          <span class="input-group-text bg-dark border-secondary text-warning"><i class="bi bi-globe2"></i></span>
          <input id="urlInput" type="url" class="form-control bg-dark text-white border-secondary" placeholder="https://www.example.com" autofocus>
          <button id="btnRun" class="btn btn-gold px-5">START AUDIT</button>
        </div>

        <div class="no-print mb-4 text-center">
          <span class="badge badge-soft rounded-pill px-4 py-2" id="envHint">
            Tip: Set PSI_API_KEY in server env for real Core Web Vitals (LCP & CLS)
          </span>
        </div>

        <div id="resultsPanel" class="d-none">
          <div class="text-center mb-5">
            <div class="d-inline-block p-5 rounded-circle border border-3 border-warning mb-4 shadow">
              <h2 id="ovScore" class="display-1 fw-extrabold mb-0" style="color: var(--gold);">—</h2>
            </div>
            <h3 id="gradeDisplay" class="fw-bold text-warning mb-2">GRADE: —</h3>
            <p class="text-muted fs-5">Comprehensive AI-Driven Website Analysis Report</p>
            <button id="btnDownload" class="btn btn-outline-warning mt-3 no-print">
              <i class="bi bi-file-earmark-arrow-down me-2"></i>Download PDF Report
            </button>
          </div>

          <div class="row g-4 mb-5">
            <div class="col-md-3"><div class="metric-box"><div class="metric-label">On-Page SEO</div><div id="onpageScore" class="metric-value">—</div></div></div>
            <div class="col-md-3"><div class="metric-box position-relative">
              <div class="metric-label">Performance (LCP)</div>
              <div id="perfScore" class="metric-value">—</div>
              <small id="clsHint" class="position-absolute bottom-0 start-50 translate-middle-x text-muted" style="font-size:0.75rem;"></small>
            </div></div>
            <div class="col-md-3"><div class="metric-box"><div class="metric-label">Competitors</div><div id="coverageScore" class="metric-value">—</div></div></div>
            <div class="col-md-3"><div class="metric-box"><div class="metric-label">AI Confidence</div><div id="confScore" class="metric-value">90</div></div></div>
          </div>

          <div class="row">
            <div class="col-md-7">
              <div class="chart-container">
                <canvas id="mainChart" height="280"></canvas>
              </div>
            </div>
            <div class="col-md-5">
              <div class="chart-container">
                <canvas id="radarChart" height="280"></canvas>
              </div>
              <div class="mt-4 p-4 bg-dark rounded border border-secondary links-info">
                <div class="d-flex justify-content-between mb-3">
                  <span>Internal Links:</span> <strong id="intCount" class="text-success">—</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span>External Links:</span> <strong id="extCount" class="text-info">—</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Broken Internal Links:</span> <strong id="brkCount" class="text-danger">—</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel – Account / Info -->
    <div class="col-lg-4">
      <div class="card-glass h-100 d-flex flex-column">
        <h4 class="text-warning mb-4"><i class="bi bi-shield-lock-fill me-2"></i>Account Access</h4>
        <div class="mb-4">
          <label class="small text-muted mb-2">Email Address</label>
          <input type="email" class="form-control bg-dark text-white border-secondary mb-3" placeholder="user@company.com">
          <button class="btn btn-outline-warning w-100">Send Magic Link</button>
        </div>
        <hr class="border-secondary my-4">
        <p class="small text-muted mt-auto">
          FF Tech Engine v4.2 • 128-bit encryption for secure report storage<br>
          AI-driven heuristics & real-time competitor benchmarking
        </p>
      </div>
    </div>
  </div>

  <footer>
    © 2026 FF Tech International • Audit Engine v4.2 • Generated on <span id="currentDate"></span>
  </footer>
</div>

<script>
// Helpers
function showToast(message, type = 'warning') {
  const id = 't' + Date.now();
  const bg = type === 'error' ? 'bg-danger' : (type === 'success' ? 'bg-success' : 'bg-warning text-dark');
  const el = document.createElement('div');
  el.className = `toast align-items-center ${bg} border-0 show mb-3 shadow`;
  el.id = id;
  el.innerHTML = `
    <div class="d-flex">
      <div class="toast-body fw-medium">${message}</div>
      <button type="button" class="btn-close btn-close-white me-3 m-auto" onclick="document.getElementById('${id}').remove()"></button>
    </div>`;
  document.getElementById('toastArea').appendChild(el);
  bootstrap.Toast.getOrCreateInstance(el).show();
  setTimeout(() => el.remove(), 7000);
}

function formatPerf(lcpMs) {
  const n = Number(lcpMs || 0);
  if (n === 0) return '—';
  if (n >= 1000) return (n/1000).toFixed(1) + ' s';
  return Math.round(n) + ' ms';
}

function updateDate() {
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-PK', {
    year: 'numeric', month: 'long', day: 'numeric'
  });
}

// Charts
let charts = {};
function initCharts(data) {
  const barData = data?.chart_data?.bar || { labels: ["SEO","Links","Perf","AI"], data: [0,0,0,90] };
  const radarData = data?.chart_data?.radar || { labels: ["SEO","Links","Perf","AI"], data: [0,0,0,90] };

  if (charts.bar) charts.bar.destroy();
  charts.bar = new Chart(document.getElementById('mainChart'), {
    type: 'bar',
    data: {
      labels: barData.labels,
      datasets: [{
        label: 'Score',
        data: barData.data,
        backgroundColor: ['#ffd700', '#3b82f6', '#10b981', '#ef4444'],
        borderWidth: 0,
        borderRadius: 6
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { max: 100, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.08)' } } }
    }
  });

  if (charts.radar) charts.radar.destroy();
  charts.radar = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: radarData.labels,
      datasets: [{
        label: 'Profile',
        data: radarData.data,
        borderColor: '#ffd700',
        backgroundColor: 'rgba(255,215,0,0.18)',
        pointBackgroundColor: '#ffd700',
        pointBorderColor: '#000',
        pointRadius: 5
      }]
    },
    options: {
      scales: { r: { max: 100, beginAtZero: true, ticks: { display: false }, grid: { color: 'rgba(255,215,0,0.15)' } } },
      plugins: { legend: { display: false } }
    }
  });
}

// Audit Logic
let ws = null;
let isRunning = false;

function startAudit() {
  const urlInput = document.getElementById('urlInput');
  let url = (urlInput.value || '').trim();
  if (!url) {
    showToast('Please enter a valid website URL', 'warning');
    urlInput.focus();
    return;
  }
  if (isRunning) return;

  isRunning = true;
  const btn = document.getElementById('btnRun');
  btn.disabled = true;
  btn.innerText = 'AUDITING...';

  const overlay = document.getElementById('loadingOverlay');
  const statusLabel = document.getElementById('statusLabel');
  const loadingBar = document.getElementById('loadingBar');

  overlay.classList.add('show');
  document.getElementById('resultsPanel').classList.add('d-none');
  statusLabel.innerText = 'Connecting to audit engine...';
  loadingBar.style.width = '5%';

  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsURL = `${protocol}//${window.location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`;

  try {
    ws = new WebSocket(wsURL);
  } catch (err) {
    showToast('Failed to connect: ' + err.message, 'error');
    resetUI();
    return;
  }

  ws.onopen = () => {
    statusLabel.innerText = 'Connected → Crawling pages...';
  };

  ws.onmessage = (event) => {
    let res;
    try { res = JSON.parse(event.data); } catch { return; }

    if (res.error) {
      showToast('Audit error: ' + res.error, 'error');
    }

    if (res.status) {
      statusLabel.innerText = res.status;
    }

    if (typeof res.crawl_progress === 'number') {
      const pct = Math.max(0, Math.min(100, Math.round(res.crawl_progress)));
      loadingBar.style.width = pct + '%';
    }

    if (res.finished) {
      overlay.classList.remove('show');
      document.getElementById('resultsPanel').classList.remove('d-none');

      const overall = Number(res.overall_score ?? 0);
      const grade = res.grade ?? '—';
      const bd = res.breakdown || {};
      const seo = Number(bd.seo ?? 0);
      const perf = bd.performance || {};
      const lcp = Number(perf.lcp_ms ?? 0);
      const cls = Number(perf.cls ?? 0);
      const comp = Number((bd.competitors || {}).top_competitor_score ?? 0);
      const links = bd.links || {};

      document.getElementById('ovScore').innerText = isFinite(overall) ? overall : '—';
      document.getElementById('gradeDisplay').innerText = `GRADE: ${grade}`;
      document.getElementById('onpageScore').innerText = isFinite(seo) ? seo : '—';
      document.getElementById('perfScore').innerText = formatPerf(lcp);
      document.getElementById('coverageScore').innerText = isFinite(comp) ? comp : '—';
      document.getElementById('confScore').innerText = (res.chart_data?.bar?.data?.[3] ?? 90);

      document.getElementById('intCount').innerText = Number(links.internal_links_count ?? 0);
      document.getElementById('extCount').innerText = Number(links.external_links_count ?? 0);
      document.getElementById('brkCount').innerText = Number(links.broken_internal_links ?? 0);

      // CLS hint
      const clsHintEl = document.getElementById('clsHint');
      if (cls > 0) {
        clsHintEl.innerText = `CLS: ${cls.toFixed(2)}`;
        clsHintEl.className = cls > 0.1 ? 'text-danger' : 'text-warning';
      } else {
        clsHintEl.innerText = '';
      }

      initCharts(res);

      if (lcp === 0) {
        document.getElementById('envHint').innerHTML = 'Performance (LCP/CLS) is fallback value. Set <code>PSI_API_KEY</code> in server env for accurate Core Web Vitals.';
      } else {
        document.getElementById('envHint').innerHTML = 'Core Web Vitals loaded via Google PageSpeed Insights ✓';
      }

      resetUI();
      showToast('Audit complete! Report ready.', 'success');
    }
  };

  ws.onerror = () => {
    showToast('Connection error. Please try again or check server status.', 'error');
    resetUI();
  };

  ws.onclose = () => {
    if (isRunning) {
      showToast('Audit session closed unexpectedly.', 'warning');
      resetUI();
    }
  };
}

function resetUI() {
  const btn = document.getElementById('btnRun');
  btn.disabled = false;
  btn.innerText = 'START AUDIT';
  isRunning = false;
  document.getElementById('loadingOverlay').classList.remove('show');
  try { ws?.close(); ws = null; } catch (_) {}
}

// Event listeners
document.getElementById('btnRun').addEventListener('click', startAudit);
document.getElementById('urlInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    startAudit();
  }
});

// PDF Download
document.getElementById('btnDownload').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const element = document.getElementById('printableArea');
  const noPrintEls = document.querySelectorAll('.no-print');
  noPrintEls.forEach(el => el.style.display = 'none');

  try {
    const canvas = await html2canvas(element, {
      scale: 2,
      backgroundColor: '#0a0e17',
      logging: false,
      useCORS: true
    });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height);
    const w = imgProps.width * ratio;
    const h = imgProps.height * ratio;

    pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    pdf.setFontSize(8);
    pdf.setTextColor(140);
    pdf.text(`Generated: ${new Date().toLocaleString('en-PK')} • FF Tech Audit v4.2`, 10, pdfHeight - 8);

    pdf.save(`Website-Audit-Report-${new Date().toISOString().slice(0,10)}.pdf`);
  } catch (err) {
    showToast('Failed to generate PDF: ' + err.message, 'error');
  } finally {
    noPrintEls.forEach(el => el.style.display = '');
  }
});

// Init
updateDate();
</script>
</body>
</html>
