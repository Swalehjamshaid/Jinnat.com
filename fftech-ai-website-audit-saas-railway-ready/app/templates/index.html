{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-7">
    <div class="card bg-body-tertiary mb-4">
      <div class="card-body">
        <h4 class="card-title">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL - no sign-in required.</p>
        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com">
          <button id="btnOpenAudit" class="btn btn-primary">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span id="btnText">Audit</span>
          </button>
        </div>
        <div id="openResults" class="mt-3 d-none">
          <h6>Results</h6>
          <div class="row">
            <div class="col-md-4">
              <div class="p-3 rounded bg-dark-subtle">
                <b>Overall Score</b>
                <div id="ovScore" class="fs-3">-</div>
                <div id="grade" class="fs-4 fw-bold">-</div>
              </div>
            </div>
            <div class="col-md-8">
              <canvas id="breakdownChart" height="140"></canvas>
            </div>
          </div>
          <div class="mt-3">
            <h6>Details</h6>
            <ul class="list-group">
              <li class="list-group-item">On-page SEO: <span id="onpageScore">-</span></li>
              <li class="list-group-item">Performance: <span id="perfScore">-</span></li>
              <li class="list-group-item">Coverage: <span id="coverageScore">-</span></li>
              <li class="list-group-item">Confidence: <span id="confidence">-</span></li>
            </ul>
          </div>
          <pre id="openJson" class="small mt-3 bg-light p-2 rounded d-none"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card bg-body-tertiary mb-4">
      <div class="card-body">
        <h4 class="card-title">Passwordless Sign-in</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-2">
          Free users can run up to 10 audits; subscribe to unlock scheduling & history.
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Persistent variable to track the chart across multiple runs
let breakdownChartInstance = null;

async function runAudit(url) {
    const resultsDiv = document.getElementById('openResults');
    const btn = document.getElementById('btnOpenAudit');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');

    const ovScore = document.getElementById('ovScore');
    const gradeEl = document.getElementById('grade');
    const onpageEl = document.getElementById('onpageScore');
    const perfEl = document.getElementById('perfScore');
    const coverageEl = document.getElementById('coverageScore');
    const confEl = document.getElementById('confidence');
    const jsonPre = document.getElementById('openJson');

    // 1. Loading State: Reset UI and show spinner
    btn.disabled = true;
    btnText.textContent = 'Auditing...';
    btnSpinner.classList.remove('d-none');
    
    resultsDiv.classList.add('d-none');
    ovScore.textContent = gradeEl.textContent = onpageEl.textContent = perfEl.textContent =
    coverageEl.textContent = confEl.textContent = '-';
    jsonPre.classList.add('d-none');

    try {
        const response = await fetch('/api/open-audit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Audit failed');
        }

        const data = await response.json();

        // 2. Populate text fields from Python response
        ovScore.textContent = data.overall_score ?? '-';
        gradeEl.textContent = data.grade ?? '-';
        onpageEl.textContent = data.breakdown.onpage ?? '-';
        perfEl.textContent = data.breakdown.performance ?? '-';
        coverageEl.textContent = data.breakdown.coverage ?? '-';
        confEl.textContent = data.breakdown.confidence ?? '-';

        jsonPre.textContent = JSON.stringify(data, null, 2);
        jsonPre.classList.remove('d-none');

        // 3. THE FIX: Handle the Chart.js instance correctly
        const ctx = document.getElementById('breakdownChart').getContext('2d');
        
        // If a chart already exists, destroy it before creating a new one
        if (breakdownChartInstance) {
            breakdownChartInstance.destroy();
        }

        breakdownChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['On-page', 'Performance', 'Coverage', 'Confidence'],
                datasets: [{
                    label: 'Score',
                    data: [
                        data.breakdown.onpage || 0,
                        data.breakdown.performance || 0,
                        data.breakdown.coverage || 0,
                        data.breakdown.confidence || 0
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { legend: { display: false } }
            }
        });

        resultsDiv.classList.remove('d-none');
    } catch (e) {
        console.error("Client Error:", e);
        alert(e.message || 'Error running audit. Check console for details.');
    } finally {
        // 4. Reset Button State
        btn.disabled = false;
        btnText.textContent = 'Audit';
        btnSpinner.classList.add('d-none');
    }
}

// Event Listeners
document.getElementById('btnOpenAudit').addEventListener('click', () => {
    const urlInput = document.getElementById('openUrl');
    const url = urlInput.value.trim();
    if (!url || !url.startsWith('http')) return alert('Please enter a valid URL (http/https)');
    runAudit(url);
});

window.addEventListener('load', () => {
    const urlInput = document.getElementById('openUrl');
    if (urlInput.value.trim()) runAudit(urlInput.value.trim());
});
</script>
{% endblock %}
