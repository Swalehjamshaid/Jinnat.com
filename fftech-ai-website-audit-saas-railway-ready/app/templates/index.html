<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website Audit Pro</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.12);
      --shadow: 0 12px 35px rgba(0,0,0,0.35);
      --radius: 18px;
    }
    body {
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 30% 20%, rgba(14,165,233,0.25), transparent 55%),
        radial-gradient(900px 500px at 70% 10%, rgba(34,197,94,0.18), transparent 50%),
        radial-gradient(800px 500px at 60% 80%, rgba(239,68,68,0.12), transparent 50%),
        linear-gradient(180deg, rgba(2,6,23,1) 0%, rgba(3,7,18,1) 100%);
      color: #e2e8f0;
    }
    .app-shell { max-width: 1200px; margin: 0 auto; padding: 22px 16px 80px; }
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand-badge {
      width: 46px; height: 46px; border-radius: 14px;
      display: grid; place-items: center; font-weight: 800;
      background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(99,102,241,0.85));
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 12px 30px rgba(14,165,233,0.22);
    }
    .subtle { color: rgba(255,255,255,0.70); }
    .muted-2 { color: rgba(255,255,255,0.65); }
    .pill { border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: rgba(255,255,255,0.78); }
    .score-ring {
      width: 180px; height: 180px; border-radius: 999px; position: relative;
      display: grid; place-items: center;
      background: radial-gradient(circle at center, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 35%, transparent 60%),
                  conic-gradient(from 180deg, rgba(14,165,233,0.95) var(--deg), rgba(255,255,255,0.08) 0);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .score-ring .inside {
      width: 132px; height: 132px; border-radius: 999px;
      background: rgba(2,6,23,0.75); border: 1px solid rgba(255,255,255,0.12);
      display: grid; place-items: center; text-align: center; padding: 10px;
    }
    .score-ring .inside .score { font-size: 40px; font-weight: 900; line-height: 1; }
    .score-ring .inside .grade { font-weight: 800; margin-top: 4px; opacity: 0.9; }
    .btn-glow {
      background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(99,102,241,0.9));
      border: none; box-shadow: 0 18px 40px rgba(14,165,233,0.22);
    }
    .btn-glow:hover { filter: brightness(1.05); }
    .mini-card {
      border-radius: 18px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06); padding: 14px; height: 100%;
    }
    .mini-card .label { font-size: 12px; opacity: 0.8; }
    .mini-card .value { font-size: 34px; font-weight: 850; line-height: 1.1; }
    .mini-card .hint { font-size: 12px; opacity: 0.72; margin-top: 8px; }
    .kv-table td, .kv-table th { border-color: rgba(255,255,255,0.10) !important; }
    .progress { height: 10px; border-radius: 999px; overflow: hidden; }
    .progress-bar { transition: width .4s ease; }
    .fade-in { animation: fadeIn .4s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .ssl-warning {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.4);
      color: #fde047;
      border-radius: 12px;
      padding: 12px 16px;
      margin: 16px 0;
    }
    .alert-box { border-radius: 12px; padding: 16px; margin-bottom: 16px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-badge text-white">FF</div>
        <div>
          <div class="h4 mb-0 fw-bold">Website Audit Pro</div>
          <div class="subtle small">Fast & Professional Website Audit Tool</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="wsStatus" class="pill">WS: Disconnected</span>
        <button class="btn btn-sm btn-outline-secondary" id="themeToggle">üåô / ‚òÄÔ∏è</button>
      </div>
    </div>

    <!-- Input Area -->
    <div class="glass p-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-7">
          <label class="form-label fw-semibold">Website URL</label>
          <input id="urlInput" type="text" class="form-control form-control-lg"
                 placeholder="example.com or https://example.com"
                 value="https://www.haier.com.pk" autofocus />
          <div class="small muted-2 mt-1">Paste domain or full URL ‚Äî system auto-normalizes</div>
        </div>
        <div class="col-lg-5">
          <div class="d-grid gap-2 d-lg-flex justify-content-lg-end">
            <button id="startBtn" class="btn btn-lg btn-glow text-white fw-semibold" type="button">
              ‚ñ∂ Start Audit
            </button>
            <button id="pdfBtn" class="btn btn-lg btn-outline-info fw-semibold" type="button" disabled>
              ‚¨á Download PDF Report
            </button>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <hr class="my-4 border-0" style="border-top:1px solid rgba(255,255,255,0.12)">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">Progress</div>
        <div class="subtle"><span id="progressText">0%</span> ‚Ä¢ <span id="statusText">idle</span></div>
      </div>
      <div class="progress glass">
        <div id="progressBar" class="progress-bar bg-info" role="progressbar" style="width:0%"></div>
      </div>

      <!-- Alerts / Warnings -->
      <div id="alertArea" class="mt-3"></div>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" class="row g-4 mb-5" style="display:none;">
      <!-- SSL Warning -->
      <div id="sslWarning" class="ssl-warning d-none">
        <strong>Notice:</strong> SSL certificate verification was relaxed due to site configuration issues. 
        Audit results are still valid, but please be aware of potential certificate problems.
      </div>

      <div class="col-lg-4">
        <div class="glass p-4 text-center h-100">
          <div class="score-ring mx-auto" id="scoreRing" style="--deg: 0deg;">
            <div class="inside">
              <div class="score" id="overallScore">0</div>
              <div class="grade" id="gradeText">F</div>
              <div class="small muted-2 mt-1" id="auditedUrl">Audited: ‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="glass p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0">Score Breakdown</h5>
              <div class="subtle small">SEO ‚Ä¢ Performance ‚Ä¢ Links ‚Ä¢ Security</div>
            </div>
            <span class="pill" id="lastRunAt">‚Äî</span>
          </div>
          <canvas id="breakdownChart" height="140"></canvas>
        </div>
      </div>
    </div>

    <!-- Category Cards -->
    <div id="cardsArea" class="row g-3 mb-4" style="display:none;">
      <div class="col-md-6 col-lg-3"><div class="mini-card"><div class="label">SEO</div><div class="value" id="seoScore">0</div><div class="hint">Title, meta, H1, ALT</div></div></div>
      <div class="col-md-6 col-lg-3"><div class="mini-card"><div class="label">Performance</div><div class="value" id="perfScore">0</div><div class="hint">Speed, size, resources</div></div></div>
      <div class="col-md-6 col-lg-3"><div class="mini-card"><div class="label">Links</div><div class="value" id="linksScore">0</div><div class="hint">Internal / External</div></div></div>
      <div class="col-md-6 col-lg-3"><div class="mini-card"><div class="label">Security</div><div class="value" id="secScore">0</div><div class="hint">HTTPS, HSTS, status</div></div></div>
    </div>

    <!-- Dynamic Highlights & Details -->
    <div id="dynamicArea" class="row g-3" style="display:none;">
      <div class="col-lg-6">
        <div class="glass p-4 h-100">
          <h5 class="mb-3">Highlights</h5>
          <div id="dynamicCards" class="d-grid gap-3"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="glass p-4 h-100">
          <h5 class="mb-3">Details</h5>
          <div class="table-responsive">
            <table class="table table-sm kv-table mb-0">
              <tbody id="kvBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5 subtle small">
      ¬© FF Tech ‚Ä¢ Real-time WebSocket Audit ‚Ä¢ Powered by Runner.py
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // === CONFIG ===
    const DEBUG = false;
    const WS_URL = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;

    // === DOM Elements ===
    const els = {
      urlInput: document.getElementById('urlInput'),
      startBtn: document.getElementById('startBtn'),
      pdfBtn: document.getElementById('pdfBtn'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText'),
      statusText: document.getElementById('statusText'),
      wsStatus: document.getElementById('wsStatus'),
      alertArea: document.getElementById('alertArea'),
      resultsArea: document.getElementById('resultsArea'),
      cardsArea: document.getElementById('cardsArea'),
      dynamicArea: document.getElementById('dynamicArea'),
      sslWarning: document.getElementById('sslWarning'),
      overallScore: document.getElementById('overallScore'),
      gradeText: document.getElementById('gradeText'),
      auditedUrl: document.getElementById('auditedUrl'),
      seoScore: document.getElementById('seoScore'),
      perfScore: document.getElementById('perfScore'),
      linksScore: document.getElementById('linksScore'),
      secScore: document.getElementById('secScore'),
      breakdownChart: document.getElementById('breakdownChart'),
      dynamicCards: document.getElementById('dynamicCards'),
      kvBody: document.getElementById('kvBody'),
      lastRunAt: document.getElementById('lastRunAt'),
      scoreRing: document.getElementById('scoreRing')
    };

    let ws = null;
    let chart = null;
    let lastResult = null;
    let auditInProgress = false;

    // === Helpers ===
    const escapeHtml = (str) => String(str || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[m]);

    function showAlert(msg, type = 'info', persist = false) {
      const div = document.createElement('div');
      div.className = `alert alert-${type} alert-dismissible fade show alert-box`;
      div.innerHTML = `
        ${msg}
        ${persist ? '' : '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>'}
      `;
      els.alertArea.prepend(div);
      if (!persist) setTimeout(() => div.remove(), 8000);
    }

    function setProgress(pct, status = 'working') {
      const p = Math.max(0, Math.min(100, parseInt(pct) || 0));
      els.progressBar.style.width = `${p}%`;
      els.progressText.textContent = `${p}%`;
      els.statusText.textContent = status;
      els.progressBar.className = `progress-bar ${p === 100 ? 'bg-success' : 'bg-info'}`;
    }

    function setWsStatus(connected) {
      els.wsStatus.textContent = connected ? 'WS: Connected' : 'WS: Disconnected';
      els.wsStatus.className = `pill ${connected ? 'bg-success' : 'bg-danger'}`;
    }

    // === Render Result ===
    function renderResult(r) {
      lastResult = r;
      auditInProgress = false;
      els.resultsArea.style.display = 'flex';
      els.cardsArea.style.display = 'flex';
      els.dynamicArea.style.display = 'flex';

      // SSL warning
      if (r.ssl_relaxed) {
        els.sslWarning.classList.remove('d-none');
      } else {
        els.sslWarning.classList.add('d-none');
      }

      // Handle failure / no data cases
      const score = parseInt(r.overall_score || 0);
      if (r.error) {
        showAlert(`Audit failed: ${escapeHtml(r.error)}`, 'danger', true);
        setProgress(100, 'failed');
        return;
      }
      if (score === 0) {
        showAlert(
          'Audit completed but no meaningful data extracted. The site may have returned empty/invalid HTML or blocked the request.',
          'warning',
          true
        );
      }

      // Overall score
      const deg = Math.min(360, (score / 100) * 360);
      els.scoreRing.style.setProperty('--deg', `${deg}deg`);
      els.overallScore.textContent = score;
      els.gradeText.textContent = r.grade || 'F';
      els.auditedUrl.textContent = `Audited: ${r.audited_url || '-'}`;
      els.lastRunAt.textContent = new Date().toLocaleString();

      // Category scores
      const b = r.breakdown || {};
      els.seoScore.textContent = b.seo?.score ?? 0;
      els.perfScore.textContent = b.performance?.score ?? 0;
      els.linksScore.textContent = b.links?.score ?? 0;
      els.secScore.textContent = b.security?.score ?? 0;

      // Chart
      const chartData = r.chart_data?.[0]?.data || {
        labels: ['SEO','Performance','Links','Security'],
        datasets: [{ data: [b.seo?.score??0, b.performance?.score??0, b.links?.score??0, b.security?.score??0], backgroundColor: ['#fbbf24','#38bdf8','#22c55e','#ef4444'] }]
      };

      if (chart) chart.destroy();
      chart = new Chart(els.breakdownChart, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });

      // Dynamic cards
      els.dynamicCards.innerHTML = '';
      (r.dynamic?.cards || []).forEach(c => {
        els.dynamicCards.innerHTML += `
          <div class="mini-card fade-in">
            <div class="fw-bold mb-1">${escapeHtml(c.title || '')}</div>
            <div class="subtle">${escapeHtml(c.body || '')}</div>
          </div>`;
      });

      // KV table
      els.kvBody.innerHTML = '';
      (r.dynamic?.kv || []).forEach(item => {
        els.kvBody.innerHTML += `
          <tr>
            <th>${escapeHtml(item.key || '')}</th>
            <td>${escapeHtml(String(item.value ?? ''))}</td>
          </tr>`;
      });

      els.pdfBtn.disabled = false;
      setProgress(100, 'completed');
      showAlert('Audit completed!', 'success');
    }

    // === WebSocket ===
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      ws.onopen = () => setWsStatus(true);
      ws.onmessage = e => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.status === 'completed' && msg.result) {
            renderResult(msg.result);
          } else if (msg.status === 'error') {
            showAlert(`Error: ${msg.message || 'Unknown error'}`, 'danger', true);
          } else if (msg.status && msg.progress !== undefined) {
            setProgress(msg.progress, msg.status);
          }
        } catch {}
      };
      ws.onclose = () => {
        setWsStatus(false);
        setTimeout(connectWebSocket, 3000);
      };
      ws.onerror = () => setWsStatus(false);
    }

    connectWebSocket();

    // === Start Audit ===
    els.startBtn.onclick = async () => {
      const url = els.urlInput.value.trim();
      if (!url) return showAlert('Please enter a URL', 'warning');

      auditInProgress = true;
      els.startBtn.disabled = true;
      els.startBtn.textContent = 'Auditing...';
      els.pdfBtn.disabled = true;
      setProgress(0, 'starting');
      els.alertArea.innerHTML = '';
      els.resultsArea.style.display = 'none';
      els.cardsArea.style.display = 'none';
      els.dynamicArea.style.display = 'none';

      try {
        ws.send(JSON.stringify({ url }));
      } catch (e) {
        showAlert('WebSocket issue ‚Äî please refresh page', 'warning');
      }
    };

    // === PDF Download ===
    els.pdfBtn.onclick = async () => {
      const url = els.urlInput.value.trim();
      if (!url) return;

      els.pdfBtn.disabled = true;
      els.pdfBtn.innerHTML = 'Generating PDF...';

      try {
        const res = await fetch('/api/audit/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        if (!res.ok) throw new Error(await res.text());

        const blob = await res.blob();
        const urlObj = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObj;
        a.download = 'Website_Audit_Report.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(urlObj);

        showAlert('PDF downloaded successfully!', 'success');
      } catch (e) {
        showAlert(`PDF failed: ${e.message}`, 'danger', true);
      } finally {
        els.pdfBtn.disabled = false;
        els.pdfBtn.innerHTML = '‚¨á Download PDF Report';
      }
    };
  </script>
</body>
</html>
