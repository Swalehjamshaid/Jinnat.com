{% extends 'base.html' %}

{% block content %}
<div class="row">
  <!-- Open Access Audit -->
  <div class="col-lg-7">
    <div class="card bg-body-tertiary mb-4">
      <div class="card-body">
        <h4 class="card-title">Open Access Audit</h4>
        <p class="text-secondary">Quickly audit any URL - no sign-in required.</p>
        <div class="input-group mb-3">
          <input id="openUrl" type="url" class="form-control" placeholder="https://example.com">
          <button id="btnOpenAudit" class="btn btn-primary">Audit</button>
        </div>

        <div id="openResults" class="mt-3 d-none">
          <h6>Results</h6>
          <div class="row">
            <div class="col-md-4">
              <div class="p-3 rounded bg-dark-subtle">
                <b>Overall Score</b>
                <div id="ovScore">-</div>
              </div>
            </div>
            <div class="col-md-8">
              <canvas id="breakdownChart" height="120"></canvas>
            </div>
          </div>
          <pre id="openJson" class="small mt-3 bg-light p-2 rounded"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Passwordless Sign-in -->
  <div class="col-lg-5">
    <div class="card bg-body-tertiary mb-4">
      <div class="card-body">
        <h4 class="card-title">Passwordless Sign-in</h4>
        <form method="post" action="/request-login">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <button class="btn btn-success w-100">Send Magic Link</button>
        </form>
        <p class="small text-secondary mt-2">
          Free users can run up to 10 audits; subscribe to unlock scheduling & history.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.getElementById('btnOpenAudit').addEventListener('click', async () => {
    const url = document.getElementById('openUrl').value;
    if (!url) return alert('Please enter a URL');

    const resultsDiv = document.getElementById('openResults');
    const ovScore = document.getElementById('ovScore');
    const openJson = document.getElementById('openJson');
    resultsDiv.classList.add('d-none');
    ovScore.textContent = '-';
    openJson.textContent = '';

    try {
        const response = await fetch('/api/open-audit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });

        if (!response.ok) {
            const err = await response.json();
            return alert(err.detail || 'Audit failed');
        }

        const data = await response.json();

        // Show overall score
        ovScore.textContent = data.overall_score ?? '-';

        // Show JSON
        openJson.textContent = JSON.stringify(data, null, 2);

        // Render breakdown chart
        const ctx = document.getElementById('breakdownChart').getContext('2d');
        if (window.breakdownChart) window.breakdownChart.destroy();
        window.breakdownChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.breakdown || {}),
                datasets: [{
                    label: 'Score',
                    data: Object.values(data.breakdown || {}),
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 100 }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        resultsDiv.classList.remove('d-none');
    } catch (e) {
        console.error(e);
        alert('Error running audit');
    }
});
</script>
{% endblock %}
