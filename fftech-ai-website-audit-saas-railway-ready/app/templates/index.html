<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FF Tech — Website Audit Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --card-glow: rgba(56, 189, 248, .15);
    }
    body {
      background: radial-gradient(1200px 700px at 10% 10%, rgba(34,197,94,.10), transparent 55%),
                  radial-gradient(1200px 700px at 90% 20%, rgba(56,189,248,.12), transparent 50%),
                  radial-gradient(900px 600px at 50% 90%, rgba(244,63,94,.10), transparent 50%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
      border-radius: 16px;
    }
    .metric {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .metric:hover {
      box-shadow: 0 15px 45px rgba(0,0,0,.35), 0 0 0 6px var(--card-glow);
      transform: translateY(-2px);
      transition: .18s ease;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre {
      max-height: 360px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      padding: 12px;
    }
    .badge-soft {
      background: rgba(56,189,248,.15);
      border: 1px solid rgba(56,189,248,.35);
      color: #9ee7ff;
    }
    .btn-glow {
      box-shadow: 0 10px 25px rgba(56,189,248,.15);
    }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      background: #6c757d;
    }
    .status-dot.running { background: #38bdf8; }
    .status-dot.ok { background: #22c55e; }
    .status-dot.err { background: #ef4444; }
  </style>
</head>

<body>
  <!-- Top Bar -->
  <nav class="navbar navbar-expand-lg px-3 py-3">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <span class="badge badge-soft rounded-pill px-3 py-2">FF Tech</span>
        <span class="fw-semibold">Website Audit Dashboard</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button id="themeBtn" class="btn btn-outline-secondary btn-sm">Toggle Theme</button>
        <a class="btn btn-outline-secondary btn-sm" href="/health" target="_blank">Health</a>
      </div>
    </div>
  </nav>

  <main class="container pb-5">
    <!-- Controls -->
    <div class="glass p-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-7">
          <label class="form-label">Website URL</label>
          <input id="urlInput" class="form-control form-control-lg"
                 placeholder="example.com or https://example.com" />
          <div class="form-text">Tip: you can enter without https:// — runner normalizes it.</div>
        </div>
        <div class="col-12 col-lg-5 d-flex gap-2">
          <button id="startBtn" class="btn btn-primary btn-lg flex-grow-1 btn-glow">
            Start Audit
          </button>
          <button id="stopBtn" class="btn btn-outline-danger btn-lg" disabled>
            Stop
          </button>
        </div>
      </div>

      <hr class="my-4"/>

      <!-- Status + Progress -->
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center">
          <span id="statusDot" class="status-dot"></span>
          <div>
            <div class="small text-secondary">Status</div>
            <div id="statusText" class="fw-semibold">Idle</div>
          </div>
        </div>

        <div class="flex-grow-1">
          <div class="d-flex justify-content-between small text-secondary mb-1">
            <span>Progress</span>
            <span id="progressPct">0%</span>
          </div>
          <div class="progress" style="height: 12px;">
            <div id="progressBar" class="progress-bar progress-bar-striped" style="width:0%"></div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button id="downloadJsonBtn" class="btn btn-outline-success" disabled>Download JSON</button>
          <button id="copyJsonBtn" class="btn btn-outline-secondary" disabled>Copy JSON</button>
        </div>
      </div>
    </div>

    <!-- Summary row -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-4">
        <div class="metric p-4 h-100">
          <div class="text-secondary small">Audited URL</div>
          <div id="auditedUrl" class="fw-semibold mt-1">—</div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="metric p-4 h-100">
          <div class="text-secondary small">Overall Score</div>
          <div class="display-6 fw-bold mt-1" id="overallScore">—</div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="metric p-4 h-100">
          <div class="text-secondary small">Grade</div>
          <div class="display-6 fw-bold mt-1" id="grade">—</div>
        </div>
      </div>
    </div>

    <!-- Breakdown cards -->
    <div class="glass p-4 mb-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h5 class="mb-0">Breakdown</h5>
        <span class="text-secondary small">SEO • Performance • Links • Security</span>
      </div>

      <div class="row g-3" id="breakdownCards">
        <!-- injected -->
      </div>
    </div>

    <!-- Chart + Dynamic -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-7">
        <div class="glass p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Charts</h5>
            <span class="text-secondary small">Chart.js from result.chart_data</span>
          </div>
          <canvas id="scoreChart" height="120"></canvas>
          <div id="chartHint" class="text-secondary small mt-3">No chart yet.</div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="glass p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Highlights</h5>
            <span class="text-secondary small">From result.dynamic</span>
          </div>

          <div id="dynamicCards" class="d-grid gap-2 mb-3"></div>

          <div class="border-top pt-3">
            <div class="text-secondary small mb-2">Key Values</div>
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <tbody id="dynamicKv"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Raw JSON -->
    <div class="glass p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Raw Result JSON</h5>
        <span class="text-secondary small mono">result (from runner.run)</span>
      </div>
      <pre id="rawJson" class="mono">—</pre>
    </div>
  </main>

  <script>
    // -----------------------------
    // Theme toggle (dark/light)
    // -----------------------------
    const themeBtn = document.getElementById("themeBtn");
    themeBtn.addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute("data-bs-theme") || "dark";
      html.setAttribute("data-bs-theme", current === "dark" ? "light" : "dark");
    });

    // -----------------------------
    // UI elements
    // -----------------------------
    const urlInput = document.getElementById("urlInput");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const progressBar = document.getElementById("progressBar");
    const progressPct = document.getElementById("progressPct");

    const auditedUrlEl = document.getElementById("auditedUrl");
    const overallScoreEl = document.getElementById("overallScore");
    const gradeEl = document.getElementById("grade");

    const breakdownCards = document.getElementById("breakdownCards");
    const dynamicCards = document.getElementById("dynamicCards");
    const dynamicKv = document.getElementById("dynamicKv");

    const rawJson = document.getElementById("rawJson");
    const downloadJsonBtn = document.getElementById("downloadJsonBtn");
    const copyJsonBtn = document.getElementById("copyJsonBtn");

    const chartHint = document.getElementById("chartHint");
    const chartCanvas = document.getElementById("scoreChart");

    let ws = null;
    let lastResult = null;
    let chart = null;

    function setStatus(type, text) {
      statusDot.classList.remove("running","ok","err");
      if (type === "running") statusDot.classList.add("running");
      if (type === "ok") statusDot.classList.add("ok");
      if (type === "err") statusDot.classList.add("err");
      statusText.textContent = text;
    }

    function setProgress(pct) {
      const p = Math.max(0, Math.min(100, Number(pct || 0)));
      progressBar.style.width = p + "%";
      progressPct.textContent = p + "%";
      progressBar.classList.toggle("progress-bar-striped", p < 100);
      progressBar.classList.toggle("progress-bar-animated", p < 100);
    }

    function resetUI() {
      setStatus("", "Idle");
      setProgress(0);
      auditedUrlEl.textContent = "—";
      overallScoreEl.textContent = "—";
      gradeEl.textContent = "—";
      breakdownCards.innerHTML = "";
      dynamicCards.innerHTML = "";
      dynamicKv.innerHTML = "";
      rawJson.textContent = "—";
      chartHint.textContent = "No chart yet.";
      downloadJsonBtn.disabled = true;
      copyJsonBtn.disabled = true;
      lastResult = null;
      if (chart) { chart.destroy(); chart = null; }
    }

    function renderBreakdown(result) {
      const breakdown = (result && result.breakdown) ? result.breakdown : {};
      const items = [
        { key: "seo", label: "SEO", color: "warning" },
        { key: "performance", label: "Performance", color: "info" },
        { key: "links", label: "Links", color: "success" },
        { key: "security", label: "Security", color: "danger" },
      ];

      breakdownCards.innerHTML = items.map(it => {
        const score = breakdown?.[it.key]?.score ?? breakdown?.[it.key]?.score ?? null;
        const extras = breakdown?.[it.key]?.extras ?? breakdown?.[it.key] ?? {};
        const scoreText = (score === null || score === undefined) ? "—" : score;

        // show a few extras quickly
        const extrasKeys = Object.keys(extras || {}).slice(0, 4);
        const extrasHtml = extrasKeys.map(k => {
          const v = extras[k];
          return `<div class="small text-secondary"><span class="mono">${k}</span>: <span class="text-body">${String(v)}</span></div>`;
        }).join("");

        return `
          <div class="col-12 col-md-6 col-xl-3">
            <div class="metric p-3 h-100">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">${it.label}</div>
                <span class="badge text-bg-${it.color}">${scoreText}</span>
              </div>
              <div class="text-secondary small">Top signals</div>
              <div class="mt-2">${extrasHtml || `<div class="small text-secondary">No extras</div>`}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderDynamic(result) {
      const dyn = result?.dynamic || {};
      const cards = Array.isArray(dyn.cards) ? dyn.cards : [];
      const kv = Array.isArray(dyn.kv) ? dyn.kv : [];

      dynamicCards.innerHTML = cards.slice(0, 6).map(c => `
        <div class="metric p-3">
          <div class="fw-semibold">${escapeHtml(c.title || "Card")}</div>
          <div class="text-secondary small mt-1">${escapeHtml(c.body || "")}</div>
        </div>
      `).join("");

      dynamicKv.innerHTML = kv.slice(0, 20).map(row => `
        <tr>
          <td class="text-secondary mono" style="width:45%;">${escapeHtml(String(row.key || ""))}</td>
          <td class="mono">${escapeHtml(String(row.value ?? ""))}</td>
        </tr>
      `).join("");
    }

    function renderChart(result) {
      const chartDataArr = result?.chart_data;
      if (!Array.isArray(chartDataArr) || chartDataArr.length === 0) {
        chartHint.textContent = "No chart data found in result.chart_data.";
        if (chart) { chart.destroy(); chart = null; }
        return;
      }

      // Your runner provides a Chart.js-ready object in chart_data[0]
      const config = chartDataArr[0];
      if (!config?.data) {
        chartHint.textContent = "Chart config missing data.";
        return;
      }

      chartHint.textContent = "";
      if (chart) chart.destroy();

      chart = new Chart(chartCanvas, {
        type: config.type || "bar",
        data: config.data,
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: !!config.title, text: config.title || "" }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

    function renderResult(result) {
      lastResult = result;

      auditedUrlEl.textContent = result?.audited_url || "—";
      overallScoreEl.textContent = (result?.overall_score ?? "—");
      gradeEl.textContent = result?.grade || "—";

      renderBreakdown(result);
      renderDynamic(result);
      renderChart(result);

      rawJson.textContent = JSON.stringify(result, null, 2);
      downloadJsonBtn.disabled = false;
      copyJsonBtn.disabled = false;
    }

    function downloadJson() {
      if (!lastResult) return;
      const blob = new Blob([JSON.stringify(lastResult, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "audit_result.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function copyJson() {
      if (!lastResult) return;
      navigator.clipboard.writeText(JSON.stringify(lastResult, null, 2))
        .then(() => setStatus("ok", "Copied JSON to clipboard"))
        .catch(() => setStatus("err", "Failed to copy JSON"));
    }

    downloadJsonBtn.addEventListener("click", downloadJson);
    copyJsonBtn.addEventListener("click", copyJson);

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }

    // -----------------------------
    // WebSocket: connect + run audit
    // -----------------------------
    function wsUrl(path = "/ws") {
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      return `${proto}://${location.host}${path}`;
    }

    function startAudit() {
      const url = (urlInput.value || "").trim();
      if (!url) {
        setStatus("err", "Please enter a URL");
        return;
      }

      resetUI();
      setStatus("running", "Connecting...");
      setProgress(1);

      startBtn.disabled = true;
      stopBtn.disabled = false;

      ws = new WebSocket(wsUrl("/ws"));

      ws.onopen = () => {
        setStatus("running", "Running audit...");
        ws.send(JSON.stringify({ url }));
      };

      ws.onmessage = (event) => {
        let msg = null;
        try { msg = JSON.parse(event.data); } catch (e) { return; }

        // expected shapes:
        // {progress, status, payload?}
        // final: {progress: 100, status:"completed", result:{...}}
        const prog = msg.progress ?? 0;
        setProgress(prog);

        if (msg.status === "error") {
          setStatus("err", msg.error || "Error");
          stopBtn.disabled = true;
          startBtn.disabled = false;
          safeClose();
          return;
        }

        if (msg.status === "completed") {
          setStatus("ok", "Completed");
          setProgress(100);
          if (msg.result) renderResult(msg.result);

          stopBtn.disabled = true;
          startBtn.disabled = false;
          safeClose();
          return;
        }

        // normal progress update
        setStatus("running", String(msg.status || "Working..."));
      };

      ws.onerror = () => {
        setStatus("err", "WebSocket error");
        stopBtn.disabled = true;
        startBtn.disabled = false;
        safeClose();
      };

      ws.onclose = () => {
        // if not completed, show neutral state
        if (!lastResult) setStatus("", "Disconnected");
        stopBtn.disabled = true;
        startBtn.disabled = false;
      };
    }

    function safeClose() {
      if (ws) {
        try { ws.close(); } catch (e) {}
        ws = null;
      }
    }

    function stopAudit() {
      setStatus("err", "Stopped by user");
      stopBtn.disabled = true;
      startBtn.disabled = false;
      safeClose();
    }

    startBtn.addEventListener("click", startAudit);
    stopBtn.addEventListener("click", stopAudit);

    // Allow pressing Enter to start
    urlInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") startAudit();
    });

    // Start clean
    resetUI();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
``
