<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFTech AI Website Audit</title>

    <!-- Tailwind (optional but recommended) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js v4 -->
    src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f8fafc; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
    </style>
</head>
<body class="p-6">

    <h1 class="text-3xl font-bold text-center mb-8">FFTech AI Website Audit</h1>

    <!-- URL Input -->
   >
        <input id="urlInput" type="text" placeholder="https://example.com"
               class="w-full border px-3 py-2 rounded mb-4">

        <button onclick="runAudit()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">
            üîç Run Audit
        </button>

        <p id="status" class="text-gray-600 mt-4 text-sm"></p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden">

        <!-- Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

            <div class="card">
                <h3 class="font-bold text-lg mb-1">Overall Score</h3>
                <p id="overallScore" class="text-4xl font-bold text-blue-700"></p>
                <p id="grade" class="text-xl text-gray-500"></p>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-1">SEO</h3>
                <p id="seoScore" class="text-4xl font-bold text-yellow-600"></p>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-1">Performance</h3>
                <p id="performanceScore" class="text-4xl font-bold text-green-600"></p>
                <p class="text-gray-500 text-sm">LCP: <span id="lcpMS"></span> ms</p>
            </div>

        </div>

        <!-- Competitors -->
        <div class="card mb-6">
            <h3 class="font-bold text-lg mb-3">Top Competitors</h3>
            <p class="text-gray-700"><strong>Score:</strong> <span id="compScore"></span></p>
            <p class="text-gray-700"><strong>Names:</strong> 
                <span id="compNames"></span>
            </p>
        </div>

        <!-- Links -->
        <div class="card mb-6">
            <h3 class="font-bold text-lg mb-3">Link Summary</h3>
            <ul class="text-gray-700 leading-relaxed">
                <li>Internal Links: <span id="internalLinks"></span></li>
                <li>External Links: <span id="externalLinks"></span></li>
                <li>Warnings: <span id="warningLinks"></span></li>
                <li>Broken Links: <span id="brokenLinks"></span></li>
            </ul>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card">
                <h3 class="font-bold text-lg mb-3">Audit Breakdown</h3>
                <canvas id="barChart"></canvas>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-3">Link Health</h3>
                <canvas id="doughnutChart"></canvas>
            </div>

        </div>

    </div>

    <!-- JS Logic -->
    <script>
        let barChart, doughnutChart;

        async function runAudit() {
            const url = document.getElementById("urlInput").value.trim();
            if (!url) return alert("Enter a valid URL!");

            document.getElementById("status").innerText = "‚è≥ Running audit...";
            document.getElementById("results").classList.add("hidden");

            // Start streaming
            const response = await fetch("/run_audit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url })
            });

            if (!response.body) {
                alert("Server error: No stream found.");
                return;
            }

            const reader = response.body.pipeTo(new WritableStream({
                write(chunk) {

                    const text = new TextDecoder().decode(chunk);
                    const messages = text.split("\n").filter(x => x.trim().length);

                    for (const msg of messages) {
                        const data = JSON.parse(msg);

                        if (data.status) {
                            document.getElementById("status").innerText = data.status;
                        }

                        if (data.finished) renderResults(data);
                    }
                }
            }));
        }

        function renderResults(data) {
            document.getElementById("results").classList.remove("hidden");

            document.getElementById("overallScore").innerText = data.overall_score;
            document.getElementById("grade").innerText = "Grade: " + data.grade;

            document.getElementById("seoScore").innerText = data.breakdown.seo;
            document.getElementById("performanceScore").innerText = data.breakdown.performance.score;
            document.getElementById("lcpMS").innerText = data.breakdown.performance.lcp_ms;

            document.getElementById("compScore").innerText =
                data.breakdown.competitors.top_competitor_score;

            document.getElementById("compNames").innerText =
                (data.breakdown.competitors.names || []).join(", ") || "No competitors detected";

            const links = data.breakdown.links;
            document.getElementById("internalLinks").innerText = links.internal_links_count;
            document.getElementById("externalLinks").innerText = links.external_links_count;
            document.getElementById("warningLinks").innerText = links.warning_links_count;
            document.getElementById("brokenLinks").innerText = links.broken_internal_links;

            // Charts
            const barData = data.chart_data.bar;
            const doughnutData = data.chart_data.doughnut;

            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById("barChart"), {
                type: "bar",
                data: barData,
                options: { responsive: true }
            });

            if (doughnutChart) doughnutChart.destroy();
            doughnutChart = new Chart(document.getElementById("doughnutChart"), {
                type: "doughnut",
                data: doughnutData,
                options: { responsive: true }
            });

            document.getElementById("status").innerText = "‚úÖ Audit Complete";
        }
    </script>
</body>
</html>
