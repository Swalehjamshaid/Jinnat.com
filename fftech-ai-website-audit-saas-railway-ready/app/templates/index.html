<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FF Tech Audit ‚Äì Professional Website Auditor</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { background-color: #121212; color: #f5f5f5; font-family: 'Segoe UI', sans-serif; }
    .card { background-color: #1e1e2f; border-radius: 12px; margin-bottom: 20px; }
    .card-title { font-weight: 600; }
    .progress { height: 25px; border-radius: 12px; }
    .chart-container { position: relative; height: 350px; width: 100%; margin-bottom: 30px; }
    .kv-table td, .kv-table th { padding: 8px; }
    .kv-table th { background-color: #2a2a3f; }
    .kv-table td { background-color: #1e1e2f; }
    .loader { text-align: center; margin-top: 50px; font-size: 24px; }
    .ai-panel { background-color: #1b1b2a; border-radius: 12px; padding: 15px; margin-top: 15px; }
    .competitor-table th, .competitor-table td { padding: 8px; text-align: center; }
    .btn-export { margin-bottom: 15px; }
  </style>
</head>
<body>
<div class="container my-4">

  <h1 class="mb-4 text-center">üåê FF Tech Website Audit</h1>

  <!-- Input URL -->
  <div class="mb-4">
    <label for="urlInput" class="form-label">Enter URL for Audit:</label>
    <div class="input-group">
      <input type="text" id="urlInput" class="form-control" placeholder="https://example.com">
      <button class="btn btn-primary" id="startAudit"><i class="fa fa-rocket"></i> Start Audit</button>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" style="display:none;">‚è≥ Running Audit...</div>

  <!-- Overall Score -->
  <div id="overallSection" class="mb-4" style="display:none;">
    <h3>Overall Score: <span id="overallScore"></span> | Grade: <span id="overallGrade"></span></h3>
  </div>

  <!-- Charts -->
  <div class="row" id="chartsRow" style="display:none;">
    <div class="col-md-6">
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="chart-container">
        <canvas id="doughnutChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Dynamic Cards -->
  <div class="row" id="cardsRow" style="display:none;"></div>

  <!-- Key-Value Tables -->
  <div id="kvSection" style="display:none;">
    <h4 class="mt-4">Detailed Metrics</h4>
    <div id="kvTables"></div>
  </div>

  <!-- Competitor Comparison -->
  <div id="competitorSection" style="display:none;">
    <h4 class="mt-4">Competitor Comparison</h4>
    <table class="table table-striped competitor-table">
      <thead>
        <tr>
          <th>Competitor</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody id="competitorBody"></tbody>
    </table>
  </div>

  <!-- AI Recommendations -->
  <div id="aiPanel" class="ai-panel" style="display:none;">
    <h4>AI Recommendations</h4>
    <ul id="aiList"></ul>
  </div>

  <!-- Export Button -->
  <button class="btn btn-success btn-export" id="exportPDF" style="display:none;"><i class="fa fa-file-pdf"></i> Export PDF</button>

</div>

<script>
  let auditData = null;

  async function startAudit() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) { alert('Please enter a valid URL'); return; }

    document.getElementById('loader').style.display = 'block';
    document.getElementById('overallSection').style.display = 'none';
    document.getElementById('chartsRow').style.display = 'none';
    document.getElementById('cardsRow').style.display = 'none';
    document.getElementById('kvSection').style.display = 'none';
    document.getElementById('competitorSection').style.display = 'none';
    document.getElementById('aiPanel').style.display = 'none';
    document.getElementById('exportPDF').style.display = 'none';

    const ws = new WebSocket(`ws://${window.location.host}/ws`);

    ws.onopen = () => ws.send(JSON.stringify({url}));

    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      if (data.error) {
        alert('Audit Error: ' + data.error);
        ws.close();
        document.getElementById('loader').style.display = 'none';
        return;
      }

      if (data.finished) {
        auditData = data;
        displayResults(data);
        ws.close();
      }
    };
  }

  function displayResults(data) {
    document.getElementById('loader').style.display = 'none';

    // Overall
    document.getElementById('overallScore').innerText = data.overall_score || 0;
    document.getElementById('overallGrade').innerText = data.grade || 'N/A';
    document.getElementById('overallSection').style.display = 'block';

    // Charts
    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
      type: 'bar',
      data: data.chart_data.bar,
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    const doughCtx = document.getElementById('doughnutChart').getContext('2d');
    new Chart(doughCtx, {
      type: 'doughnut',
      data: data.chart_data.doughnut,
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
    document.getElementById('chartsRow').style.display = 'flex';

    // Dynamic Cards
    const cardsRow = document.getElementById('cardsRow');
    cardsRow.innerHTML = '';
    if (data.dynamic && data.dynamic.cards) {
      data.dynamic.cards.forEach(card => {
        const col = document.createElement('div');
        col.className = 'col-md-3';
        col.innerHTML = `
          <div class="card p-3 text-center">
            <h6 class="card-title">${card.title}</h6>
            <h3>${card.value}${card.unit || ''}</h3>
          </div>`;
        cardsRow.appendChild(col);
      });
      cardsRow.style.display = 'flex';
    }

    // KV Tables
    const kvTables = document.getElementById('kvTables');
    kvTables.innerHTML = '';
    for (const section in data.dynamic.kv) {
      let tableHTML = `<h5>${section.charAt(0).toUpperCase() + section.slice(1)}</h5>
        <table class="table table-bordered kv-table">
          <thead><tr><th>Key</th><th>Value</th></tr></thead>
          <tbody>`;
      data.dynamic.kv[section].forEach(kv => {
        tableHTML += `<tr><td>${kv.key}</td><td>${kv.value}</td></tr>`;
      });
      tableHTML += `</tbody></table>`;
      kvTables.innerHTML += tableHTML;
    }
    document.getElementById('kvSection').style.display = 'block';

    // Competitors
    const compBody = document.getElementById('competitorBody');
    compBody.innerHTML = '';
    if (data.breakdown.competitors && data.breakdown.competitors.names) {
      data.breakdown.competitors.names.forEach(name => {
        compBody.innerHTML += `<tr><td>${name}</td><td>${data.breakdown.competitors.top_competitor_score}</td></tr>`;
      });
      document.getElementById('competitorSection').style.display = 'block';
    }

    // AI Recommendations
    const aiList = document.getElementById('aiList');
    aiList.innerHTML = '';
    if (data.dynamic.plugins && data.dynamic.plugins.AI_Recommendations) {
      data.dynamic.plugins.AI_Recommendations.kv.forEach(item => {
        aiList.innerHTML += `<li>${item.key}: ${item.value}</li>`;
      });
      document.getElementById('aiPanel').style.display = 'block';
    }

    // Show PDF export
    document.getElementById('exportPDF').style.display = 'inline-block';
  }

  // Export PDF
  document.getElementById('exportPDF').addEventListener('click', () => {
    if (!auditData) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text(`Website Audit Report - ${document.getElementById('urlInput').value}`, 10, 10);
    doc.text(`Overall Score: ${auditData.overall_score}, Grade: ${auditData.grade}`, 10, 20);
    doc.save('audit_report.pdf');
  });

  document.getElementById('startAudit').addEventListener('click', startAudit);
</script>
</body>
</html>
