{% extends 'base.html' %}
{% block content %}
<style>
    :root { --brand-primary: #3b82f6; --brand-success: #10b981; --bg-dark: #0f172a; }
    
    /* Scanning Console UI */
    .scanner-box { background: var(--bg-dark); border-radius: 12px; padding: 30px; border: 1px solid #1e293b; }
    .progress-track { height: 8px; background: #1e293b; border-radius: 4px; overflow: hidden; position: relative; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #6366f1); width: 0%; transition: width 0.4s ease; }
    .status-log { font-family: 'Fira Code', monospace; color: var(--brand-success); font-size: 0.85rem; height: 100px; overflow-y: hidden; }
    
    /* International Standard Dashboard */
    .metric-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; height: 100%; transition: transform 0.2s; }
    .metric-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .donut-container { width: 100px; height: 100px; margin: 0 auto; position: relative; }
    .donut-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 800; }
</style>

<div class="container py-5">
    <div class="card shadow-lg border-0 bg-primary text-white p-5 mb-5 rounded-4">
        <h1 class="display-5 fw-bold">Enterprise AI Audit Engine</h1>
        <p class="lead opacity-75">Global Standard: Scanning 200+ Performance, SEO, and Security checkpoints.</p>
        <div class="input-group input-group-lg shadow-sm mt-4" style="max-width: 700px;">
            <input id="auditUrl" type="url" class="form-control border-0" placeholder="https://domain.com">
            <button id="startBtn" class="btn btn-dark px-5 fw-bold">START GLOBAL SCAN</button>
        </div>
    </div>

    <div id="scannerConsole" class="d-none animate__animated animate__fadeIn">
        <div class="scanner-box shadow-2xl mb-5">
            <div class="d-flex justify-content-between text-white mb-3">
                <span class="fw-bold"><i class="fas fa-microchip me-2"></i>AI AUDIT IN PROGRESS</span>
                <span id="progressLabel" class="font-monospace">0%</span>
            </div>
            <div class="progress-track mb-3">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <div id="logWindow" class="status-log mt-4"></div>
        </div>
    </div>

    <div id="resultsDashboard" class="d-none">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card bg-dark text-white p-4 text-center border-0 rounded-4">
                    <h6 class="text-uppercase opacity-50 small">Site Health Index</h6>
                    <div id="mainScore" class="display-2 fw-black">0%</div>
                    <div id="mainGrade" class="badge bg-primary fs-5 mt-2">GRADE -</div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="row g-3" id="categoryGrid">
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const auditSteps = [
    { p: 15, m: ">> Initializing W3C Compliance Crawler..." },
    { p: 30, m: ">> Analyzing HTTP/2 Protocols & SSL Cipher Strength..." },
    { p: 45, m: ">> Evaluating Core Web Vitals (LCP, CLS, TBT)..." },
    { p: 60, m: ">> Mapping On-Page SEO Architecture & JSON-LD Data..." },
    { p: 75, m: ">> Testing Mobile Responsiveness & Touch Target Ratios..." },
    { p: 90, m: ">> Calculating Competitor Gap & Growth ROI..." },
    { p: 100, m: ">> Aggregating 200 Metrics to Global Standards..." }
];

document.getElementById('startBtn').onclick = async function() {
    const url = document.getElementById('auditUrl').value;
    if(!url) return;

    // UI State Change
    this.disabled = true;
    document.getElementById('scannerConsole').classList.remove('d-none');
    document.getElementById('resultsDashboard').classList.add('d-none');
    
    // Simulate Terminal Logging
    let step = 0;
    const logInterval = setInterval(() => {
        if(step < auditSteps.length) {
            const entry = document.createElement('div');
            entry.innerText = auditSteps[step].m;
            document.getElementById('logWindow').appendChild(entry);
            document.getElementById('progressBar').style.width = auditSteps[step].p + '%';
            document.getElementById('progressLabel').innerText = auditSteps[step].p + '%';
            step++;
        }
    }, 1200);

    try {
        const response = await fetch('/api/open-audit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: url })
        });
        const data = await response.json();
        
        clearInterval(logInterval);
        renderDashboard(data);
    } catch (e) {
        alert("Scan Interrupt: Connection Refused");
    } finally {
        this.disabled = false;
        document.getElementById('scannerConsole').classList.add('d-none');
    }
};

function renderDashboard(data) {
    document.getElementById('resultsDashboard').classList.remove('d-none');
    document.getElementById('mainScore').innerText = Math.round(data.overall_score) + '%';
    document.getElementById('mainGrade').innerText = "GRADE " + data.grade;

    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '';

    Object.entries(data.categories).forEach(([key, cat]) => {
        const canvasId = `chart-${key}`;
        const card = `
            <div class="col-md-4">
                <div class="metric-card p-3">
                    <div class="donut-container">
                        <canvas id="${canvasId}"></canvas>
                        <div class="donut-text" style="color:${cat.color}">${Math.round(cat.score)}%</div>
                    </div>
                    <div class="text-center mt-3">
                        <span class="fw-bold small text-uppercase">${cat.name}</span>
                    </div>
                </div>
            </div>
        `;
        grid.innerHTML += card;

        setTimeout(() => {
            new Chart(document.getElementById(canvasId), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [cat.score, 100 - cat.score],
                        backgroundColor: [cat.color, '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }, 100);
    });
}
</script>
{% endblock %}
