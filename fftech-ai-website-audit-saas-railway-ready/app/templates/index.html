<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FF Tech — Website Audit Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .hero-bg { background: linear-gradient(135deg, #1e40af, #3b82f6); }
    .score-card:hover { transform: translateY(-6px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="auditApp()">

  <!-- HEADER -->
  <header class="bg-white border-b shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-700 rounded-xl flex items-center justify-center text-white font-bold text-3xl">F</div>
        <div>
          <span class="text-2xl font-bold text-gray-900">FF Tech</span>
          <span class="text-sm text-gray-500 block -mt-1">Professional Website Audit</span>
        </div>
      </div>
      <button @click="newAudit()" 
              class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium flex items-center gap-2 transition">
        <i class="fas fa-plus"></i> New Audit
      </button>
    </div>
  </header>

  <!-- HERO INPUT -->
  <div class="hero-bg text-white py-16 md:py-20">
    <div class="max-w-4xl mx-auto px-6 text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 leading-tight">
        Instant Professional Website Audit
      </h1>
      <p class="text-xl text-blue-100 mb-10">
        Performance • SEO • Security • Accessibility • Mobile • Compliance — Full PDF Report Included
      </p>

      <div class="max-w-2xl mx-auto">
        <div class="flex flex-col sm:flex-row gap-3 bg-white/10 backdrop-blur-lg rounded-3xl p-2 border border-white/20">
          <input id="urlInput" type="text" placeholder="https://www.example.com" 
                 class="flex-1 px-6 py-4 bg-white rounded-3xl text-gray-900 text-lg focus:outline-none focus:ring-2 focus:ring-blue-300"
                 @keyup.enter="startAudit()">
          <button @click="startAudit()" 
                  class="px-10 py-4 bg-white text-blue-700 font-semibold rounded-3xl hover:bg-gray-100 transition flex items-center gap-3">
            <i class="fas fa-rocket"></i> START AUDIT
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div x-show="progress > 0 && progress < 100" class="max-w-5xl mx-auto px-6 py-12">
    <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
      <div class="flex justify-between mb-5">
        <span class="font-semibold text-xl text-gray-800" x-text="status || 'Analyzing...'"></span>
        <span class="font-bold text-2xl text-blue-600" x-text="progress + '%'"></span>
      </div>
      <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-600 transition-all duration-500" :style="{ width: progress + '%' }"></div>
      </div>
    </div>
  </div>

  <!-- FULL RESULTS -->
  <div x-show="result" class="max-w-7xl mx-auto px-6 pb-32 space-y-12">

    <!-- TOP SUMMARY -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Overall Health</h3>
        <div class="text-6xl font-extrabold" :class="result.overall_score >= 80 ? 'text-green-600' : result.overall_score >= 50 ? 'text-orange-500' : 'text-red-600'">
          <span x-text="result.overall_score"></span>
        </div>
        <div class="text-lg mt-2 font-medium" :class="result.summary?.risk_level === 'Low' ? 'text-green-600' : result.summary?.risk_level === 'Medium' ? 'text-orange-500' : 'text-red-600'" x-text="result.summary?.risk_level || '—'"></div>
      </div>

      <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Grade</h3>
        <div class="text-6xl font-extrabold text-indigo-600" x-text="result.grade || '—'"></div>
      </div>

      <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Audit Date</h3>
        <div class="text-3xl font-bold text-gray-700" x-text="result.audit_datetime || '—'"></div>
      </div>

      <div class="bg-white rounded-3xl p-8 shadow-xl border border-gray-100 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">URL</h3>
        <div class="text-xl font-medium break-all" x-text="result.audited_url"></div>
      </div>
    </div>

    <!-- SCORE BREAKDOWN CHART -->
    <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Score Breakdown Chart</h2>
      <canvas id="scoreChart" height="140"></canvas>
    </div>

    <!-- DETAILED BREAKDOWN TABLES -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- SEO Details -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">SEO Details</h3>
        <table class="w-full text-sm border-collapse">
          <tbody>
            <tr class="border-b"><td class="py-3 font-medium">Title</td><td class="py-3" x-text="result.breakdown?.seo?.extras?.title || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Meta Description Present</td><td class="py-3" x-text="result.breakdown?.seo?.extras?.meta_description_present ? 'Yes' : 'No'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Canonical URL</td><td class="py-3" x-text="result.breakdown?.seo?.extras?.canonical || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">H1 Count</td><td class="py-3" x-text="result.breakdown?.seo?.extras?.h1_count || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Total Images</td><td class="py-3" x-text="result.breakdown?.seo?.extras?.images_total || '—'"></td></tr>
            <tr><td class="py-3 font-medium">Images Missing ALT</td><td class="py-3 text-red-600 font-bold" x-text="result.breakdown?.seo?.extras?.images_missing_alt || '0'"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Performance Details -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Performance Details</h3>
        <table class="w-full text-sm border-collapse">
          <tbody>
            <tr class="border-b"><td class="py-3 font-medium">Load Time</td><td class="py-3 font-bold text-blue-600" x-text="result.breakdown?.performance?.extras?.load_ms + ' ms' || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Page Size</td><td class="py-3" x-text="result.breakdown?.performance?.extras?.bytes ? Math.round(result.breakdown.performance.extras.bytes / 1024) + ' KB' : '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Scripts Count</td><td class="py-3" x-text="result.breakdown?.performance?.extras?.scripts || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Styles Count</td><td class="py-3" x-text="result.breakdown?.performance?.extras?.styles || '—'"></td></tr>
            <tr><td class="py-3 font-medium">Fetcher</td><td class="py-3" x-text="result.breakdown?.performance?.extras?.fetcher || '—'"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Links Details -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Links Overview</h3>
        <table class="w-full text-sm border-collapse">
          <tbody>
            <tr class="border-b"><td class="py-3 font-medium">Internal Links</td><td class="py-3" x-text="result.breakdown?.links?.internal_links_count || '—'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">External Links</td><td class="py-3" x-text="result.breakdown?.links?.external_links_count || '—'"></td></tr>
            <tr><td class="py-3 font-medium">Total Links</td><td class="py-3 font-bold" x-text="result.breakdown?.links?.total_links_count || '—'"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Security Details -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Security Details</h3>
        <table class="w-full text-sm border-collapse">
          <tbody>
            <tr class="border-b"><td class="py-3 font-medium">HTTPS</td><td class="py-3" :class="result.breakdown?.security?.https ? 'text-green-600 font-bold' : 'text-red-600'" x-text="result.breakdown?.security?.https ? 'Yes' : 'No'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">HSTS Enabled</td><td class="py-3" :class="result.breakdown?.security?.hsts ? 'text-green-600 font-bold' : 'text-orange-600'" x-text="result.breakdown?.security?.hsts ? 'Yes' : 'No'"></td></tr>
            <tr class="border-b"><td class="py-3 font-medium">Status Code</td><td class="py-3" x-text="result.breakdown?.security?.status_code || '—'"></td></tr>
            <tr><td class="py-3 font-medium">Server Header</td><td class="py-3" x-text="result.breakdown?.security?.server || '—'"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- DYNAMIC CARDS & KV -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Dynamic Cards -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Dynamic Cards</h3>
        <template x-if="result.dynamic?.cards?.length">
          <div class="space-y-4">
            <template x-for="card in result.dynamic.cards" :key="card.title">
              <div class="p-4 bg-gray-50 rounded-xl">
                <h4 class="font-semibold text-gray-800" x-text="card.title"></h4>
                <p class="text-gray-700 mt-1" x-text="card.body"></p>
              </div>
            </template>
          </div>
        </template>
        <template x-if="!result.dynamic?.cards?.length">
          <p class="text-gray-500 italic">No dynamic cards available</p>
        </template>
      </div>

      <!-- Dynamic KV -->
      <div class="bg-white rounded-3xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Key-Value Data</h3>
        <template x-if="result.dynamic?.kv?.length">
          <table class="w-full text-sm border-collapse">
            <tbody>
              <template x-for="item in result.dynamic.kv" :key="item.key">
                <tr class="border-b last:border-0">
                  <td class="py-3 font-medium w-1/3" x-text="item.key"></td>
                  <td class="py-3" x-text="item.value"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </template>
        <template x-if="!result.dynamic?.kv?.length">
          <p class="text-gray-500 italic">No key-value data available</p>
        </template>
      </div>
    </div>

    <!-- PRIORITY ACTIONS -->
    <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-100">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Priority Recommendations</h2>
      <template x-if="result.priority_actions && result.priority_actions.length">
        <ul class="space-y-4">
          <template x-for="action in result.priority_actions" :key="action">
            <li class="flex items-start gap-4 p-4 bg-red-50 rounded-xl">
              <span class="text-red-500 text-2xl mt-1"><i class="fas fa-exclamation-triangle"></i></span>
              <p class="text-gray-800 text-lg" x-text="action"></p>
            </li>
          </template>
        </ul>
      </template>
      <template x-if="!result.priority_actions || !result.priority_actions.length">
        <p class="text-gray-600 italic text-lg">No priority actions detected.</p>
      </template>
    </div>

    <!-- DOWNLOAD PDF -->
    <div class="fixed bottom-8 right-8 z-50">
      <button @click="downloadPDF()" :disabled="!result || loading"
              class="flex items-center gap-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-10 py-5 rounded-full font-bold shadow-2xl hover:shadow-3xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fas fa-file-pdf text-xl"></i>
        Download Full PDF Report
      </button>
    </div>
  </div>

  <script>
    function auditApp() {
      return {
        progress: 0,
        status: "",
        result: null,
        ws: null,
        loading: false,
        scoreChart: null,

        async startAudit() {
          const url = document.getElementById('urlInput')?.value?.trim();
          if (!url || !/^https?:\/\//i.test(url)) return alert("Please enter a valid URL starting with http:// or https://");

          this.loading = true;
          this.progress = 5;
          this.status = "Connecting...";
          this.result = null;

          if (this.ws) this.ws.close();

          const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
          this.ws = new WebSocket(`${wsProtocol}//${location.host}/ws`);

          this.ws.onopen = () => {
            this.ws.send(JSON.stringify({ url }));
            this.status = "Audit started...";
          };

          this.ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            this.status = msg.status || "Processing";
            this.progress = msg.progress || this.progress;

            if (msg.status === "completed") {
              this.result = msg.result;
              this.progress = 100;
              this.loading = false;
              this.status = "Audit Complete!";
              this.ws.close();
              this.renderScoreChart();
            }

            if (msg.status === "error") {
              alert("Audit failed: " + (msg.payload?.error || "Unknown error"));
              this.progress = 0;
              this.loading = false;
              this.ws.close();
            }
          };

          this.ws.onerror = () => {
            alert("WebSocket connection failed. Please check your connection.");
            this.loading = false;
          };
        },

        renderScoreChart() {
          if (!this.result?.scores) return;

          const ctx = document.getElementById('scoreChart')?.getContext('2d');
          if (!ctx) return;

          if (this.scoreChart) this.scoreChart.destroy();

          this.scoreChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['SEO', 'Performance', 'Security', 'Links'],
              datasets: [{
                label: 'Score',
                data: [
                  this.result.scores.seo || 0,
                  this.result.scores.performance || 0,
                  this.result.scores.security || 0,
                  this.result.scores.links || 0
                ],
                backgroundColor: ['#6366f1', '#3b82f6', '#ef4444', '#10b981'],
                borderWidth: 0,
                borderRadius: 8,
                barPercentage: 0.7,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: { beginAtZero: true, max: 100, grid: { color: '#e5e7eb' } },
                x: { grid: { display: false } }
              },
              plugins: { legend: { display: false } }
            }
          });
        },

        async downloadPDF() {
          if (!this.result?.audited_url) return alert("No audit result available yet");

          try {
            const res = await fetch('/api/audit/pdf', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: this.result.audited_url })
            });

            if (!res.ok) throw new Error(await res.text());

            const blob = await res.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `FF-Tech-Audit-${new Date().toISOString().split('T')[0]}.pdf`;
            link.click();
          } catch (err) {
            alert("Failed to download PDF: " + err.message);
          }
        },

        newAudit() {
          this.result = null;
          this.progress = 0;
          this.status = "";
          this.loading = false;
          document.getElementById('urlInput').value = '';
          if (this.ws) this.ws.close();
        }
      }
    }
  </script>
</body>
</html>
