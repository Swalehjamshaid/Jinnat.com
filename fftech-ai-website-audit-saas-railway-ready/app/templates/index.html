{% extends 'base.html' %}
{% block content %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 1.5rem;
    }
    .gauge-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto;
    }
    .gauge-svg { transform: rotate(-90deg); }
    .gauge-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 10; }
    .gauge-progress {
        fill: none;
        stroke: #0d6efd;
        stroke-width: 10;
        stroke-linecap: round;
        stroke-dasharray: 440;
        stroke-dashoffset: 440;
        transition: stroke-dashoffset 1.5s ease-in-out;
    }
    .gauge-text {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
</style>

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card bg-body-tertiary shadow-sm border-0 mb-4">
            <div class="card-body p-4">
                <h4 class="card-title fw-bold"><i class="bi bi-cpu-fill text-primary me-2"></i>Open Access Audit</h4>
                <p class="text-secondary">Quickly audit any URL - no sign-in required.</p>
                
                <div class="input-group mb-4 shadow-sm">
                    <input id="openUrl" type="url" class="form-control border-0 bg-dark-subtle" placeholder="https://example.com" value="https://">
                    <button id="btnOpenAudit" class="btn btn-primary px-4 fw-bold">
                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <span id="btnText">Audit</span>
                    </button>
                </div>

                <div id="openResults" class="mt-4 d-none">
                    <h5 class="mb-4 border-bottom pb-2">Analysis Results</h5>
                    
                    <div class="row align-items-center mb-4">
                        <div class="col-md-5 text-center">
                            <div class="gauge-wrapper">
                                <svg width="150" height="150" class="gauge-svg">
                                    <circle class="gauge-bg" cx="75" cy="75" r="65"></circle>
                                    <circle id="gaugeCircle" class="gauge-progress" cx="75" cy="75" r="65"></circle>
                                </svg>
                                <div class="gauge-text">
                                    <div id="ovScore" class="h1 fw-bold mb-0">-</div>
                                    <small id="gradeText" class="text-primary fw-bold text-uppercase">Score</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-7">
                            <canvas id="breakdownChart" height="180"></canvas>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-secondary small text-uppercase fw-bold">Raw Audit Data</h6>
                        <pre id="openJson" class="small bg-black text-info p-3 rounded" style="max-height: 250px; overflow: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card bg-body-tertiary shadow-sm border-0 mb-4">
            <div class="card-body p-4">
                <h4 class="card-title fw-bold"><i class="bi bi-magic text-success me-2"></i>Passwordless Sign-in</h4>
                <form method="post" action="/request-login">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Work/Personal Email</label>
                        <input type="email" name="email" class="form-control bg-dark-subtle border-0" placeholder="name@company.com" required>
                    </div>
                    <button class="btn btn-success w-100 fw-bold py-2">Send Magic Link</button>
                </form>
                <div class="mt-4 p-3 rounded bg-info bg-opacity-10 border border-info border-opacity-25">
                    <p class="small text-secondary mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>Free users can run up to 10 audits; subscribe to unlock scheduling & history.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartInstance = null;

async function runAudit(url) {
    const btn = document.getElementById('btnOpenAudit');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const resultsDiv = document.getElementById('openResults');
    const jsonPre = document.getElementById('openJson');

    btn.disabled = true;
    btnText.textContent = 'Auditing...';
    btnSpinner.classList.remove('d-none');
    resultsDiv.classList.add('d-none');

    try {
        const response = await fetch('/api/open-audit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });

        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        // 1. Update Score Gauge
        const score = Math.round(data.overall_score);
        document.getElementById('ovScore').textContent = score;
        const offset = 440 - (440 * score) / 100;
        document.getElementById('gaugeCircle').style.strokeDashoffset = offset;
        
        // 2. Update breakdownChart (Radar is more comprehensive)
        const ctx = document.getElementById('breakdownChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['SEO', 'Performance', 'Coverage', 'Security', 'Accessibility'],
                datasets: [{
                    label: 'Website Score',
                    data: [
                        data.breakdown.onpage || 0,
                        data.breakdown.performance || 0,
                        data.breakdown.coverage || 0,
                        data.breakdown.best_practices || 80, // Fallback
                        data.breakdown.accessibility || 80   // Fallback
                    ],
                    backgroundColor: 'rgba(13, 110, 253, 0.2)',
                    borderColor: '#0d6efd',
                    borderWidth: 2
                }]
            },
            options: {
                scales: { r: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } },
                plugins: { legend: { display: false } }
            }
        });

        // 3. Populate JSON Preview (PRESERVED)
        jsonPre.textContent = JSON.stringify(data, null, 2);
        resultsDiv.classList.remove('d-none');

    } catch (error) {
        console.error('Audit failed:', error);
        alert('Audit failed. Please check the URL and your API keys.');
    } finally {
        btn.disabled = false;
        btnText.textContent = 'Audit';
        btnSpinner.classList.add('d-none');
    }
}

document.getElementById('btnOpenAudit').addEventListener('click', () => {
    const urlInput = document.getElementById('openUrl');
    if(urlInput.value.length > 5) runAudit(urlInput.value);
});
</script>
{% endblock %}
