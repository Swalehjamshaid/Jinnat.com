{% extends 'base.html' %}
{% block content %}
<style>
    :root {
        --glass-bg: rgba(15, 23, 42, 0.8);
        --accent-blue: #3b82f6;
        --accent-green: #10b981;
        --accent-purple: #8b5cf6;
        --border-color: rgba(255, 255, 255, 0.1);
    }

    /* Premium Glassmorphism UI */
    .dashboard-card { 
        background: var(--glass-bg); 
        backdrop-filter: blur(12px); 
        border: 1px solid var(--border-color); 
        border-radius: 24px; 
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .main-score-card {
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.15), transparent);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    /* AI Pulse Animation */
    .ai-pulse {
        width: 12px; height: 12px; background: var(--accent-green);
        border-radius: 50%; display: inline-block; margin-right: 8px;
        box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .prog-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
    .prog-fill { 
        height: 100%; width: 0%; 
        background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); 
        box-shadow: 0 0 15px var(--accent-blue);
        transition: width 0.5s ease; 
    }

    /* Cyber-style log */
    .scan-log { 
        background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px;
        font-family: 'Fira Code', monospace; font-size: 0.8rem; color: #a5b4fc;
        border-left: 3px solid var(--accent-blue);
    }

    #ovScore { font-size: 5rem; font-weight: 800; background: linear-gradient(to bottom, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .cat-card-premium {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .cat-card-premium:hover { background: rgba(255, 255, 255, 0.07); border-color: var(--accent-blue); transform: translateY(-8px); }

    .ai-insight-box {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 16px;
        padding: 20px;
        position: relative;
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-4">
        <div class="col-xl-8">
            <div class="dashboard-card p-5 h-100">
                <div class="d-flex align-items-center mb-4">
                    <div class="ai-pulse"></div>
                    <h2 class="fw-bold mb-0">Quantum Audit Engine</h2>
                </div>
                
                <div class="input-group input-group-lg mb-5 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                    <input id="openUrl" type="url" class="form-control bg-dark text-white border-0 ps-4" placeholder="Enter target URL for deep analysis...">
                    <button id="btnOpenAudit" class="btn btn-primary px-5 fw-bold" style="border-radius: 0 16px 16px 0;">INITIATE SCAN</button>
                </div>

                <div id="scanningSection" class="d-none">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="scanStatus" class="text-secondary fw-bold">Connecting to global node network...</span>
                            <span id="scanPercent" class="text-primary fw-bold">0%</span>
                        </div>
                        <div class="prog-track"><div id="scanFill" class="prog-fill"></div></div>
                    </div>
                    <div id="scanLog" class="scan-log mb-3">> SYSTEM READY. WAITING FOR URL...</div>
                </div>

                <div id="openResults" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-5">
                        <h3 class="fw-bold mb-0">Analysis Complete</h3>
                        <button id="btnDownloadPdf" class="btn btn-outline-light rounded-pill px-4">
                            <i class="fas fa-file-export me-2"></i> Export Intelligence
                        </button>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-5">
                            <div class="cat-card-premium main-score-card h-100 d-flex flex-column justify-content-center">
                                <span class="text-secondary text-uppercase fw-bold letter-spacing-2">Health Index</span>
                                <div id="ovScore">00</div>
                                <div id="ovGrade" class="badge rounded-pill bg-primary p-2 px-4 mt-2">OPTIMIZED</div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="cat-card-premium h-100">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="ai-insight-box mt-4 mb-4">
                        <h5 class="text-primary fw-bold mb-2"><i class="fas fa-robot me-2"></i>AI Executive Summary</h5>
                        <p id="aiSummaryText" class="text-secondary mb-0">Analyzing metrics to generate professional insights...</p>
                    </div>

                    <div id="categoryContainer" class="row g-3"></div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="dashboard-card p-4 h-100">
                <h4 class="fw-bold mb-4">Enterprise Access</h4>
                <div class="p-4 rounded-4" style="background: rgba(255,255,255,0.02); border: 1px dashed var(--border-color);">
                    <form method="post" action="/request-login">
                        <div class="mb-4">
                            <label class="form-label text-secondary small fw-bold">Corporate Identity</label>
                            <input type="email" name="email" class="form-control form-control-lg bg-dark text-white border-0" placeholder="name@company.com" required>
                        </div>
                        <button class="btn btn-success btn-lg w-100 fw-bold shadow-lg">AUTHENTICATE</button>
                    </form>
                    <hr class="my-4 opacity-10">
                    <ul class="list-unstyled small text-secondary">
                        <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> White-label PDF reporting</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i> Historical audit timeline</li>
                        <li><i class="fas fa-check-circle text-primary me-2"></i> Competitive ROI heatmaps</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let radarChart = null;

    document.getElementById('btnOpenAudit').onclick = async function() {
        const urlInput = document.getElementById('openUrl').value;
        if (!urlInput) return;

        // Transition UI
        this.disabled = true;
        document.getElementById('scanningSection').classList.remove('d-none');
        document.getElementById('openResults').classList.add('d-none');
        
        // Progress Logic
        updateLog("> Establishing secure connection to target...");
        simulateProgress(urlInput);
    };

    function updateLog(msg) {
        const log = document.getElementById('scanLog');
        log.innerHTML += `<br>> ${msg}`;
        log.scrollTop = log.scrollHeight;
    }

    async function simulateProgress(url) {
        let p = 0;
        const fill = document.getElementById('scanFill');
        const interval = setInterval(() => {
            p += Math.random() * 5;
            if(p >= 95) clearInterval(interval);
            fill.style.width = Math.min(p, 95) + '%';
            document.getElementById('scanPercent').innerText = Math.round(Math.min(p, 95)) + '%';
        }, 500);

        try {
            const response = await fetch('/api/open-audit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ url })
            });
            const data = await response.json();
            
            clearInterval(interval);
            fill.style.width = '100%';
            document.getElementById('scanPercent').innerText = '100%';
            
            setTimeout(() => {
                document.getElementById('scanningSection').classList.add('d-none');
                document.getElementById('openResults').classList.remove('d-none');
                renderResults(data);
            }, 800);
        } catch(e) {
            alert("Audit failed. Node unreachable.");
            location.reload();
        }
    }

    function renderResults(data) {
        document.getElementById('ovScore').innerText = Math.round(data.score);
        document.getElementById('aiSummaryText').innerText = data.ai_summary || "Audit optimized. No critical failures detected.";
        
        // Radar Chart - The "Best" Graph for Audits
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(radarChart) radarChart.destroy();
        
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Performance', 'SEO', 'Security', 'Connectivity', 'UX'],
                datasets: [{
                    label: 'Current Audit',
                    data: [data.score, 85, 90, 100, 75], // Mocking some for visual flair
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: '#3b82f6',
                    pointBackgroundColor: '#3b82f6',
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#94a3b8', font: { size: 12 } },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
</script>
{% endblock %}
