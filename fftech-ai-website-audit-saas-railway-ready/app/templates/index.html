<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FF Tech Audit Engine v5.0 (Auto‑Adaptive)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --gold:#ffd700; --muted:#9ca3af; --panel:rgba(17,24,39,0.92); }
    body {
      background: radial-gradient(circle at top right, #1e293b, #0a0e17);
      color: #e5e7eb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height: 100vh;
    }
    .card-glass {
      background: var(--panel);
      border: 1px solid rgba(255, 215, 0, 0.16);
      border-radius: 1.25rem;
      padding: 1.4rem;
      backdrop-filter: blur(10px);
    }
    .metric-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,215,0,0.10);
      border-radius: 0.85rem;
      padding: 0.9rem;
      text-align: center;
      height: 100%;
    }
    .metric-value {
      font-size: 2.1rem;
      font-weight: 800;
      color: var(--gold);
    }
    .metric-label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #loadingOverlay {
      position: fixed; inset: 0; background: rgba(10,14,23,0.97);
      display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999;
    }
    #loadingOverlay.show { display: flex; }
    #auditLog {
      white-space: pre-wrap; word-break: break-word; max-height: 420px; overflow-y: auto;
      background: rgba(0,0,0,0.45); padding: 1rem; border-radius: 0.75rem; border: 1px solid #444;
      font-size: 0.9rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    #autoCharts .chart-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,215,0,0.10);
      border-radius: 0.85rem;
      padding: 1rem;
      height: 100%;
    }
    .badge-soft {
      background: rgba(255,215,0,0.1);
      color: var(--gold);
      border: 1px solid rgba(255,215,0,0.2);
    }
    .json-view { font-size: .85rem; color: #d1d5db; }
    details summary { cursor: pointer; }
    .kv-table td { padding: .2rem .4rem; border-bottom: 1px dashed rgba(255,215,0,.18); }
    .theme-toggle { cursor:pointer; }
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="spinner-border text-warning mb-4" style="width:3.5rem;height:3.5rem;"></div>
  <h4 id="statusLabel" class="mb-3">Initializing Audit Engine...</h4>
  <div class="progress w-75" style="height:8px;max-width:500px;">
    <div id="loadingBar" class="progress-bar bg-warning" style="width:5%"></div>
  </div>
</div>

<div class="container py-5">
  <div class="d-flex flex-wrap align-items-end justify-content-between mb-4">
    <div class="d-flex align-items-center gap-3">
      <h1 class="fw-bold text-warning m-0">FF Tech Audit Engine <span class="fw-light fs-4">v5.0</span></h1>
      <span id="themeToggle" class="theme-toggle text-warning" title="Toggle theme">
        <i class="bi bi-sun"></i>
      </span>
    </div>
    <div class="d-flex gap-2 mt-3 mt-md-0">
      <button id="btnDownload" class="btn btn-outline-warning">
        <i class="bi bi-file-earmark-pdf"></i> Export PDF
      </button>
      <button id="btnCopyJSON" class="btn btn-outline-info">
        <i class="bi bi-braces-asterisk"></i> Copy JSON
      </button>
      <button id="btnReset" class="btn btn-outline-danger">
        <i class="bi bi-arrow-repeat"></i> Reset
      </button>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card-glass" id="printableArea">
        <!-- URL INPUT -->
        <div class="input-group input-group-lg mb-4">
          <span class="input-group-text bg-dark text-warning border-secondary">
            <i class="bi bi-globe"></i>
          </span>
          <input id="urlInput" class="form-control bg-dark text-white border-secondary"
                 placeholder="example.com or https://www.example.com" autofocus>
          <button id="btnRun" class="btn btn-warning fw-bold px-5">RUN AUDIT</button>
        </div>

        <!-- SUMMARY HEADER -->
        <div id="resultsPanel" class="d-none">
          <div class="text-center mb-4">
            <h1 id="ovScore" class="display-2 fw-black text-warning">—</h1>
            <h4 id="gradeDisplay" class="text-muted">GRADE: —</h4>
            <div id="competitorBadges" class="mt-3"></div>
          </div>

          <!-- DYNAMIC METRICS GRID -->
          <div id="metricsGrid" class="row g-3 mb-4 text-center">
            <!-- Cards auto-injected here -->
          </div>

          <!-- CHARTS (auto) -->
          <div id="autoCharts" class="row g-4 mb-4">
            <!-- Chart canvases auto-injected here -->
          </div>

          <!-- LINKS & TABLES -->
          <div class="row g-4">
            <div class="col-md-6">
              <div class="p-3 bg-dark rounded border border-secondary small h-100">
                <h6 class="text-warning mb-3"><i class="bi bi-link-45deg"></i> Links Overview</h6>
                <div class="d-flex justify-content-between mb-1"><span>Internal Links:</span><span id="intCount">—</span></div>
                <div class="d-flex justify-content-between mb-1"><span>External Links:</span><span id="extCount">—</span></div>
                <div class="d-flex justify-content-between mb-1"><span>Warning Links:</span><span id="warnCount">—</span></div>
                <div class="d-flex justify-content-between"><span>Broken Links:</span><span id="brkCount" class="text-danger">—</span></div>
                <div id="linksKvWrap" class="mt-3"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-3 bg-dark rounded border border-secondary small h-100">
                <h6 class="text-warning mb-3"><i class="bi bi-people"></i> Top Competitors</h6>
                <div id="compNamesWrap" class="mb-2"></div>
                <div class="table-responsive">
                  <table class="table table-dark table-sm align-middle mb-0" id="compTable">
                    <thead><tr><th>Name</th><th class="text-end">Score</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div id="compLegend" class="text-muted small mt-2"></div>
              </div>
            </div>
          </div>

          <!-- AUTO SECTIONS (render any new structures from backend) -->
          <div id="autoSections" class="mt-4"></div>

          <!-- RAW JSON VIEW -->
          <div class="mt-4">
            <details open>
              <summary class="text-warning h6">Payload (raw JSON)</summary>
              <pre id="jsonRaw" class="json-view bg-dark p-3 rounded border border-secondary mt-2" style="max-height:360px;overflow:auto;">—</pre>
            </details>
          </div>
        </div>
      </div>
    </div>

    <!-- LIVE LOG -->
    <div class="col-lg-4">
      <div class="card-glass h-100">
        <h6 class="text-warning mb-3">Live Audit Log</h6>
        <div id="auditLog" class="small text-secondary mt-3">&gt; Engine ready. Enter URL and click RUN AUDIT</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Utilities (schema-less core)
   =========================== */
let chartInstances = [];
let lastPayload = null;

const q = (sel) => document.querySelector(sel);
const el = (tag, cls, html) => { const x = document.createElement(tag); if (cls) x.className = cls; if (html!=null) x.innerHTML = html; return x; };
const asInt = (v, d=0) => { const n = Number(v); return Number.isFinite(n) ? Math.round(n) : d; };
const clamp = (n, a, b) => Math.min(Math.max(n, a), b);
const titleize = (s) => (s||'').replaceAll('_',' ').replace(/\b\w/g, m => m.toUpperCase());

function deepMerge(target, source) {
  if (!source || typeof source !== 'object') return target;
  Object.keys(source).forEach(k => {
    const sv = source[k];
    const tv = target[k];
    if (Array.isArray(sv)) target[k] = sv.slice();
    else if (sv && typeof sv === 'object') target[k] = deepMerge(tv && typeof tv==='object' ? tv : {}, sv);
    else target[k] = sv;
  });
  return target;
}

function getFirstScore(obj) {
  if (obj == null) return null;
  if (typeof obj === 'number') return asInt(obj);
  if (typeof obj === 'object') {
    for (const k of ['score','value','overall','total','points']) {
      if (obj[k] != null) return asInt(obj[k]);
    }
    if (Array.isArray(obj)) {
      for (const it of obj) {
        const v = getFirstScore(it);
        if (v != null) return v;
      }
    }
  }
  return null;
}

function collectNumericMetrics(obj, prefix='', out=[]) {
  if (!obj || typeof obj !== 'object') return out;
  if (Array.isArray(obj)) {
    obj.forEach((it, i) => collectNumericMetrics(it, `${prefix}[${i}]`, out));
    return out;
  }
  for (const [k, v] of Object.entries(obj)) {
    const key = prefix ? `${prefix}.${k}` : k;
    if (typeof v === 'number') out.push({label:key, value:v});
    else if (typeof v === 'object' && v) {
      const s = getFirstScore(v);
      if (s != null) out.push({label:key, value:s});
      // continue exploring to find more numbers
      collectNumericMetrics(v, key, out);
    }
  }
  return out;
}

function log(msg, isError=false) {
  const logEl = q("#auditLog");
  const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  const entry = el("div", null, `[${time}] ${msg}`);
  entry.style.color = isError ? "#ef4444" : "#9ca3af";
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

/* JSON Viewer */
function renderJSON(target, obj) {
  try { target.textContent = JSON.stringify(obj, null, 2); }
  catch { target.textContent = String(obj); }
}

/* Destroy charts safely */
function clearCharts() {
  chartInstances.forEach(c => { try { c.destroy(); } catch{} });
  chartInstances = [];
}

/* Color helpers */
const palette = [
  "rgba(255, 215, 0, 0.8)", "rgba(59, 130, 246, 0.8)", "rgba(16, 185, 129, 0.8)",
  "rgba(147, 51, 234, 0.8)", "rgba(244, 63, 94, 0.8)", "rgba(234, 179, 8, 0.8)"
];
const paletteBorder = [
  "rgba(255, 215, 0, 1)", "rgba(59, 130, 246, 1)", "rgba(16, 185, 129, 1)",
  "rgba(147, 51, 234, 1)", "rgba(244, 63, 94, 1)", "rgba(234, 179, 8, 1)"
];
function colorAt(i){ return {bg: palette[i % palette.length], bd: paletteBorder[i % paletteBorder.length]}; }

/* Guess chart type by key/name */
function guessChartType(key, dataObj) {
  const k = (key||'').toLowerCase();
  if (dataObj && typeof dataObj.type === 'string') return dataObj.type;
  if (k.includes('doughnut')) return 'doughnut';
  if (k.includes('radar')) return 'radar';
  if (k.includes('line')) return 'line';
  if (k.includes('pie')) return 'pie';
  if (k.includes('bar')) return 'bar';
  return 'bar';
}

/* ===========================
   Renderers
   =========================== */
function renderCompetitors(competitors) {
  const badgeWrap = q('#competitorBadges');
  badgeWrap.innerHTML = '';

  // Names badge row (primary)
  const names = Array.isArray(competitors?.names) ? competitors.names : [];
  names.forEach(n => {
    const b = el('span', 'badge badge-soft me-1 mb-1', `<i class="bi bi-trophy me-1"></i>${n}`);
    b.style.padding = '0.45rem 0.6rem';
    badgeWrap.appendChild(b);
  });

  // Names wrap above table for any string array fallback
  const compNamesWrap = q('#compNamesWrap');
  compNamesWrap.innerHTML = '';
  if (names.length) compNamesWrap.appendChild(el('div','small text-muted', 'Detected Competitors: ' + names.join(', ')));

  // Table (items with scores) + fallbacks
  const tbody = q('#compTable tbody');
  tbody.innerHTML = '';
  const items = Array.isArray(competitors?.items) ? competitors.items : [];
  if (items.length) {
    items.slice(0, 6).forEach((it, i) => {
      const tr = el('tr');
      tr.appendChild(el('td', null, String(it.name ?? `Item ${i+1}`)));
      const score = getFirstScore(it);
      tr.appendChild(el('td', 'text-end', score != null ? String(score) : '—'));
      tbody.appendChild(tr);
    });
  } else if (Array.isArray(competitors)) {
    // pure array fallback e.g., ["LG","Samsung",...]
    competitors.slice(0, 6).forEach((v, i) => {
      const tr = el('tr');
      tr.appendChild(el('td', null, typeof v === 'string' ? v : `Item ${i+1}`));
      tr.appendChild(el('td', 'text-end', typeof v === 'number' ? String(v) : '—'));
      tbody.appendChild(tr);
    });
  } else {
    const tr = el('tr');
    tr.appendChild(el('td', 'text-muted', '—'));
    tr.appendChild(el('td', 'text-end text-muted', '—'));
    tbody.appendChild(tr);
  }

  // Legend/footer showing legacy score if present
  const legacy = competitors?.top_competitor_score ?? null;
  q('#compLegend').textContent = (legacy != null) ? `Legacy top competitor score: ${legacy}` : '';
}

function renderMetricsGrid(breakdown) {
  const grid = q('#metricsGrid');
  grid.innerHTML = '';
  const metrics = collectNumericMetrics(breakdown || {});
  // Prefer human-friendly top-level keys
  // rank by occurrence & recentness, then limit
  const seen = new Set();
  const unique = metrics.filter(m => (seen.has(m.label) ? false : seen.add(m.label)));
  const top = unique
    .filter(m => !/extras|items|names|links|chart|json|payload/i.test(m.label))
    .slice(0, 12); // show up to 12 metric cards

  (top.length ? top : [{label:'SEO',value:0},{label:'Performance',value:0},{label:'Competitors',value:0},{label:'AI',value:95}])
    .forEach(m => {
      const col = el('div', 'col-6 col-md-3');
      const box = el('div', 'metric-box');
      box.appendChild(el('div', 'metric-label', titleize(m.label.split('.').pop())));
      box.appendChild(el('div', 'metric-value', String(asInt(m.value))));
      col.appendChild(box);
      grid.appendChild(col);
    });
}

function kvTable(obj) {
  const tbl = el('table', 'table table-dark table-sm kv-table mb-0');
  const tb = el('tbody');
  Object.entries(obj || {}).forEach(([k,v]) => {
    if (['internal_links_count','external_links_count','warning_links_count','broken_internal_links'].includes(k)) return;
    const tr = el('tr');
    tr.appendChild(el('td', 'text-muted', titleize(k)));
    tr.appendChild(el('td', 'text-end', typeof v === 'object' ? `<code>${JSON.stringify(v)}</code>` : String(v)));
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  return tbl;
}

function renderLinks(links) {
  q('#intCount').textContent  = links?.internal_links_count ?? '0';
  q('#extCount').textContent  = links?.external_links_count ?? '0';
  q('#warnCount').textContent = links?.warning_links_count ?? '0';
  q('#brkCount').textContent  = links?.broken_internal_links ?? '0';

  const wrap = q('#linksKvWrap');
  wrap.innerHTML = '';
  const others = Object.assign({}, links);
  delete others.internal_links_count; delete others.external_links_count;
  delete others.warning_links_count; delete others.broken_internal_links;
  if (Object.keys(others).length) wrap.appendChild(kvTable(others));
}

function normalizeToChartData(key, src) {
  // Already Chart.js shape?
  if (src && typeof src === 'object' && Array.isArray(src.datasets)) return src;

  // Object map => pie-like
  if (src && typeof src === 'object' && !Array.isArray(src)) {
    const labels = Object.keys(src);
    const data = labels.map(k => asInt(src[k], 0));
    const colors = labels.map((_,i)=>colorAt(i));
    return {
      labels,
      datasets: [{ label: titleize(key), data, backgroundColor: colors.map(c=>c.bg), borderColor: colors.map(c=>c.bd), borderWidth:1 }]
    };
  }

  // Array of numbers => index labels
  if (Array.isArray(src) && src.every(x => typeof x === 'number')) {
    const labels = src.map((_,i)=> String(i+1));
    const colors = labels.map((_,i)=>colorAt(i));
    return {
      labels,
      datasets: [{ label: titleize(key), data: src, backgroundColor: colors.map(c=>c.bg), borderColor: colors.map(c=>c.bd), borderWidth:1 }]
    };
  }

  // Array of objects with {label, value}
  if (Array.isArray(src) && src.every(x => typeof x === 'object')) {
    const labels = src.map(x => String(x.label ?? x.name ?? 'Item'));
    const data   = src.map(x => asInt(x.value ?? getFirstScore(x) ?? 0));
    const colors = labels.map((_,i)=>colorAt(i));
    return {
      labels,
      datasets: [{ label: titleize(key), data, backgroundColor: colors.map(c=>c.bg), borderColor: colors.map(c=>c.bd), borderWidth:1 }]
    };
  }

  // Fallback
  return null;
}

function renderCharts(chart_data) {
  clearCharts();
  const wrap = q('#autoCharts');
  wrap.innerHTML = '';

  if (!chart_data || typeof chart_data !== 'object') return;

  Object.entries(chart_data).forEach(([key, dataObj], idx) => {
    const normalized = normalizeToChartData(key, dataObj) || dataObj;
    if (!normalized || typeof normalized !== 'object' || !Array.isArray(normalized.datasets)) return;

    const col = el('div', 'col-md-6');
    const card = el('div', 'chart-card');
    const title = el('div', 'text-warning small mb-2', `<i class="bi bi-graph-up"></i> ${titleize(key)}`);
    const canvas = el('canvas');
    card.appendChild(title);
    card.appendChild(canvas);
    col.appendChild(card);
    wrap.appendChild(col);

    const type = guessChartType(key, dataObj);
    try {
      const inst = new Chart(canvas.getContext('2d'), {
        type,
        data: normalized,
        options: Object.assign(
          { responsive:true, plugins:{legend:{display:true}}, scales: {} },
          (type === 'bar' || type === 'line') ? { scales:{ y:{ beginAtZero:true } } } : {}
        )
      });
      chartInstances.push(inst);
    } catch (e) {
      const err = el('div','text-danger small mt-2','Chart render failed, showing raw data');
      card.appendChild(err);
      const pre = el('pre','json-view bg-dark p-2 rounded border border-secondary mt-2');
      renderJSON(pre, dataObj);
      card.appendChild(pre);
    }
  });
}

function renderAutoSections(payload) {
  const host = q('#autoSections');
  host.innerHTML = '';
  const breakdown = payload?.breakdown || {};

  Object.entries(breakdown).forEach(([key, val]) => {
    if (['links','performance','competitors'].includes(key)) return;
    if (val && typeof val === 'object') {
      const card = el('div', 'card-glass mb-3');
      card.appendChild(el('h6', 'text-warning', titleize(key)));
      const pre = el('pre', 'json-view bg-dark p-3 rounded border border-secondary', '');
      pre.style.maxHeight = '280px';
      pre.style.overflow = 'auto';
      renderJSON(pre, val);
      card.appendChild(pre);
      host.appendChild(card);
    }
  });

  if (payload?.extras) {
    const card = el('div', 'card-glass mb-3');
    card.appendChild(el('h6', 'text-warning', 'Extras'));
    const pre = el('pre', 'json-view bg-dark p-3 rounded border border-secondary', '');
    pre.style.maxHeight = '280px';
    pre.style.overflow = 'auto';
    renderJSON(pre, payload.extras);
    card.appendChild(pre);
    host.appendChild(card);
  }
}

function renderPayload(r) {
  // Header
  q('#ovScore').textContent      = r.overall_score ?? '—';
  q('#gradeDisplay').textContent = `GRADE: ${r.grade ?? '—'}`;

  // Breakdown
  const breakdown = r.breakdown || {};

  renderMetricsGrid(breakdown);
  renderCompetitors(breakdown?.competitors || {});
  renderLinks(breakdown?.links || {});

  // Charts
  renderCharts(r.chart_data);

  // Raw JSON
  renderJSON(q('#jsonRaw'), r);
}

/* ===========================
   WS + Controls + Fallbacks
   =========================== */
const statusEl   = q("#statusLabel");
const loadingBar = q("#loadingBar");
const overlay    = q("#loadingOverlay");
const results    = q("#resultsPanel");

async function startOver(url) {
  overlay.classList.add("show");
  results.classList.add("d-none");
  q("#auditLog").innerHTML = "&gt; Starting new audit sequence...";
  statusEl.textContent = "Connecting to FF Engine...";
  loadingBar.style.width = "5%";

  const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
  let ws;

  try {
    ws = new WebSocket(`${wsProtocol}//${location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`);
  } catch {
    log("WebSocket not supported, consider HTTP fallback.", true);
  }

  if (ws) {
    ws.onopen = () => { log("Connection established"); statusEl.textContent = "Engine initialized..."; };
    ws.onmessage = (e) => onMessage(e.data);
    ws.onerror = () => onWsError(url);
    ws.onclose = () => {};
  } else {
    onWsError(url);
  }
}

function onWsError(url) {
  log("WS connection failed. You can wire an HTTP fallback here.", true);
  overlay.classList.remove("show");
  alert("Audit Engine Connection Failed. Ensure backend is running.");
  // OPTIONAL: implement fetch-based start + poll here if you expose REST endpoints.
  // Example:
  // fetch(`/api/run-audit?url=${encodeURIComponent(url)}`).then(r=>r.json()).then(({job_id}) => poll(job_id));
}

function onMessage(raw) {
  try {
    const r = JSON.parse(raw);

    if (r.status) { statusEl.textContent = r.status; log(r.status); }
    if (r.crawl_progress != null) loadingBar.style.width = clamp(r.crawl_progress, 0, 100) + "%";
    if (r.error) log(r.error, true);

    // Handle partial progressive updates (deep merge)
    if (r.partial) {
      lastPayload = deepMerge(lastPayload || {}, r);
      results.classList.remove("d-none");
      renderPayload(lastPayload);
      return;
    }

    if (r.finished) {
      overlay.classList.remove("show");
      results.classList.remove("d-none");
      lastPayload = r; // keep the final one
      renderPayload(r);
      log("Audit complete. Data synchronized.");
    }
  } catch(err) { log("Data handling error: " + err.message, true); }
}

/* Controls */
q("#btnRun").onclick = () => {
  let url = q("#urlInput").value.trim();
  if (!url) return alert("Please enter a URL");
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  localStorage.setItem('ff_audit_last_url', url);
  startOver(url);
};

q("#btnReset").onclick = () => {
  results.classList.add("d-none");
  q("#urlInput").value = "";
  q("#auditLog").innerHTML = "&gt; Results cleared. Ready.";
  q("#urlInput").focus();
  clearCharts();
  lastPayload = null;
};

q("#btnDownload").onclick = async () => {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const node = document.getElementById("printableArea");
    const canvas = await html2canvas(node, {scale: 2});
    const imgData = canvas.toDataURL("image/png");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const ratio = canvas.width / canvas.height;
    const imgWidth = pageWidth;
    const imgHeight = imgWidth / ratio;

    let y = 0;
    if (imgHeight <= pageHeight) {
      doc.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
    } else {
      // paginate tall content
      let remaining = imgHeight;
      let position = 0;
      const canvasPage = document.createElement('canvas');
      const ctx = canvasPage.getContext('2d');
      const pageCanvasHeight = Math.floor(canvas.width * (pageHeight / pageWidth));
      canvasPage.width = canvas.width;
      canvasPage.height = pageCanvasHeight;

      while (remaining > 0) {
        ctx.clearRect(0, 0, canvasPage.width, canvasPage.height);
        ctx.drawImage(canvas, 0, position, canvas.width, pageCanvasHeight, 0, 0, canvasPage.width, canvasPage.height);
        const pageData = canvasPage.toDataURL('image/png');
        doc.addImage(pageData, 'PNG', 0, 0, pageWidth, pageHeight);
        remaining -= pageHeight;
        position += pageCanvasHeight;
        if (remaining > 0) doc.addPage();
      }
    }

    doc.save(`audit-report-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
    log("Report exported to PDF.");
  } catch(err) { log("PDF error: " + err.message, true); }
};

q("#btnCopyJSON").onclick = async () => {
  try {
    const text = q('#jsonRaw').textContent || '';
    await navigator.clipboard.writeText(text);
    log("Payload JSON copied to clipboard.");
  } catch (e) {
    log("Clipboard error: " + e.message, true);
  }
};

/* Theme toggle */
q('#themeToggle').onclick = () => {
  const html = document.documentElement;
  const cur = html.getAttribute('data-bs-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-bs-theme', next);
  localStorage.setItem('ff_theme', next);
};

/* Boot: restore URL/theme and autorun via ?url= */
(function boot(){
  const savedUrl = localStorage.getItem('ff_audit_last_url');
  if (savedUrl) q('#urlInput').value = savedUrl;
  const savedTheme = localStorage.getItem('ff_theme');
  if (savedTheme) document.documentElement.setAttribute('data-bs-theme', savedTheme);

  const params = new URLSearchParams(location.search);
  const url = params.get('url');
  if (url) {
    q('#urlInput').value = url;
    startOver(/^https?:\/\//i.test(url) ? url : ('https://' + url));
  }
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
