<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FF Tech Audit – Professional Website Auditor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --glass: rgba(17, 24, 39, 0.85);
      --border: rgba(255, 215, 0, 0.2);
      --gold: #ffd700;
      --gold-dark: #d4af37;
    }
    body { background: linear-gradient(135deg, var(--bg) 0%, var(--card) 100%); color: #e2e8f0; min-height:100vh; font-family:'Inter', system-ui, sans-serif; }
    .main-container { max-width: 1300px; margin: 0 auto; padding: 4rem 1rem; }
    .header-title { font-size:3.5rem; font-weight:800; background:linear-gradient(90deg, var(--gold), #fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:2.5rem; text-align:center; }
    .card-glass { background: var(--glass); border:1px solid var(--border); backdrop-filter: blur(15px); border-radius:1.5rem; padding:2.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
    #loadingOverlay { position: fixed; inset:0; background: rgba(10,14,23,0.95); color: var(--gold); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999; transition: opacity 0.3s ease; }
    #loadingOverlay.show { display:flex; opacity:1; }
    .metric-box { background: rgba(255,255,255,0.03); border:1px solid rgba(255,215,0,0.1); border-radius:1rem; padding:1.5rem; text-align:center; transition:0.3s; }
    .metric-box:hover { border-color: var(--gold); transform: translateY(-5px); }
    .metric-value { font-size:2.5rem; font-weight:800; color: var(--gold); }
    .metric-label { font-size:0.9rem; color:#9ca3af; text-transform:uppercase; letter-spacing:1px; }
    .chart-container { background: rgba(255,255,255,0.02); border-radius:1rem; padding:1.5rem; margin-bottom:2rem; }
    .btn-gold { background: linear-gradient(90deg, var(--gold), var(--gold-dark)); border:none; color:#000; font-weight:700; }
    .btn-gold:hover { opacity:0.9; transform: scale(1.02); }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
    .badge-soft { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.3); color: #ffd700; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-warning mb-4" style="width:4rem;height:4rem;"></div>
  <h3 id="statusLabel">Initializing Engine...</h3>
  <div class="w-50 mt-3">
    <div class="progress" style="height:10px;">
      <div id="loadingBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width:5%"></div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastArea"></div>

<div class="main-container">
  <h1 class="header-title">Audit Engine <span style="font-weight:300;">v4.2</span></h1>

  <div class="row g-4">
    <!-- Left Panel -->
    <div class="col-lg-8">
      <div class="card-glass" id="printableArea">
        <div class="input-group input-group-lg mb-3 no-print">
          <span class="input-group-text bg-dark border-secondary text-warning"><i class="bi bi-globe"></i></span>
          <input id="urlInput" type="url" class="form-control bg-dark text-white border-secondary" placeholder="https://example.com">
          <button id="btnRun" class="btn btn-gold px-5">START AUDIT</button>
        </div>

        <div class="no-print mb-4">
          <span class="badge badge-soft rounded-pill px-3 py-2" id="envHint">Tip: set PSI_API_KEY in server env to enable LCP (Perf).</span>
        </div>

        <div id="resultsPanel" class="d-none">
          <div class="text-center mb-5">
            <div class="d-inline-block p-4 rounded-circle border border-warning mb-3">
              <h2 id="ovScore" class="display-2 fw-bold mb-0" style="color: var(--gold);">0</h2>
            </div>
            <h3 id="gradeDisplay" class="fw-bold">GRADE: —</h3>
            <p class="text-muted">Comprehensive AI Analysis Report</p>
            <button id="btnDownload" class="btn btn-sm btn-outline-warning mt-2 no-print">
              <i class="bi bi-file-earmark-pdf me-2"></i>Download Report
            </button>
          </div>

          <div class="row g-3 mb-5">
            <div class="col-md-3">
              <div class="metric-box">
                <div class="metric-label">On-Page SEO</div>
                <div id="onpageScore" class="metric-value">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box">
                <div class="metric-label">Perf (LCP)</div>
                <div id="perfScore" class="metric-value">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box">
                <div class="metric-label">Competitors</div>
                <div id="coverageScore" class="metric-value">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box">
                <div class="metric-label">AI Confidence</div>
                <div id="confScore" class="metric-value">0</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-7">
              <div class="chart-container">
                <canvas id="mainChart" height="250"></canvas>
              </div>
            </div>
            <div class="col-md-5">
              <div class="chart-container">
                <canvas id="radarChart" height="250"></canvas>
              </div>
              <div class="mt-3 p-3 bg-dark rounded border border-secondary">
                <div class="d-flex justify-content-between mb-2">
                  <span>Internal Links:</span> <strong id="intCount" class="text-success">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>External Links:</span> <strong id="extCount" class="text-primary">0</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Broken Links:</span> <strong id="brkCount" class="text-danger">0</strong>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- /resultsPanel -->
      </div>
    </div>

    <!-- Right Panel -->
    <div class="col-lg-4">
      <div class="card-glass h-100">
        <h4 class="text-warning mb-4"><i class="bi bi-shield-lock me-2"></i>Account Access</h4>
        <div class="mb-4">
          <label class="small text-muted mb-2">Email Address</label>
          <input type="email" class="form-control bg-dark text-white border-secondary mb-3" placeholder="user@company.com">
          <button class="btn btn-outline-warning w-100">Send Magic Link</button>
        </div>
        <hr class="border-secondary">
        <p class="small text-muted">FF Tech Engine v4.2 uses 128-bit encryption for report storage and AI-driven performance heuristics.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* -----------------------
   Helpers / UI utilities
------------------------*/
function showToast(message, type = 'warning') {
  const id = 't' + Date.now();
  const bg = type === 'error' ? 'bg-danger' : (type === 'success' ? 'bg-success' : 'bg-warning text-dark');
  const el = document.createElement('div');
  el.className = `toast align-items-center ${bg} border-0 show mb-2`;
  el.id = id;
  el.setAttribute('role','alert');
  el.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="document.getElementById('${id}').remove()"></button>
    </div>`;
  document.getElementById('toastArea').appendChild(el);
  setTimeout(() => el.remove(), 6000);
}

function formatPerf(lcpMs) {
  const n = Number(lcpMs || 0);
  if (n >= 1000) return (n/1000).toFixed(1) + 's';
  return Math.max(0, Math.round(n)) + 'ms';
}

/* -----------------------
   Charts
------------------------*/
let charts = {};
function initCharts(data) {
  const safeBar = (data?.chart_data?.bar) || { labels: ["SEO","Links","Perf","AI"], data: [0,0,0,90] };
  const safeRadar = (data?.chart_data?.radar) || { labels: ["SEO","Links","Perf","AI"], data: [0,0,0,90] };

  if (charts.bar) { charts.bar.destroy(); }
  charts.bar = new Chart(document.getElementById('mainChart'), {
    type: 'bar',
    data: {
      labels: safeBar.labels,
      datasets: [{
        label: 'Metrics',
        data: safeBar.data,
        backgroundColor:['#ffd700','#3b82f6','#10b981','#ef4444']
      }]
    },
    options: {
      plugins:{ legend:{ display:false } },
      scales:{ y:{ max:100, beginAtZero:true } }
    }
  });

  if (charts.radar) { charts.radar.destroy(); }
  charts.radar = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: safeRadar.labels,
      datasets:[{
        label:'Profile',
        data: safeRadar.data,
        borderColor:'#ffd700',
        backgroundColor:'rgba(255,215,0,0.2)'
      }]
    },
    options:{ scales:{ r:{ max:100, beginAtZero:true, ticks:{ display:false } } } }
  });
}

/* -----------------------
   Audit Flow
------------------------*/
let ws = null;
let isRunning = false;

function startAudit() {
  const urlInput = document.getElementById('urlInput');
  const url = (urlInput.value || '').trim();
  if (!url) {
    showToast('Please enter a URL to audit.', 'warning');
    urlInput.focus();
    return;
  }
  if (isRunning) return;

  isRunning = true;
  const btn = document.getElementById('btnRun');
  btn.disabled = true;
  btn.innerText = 'RUNNING...';

  const overlay = document.getElementById('loadingOverlay');
  const statusLabel = document.getElementById('statusLabel');
  const loadingBar = document.getElementById('loadingBar');

  overlay.classList.add('show');
  document.getElementById('resultsPanel').classList.add('d-none');
  statusLabel.innerText = 'Starting...';
  loadingBar.style.width = '5%';

  // Construct WS url (supports http/https)
  const useSecure = window.location.protocol === 'https:';
  const protocol = useSecure ? 'wss:' : 'ws:';
  const wsURL = `${protocol}//${window.location.host}/ws/audit-progress?url=${encodeURIComponent(url)}`;

  try {
    ws = new WebSocket(wsURL);
  } catch (err) {
    showToast('Unable to open WebSocket: ' + (err?.message || err), 'error');
    overlay.classList.remove('show');
    btn.disabled = false; btn.innerText = 'START AUDIT';
    isRunning = false;
    return;
  }

  ws.onopen = () => {
    statusLabel.innerText = 'Connected. Crawling...';
  };

  ws.onmessage = (event) => {
    let res = {};
    try { res = JSON.parse(event.data); } catch (e) {}

    if (res?.error) {
      showToast('Audit error: ' + res.error, 'error');
    }
    if (typeof res.status === 'string') {
      statusLabel.innerText = res.status;
    }
    if (typeof res.crawl_progress === 'number') {
      const pct = Math.max(0, Math.min(100, Math.round(res.crawl_progress)));
      loadingBar.style.width = pct + '%';
    }

    if (res.finished) {
      overlay.classList.remove('show');
      document.getElementById('resultsPanel').classList.remove('d-none');

      const overall = Number(res.overall_score ?? 0);
      const grade = res.grade ?? 'N/A';
      const bd = res.breakdown || {};

      const seo = Number(bd.seo ?? 0);
      const lcp = Number((bd.performance || {}).lcp_ms ?? 0);
      const comp = Number((bd.competitors || {}).top_competitor_score ?? 0);
      const links = (bd.links || {});
      const internalC = Number(links.internal_links_count ?? 0);
      const externalC = Number(links.external_links_count ?? 0);
      const brokenC = Number(links.broken_internal_links ?? 0);

      document.getElementById('ovScore').innerText = isFinite(overall) ? overall : 0;
      document.getElementById('gradeDisplay').innerText = `GRADE: ${grade}`;
      document.getElementById('onpageScore').innerText = isFinite(seo) ? seo : 0;
      document.getElementById('perfScore').innerText = formatPerf(lcp);
      document.getElementById('coverageScore').innerText = isFinite(comp) ? comp : 0;
      document.getElementById('confScore').innerText = (res.chart_data?.bar?.data?.[3] ?? 90);

      document.getElementById('intCount').innerText = isFinite(internalC) ? internalC : 0;
      document.getElementById('extCount').innerText = isFinite(externalC) ? externalC : 0;
      document.getElementById('brkCount').innerText = isFinite(brokenC) ? brokenC : 0;

      initCharts(res);

      // finalize
      try { ws.close(); } catch (_) {}
      ws = null;
      isRunning = false;
      btn.disabled = false; btn.innerText = 'START AUDIT';

      // Informational tip when PSI is likely missing
      if (!lcp || lcp === 0) {
        document.getElementById('envHint').innerText = 'Perf (LCP) is 0. Set PSI_API_KEY in server env to enable PageSpeed metrics.';
      } else {
        document.getElementById('envHint').innerText = 'Perf (LCP) loaded via PSI. Great!';
      }
    }
  };

  ws.onerror = (e) => {
    showToast('WebSocket error occurred. Check server logs.', 'error');
    overlay.classList.remove('show');
    isRunning = false;
    btn.disabled = false; btn.innerText = 'START AUDIT';
  };

  ws.onclose = () => {
    // If closed before finished flag, ensure UI isn’t stuck
    if (isRunning) {
      overlay.classList.remove('show');
      isRunning = false;
      btn.disabled = false; btn.innerText = 'START AUDIT';
    }
  };
}

// Button click
document.getElementById('btnRun').addEventListener('click', startAudit);

// Enter key triggers audit
document.getElementById('urlInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    startAudit();
  }
});

// PDF Download
document.getElementById('btnDownload').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const element = document.getElementById('printableArea');
  const noPrint = document.querySelectorAll('.no-print');
  noPrint.forEach(el => el.style.display = 'none');

  const canvas = await html2canvas(element, { backgroundColor: '#0a0e17', scale: 2 });
  const imgData = canvas.toDataURL('image/png');

  const pdf = new jsPDF('p', 'mm', 'a4');
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  // Add image and auto add pages if needed
  let y = 0;
  if (pdfHeight <= pdf.internal.pageSize.getHeight()) {
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  } else {
    // If content is taller than a page, scale to fit height
    const scaledWidth = (imgProps.width * pdf.internal.pageSize.getHeight()) / imgProps.height;
    pdf.addImage(imgData, 'PNG', 0, 0, scaledWidth, pdf.internal.pageSize.getHeight());
  }

  const stamp = new Date().toLocaleString();
  pdf.setTextColor(150);
  pdf.setFontSize(8);
  pdf.text(`Generated: ${stamp} • FF Tech Audit v4.2`, 10, pdf.internal.pageSize.getHeight() - 6);

  pdf.save(`FF-Audit-Report-${new Date().toLocaleDateString().replace(/\//g,'-')}.pdf`);

  noPrint.forEach(el => el.style.display = '');
});
</script>
</body>
</html>
