<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FF Tech Audit – Extreme Adaptive</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root {
  --primary: #fbbf24; --bg: #0f172a; --card: #111827;
  --border: #1f2937; --muted: #94a3b8; --text: #e2e8f0;
  --success: #22c55e; --warning: #eab308; --danger: #ef4444;
}
body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; min-height: 100vh; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; box-shadow: 0 4px 20px rgba(0,0,0,0.5);}
.kpi { font-weight: 800; font-size: 2.8rem; color: var(--primary);}
.muted { color: var(--muted);}
.progress { height: 12px; background: #1e293b; border-radius: 6px; overflow: hidden; }
.badge-grade { font-size: 1.6rem; padding: 0.6rem 1.4rem;}
pre.code-block { background: #0f172a; border:1px solid var(--border); border-radius: 0.5rem; padding:1rem; font-size:0.9rem; max-height:300px; overflow:auto;}
.error-box { background: rgba(239,68,68,0.15); border:1px solid var(--danger); color:#fecaca; padding:1.25rem; border-radius:0.5rem; margin:1.5rem 0;}
canvas { max-height:280px; margin:0 auto; display:block;}
.section-header { color: var(--primary); margin:2rem 0 1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; }
.navbar-brand { color: var(--primary) !important; font-weight: 800; }
</style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg border-bottom border-secondary">
  <div class="container">
    <a class="navbar-brand" href="/">FF Tech Audit Engine</a>
  </div>
</nav>

<div class="container py-5">
  <header class="text-center mb-5">
    <h1 class="display-5 fw-bold text-warning">Extreme Adaptive – Shows Every Attribute</h1>
    <p class="lead muted">WebSocket driven, flexible, auto-adapts to backend changes</p>
  </header>

  <!-- Input & Controls -->
  <section class="card p-4 mb-5 shadow-lg">
    <div class="row g-3 align-items-end">
      <div class="col-md-8">
        <label class="form-label fw-semibold mb-1">Website URL</label>
        <input id="urlInput" type="text" class="form-control bg-dark text-white border-secondary" placeholder="e.g., www.apple.com" autofocus>
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button id="runBtn" class="btn btn-warning fw-bold w-100">RUN AUDIT</button>
        <button id="resetBtn" class="btn btn-outline-danger w-100">RESET</button>
      </div>
    </div>
    <div id="statusLine" class="mt-3 small fw-semibold text-info">Status: Idle</div>
    <div class="progress mt-2">
      <div id="progressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
    </div>
  </section>

  <!-- Error Display -->
  <div id="errorBox" class="error-box d-none"></div>

  <!-- Main Results Area -->
  <div id="resultsArea" class="d-none">
    <section class="row g-4 mb-5" id="kpiSection"></section>
    <section class="row g-4 mb-5" id="chartsSection"></section>
    <section id="breakdownSection"></section>
  </div>

  <footer class="text-center small muted mt-5">
    © FF Tech Audit Engine – Adaptive Mode
  </footer>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ─── Utilities ───
const $ = id => document.getElementById(id);
if (!Element.prototype.empty) Element.prototype.empty = function(){ this.innerHTML=""; return this; };
const create = (tag,className='',html='') => { const el = document.createElement(tag); if(className) el.className=className; if(html) el.innerHTML=html; return el; };
const setText = (id,val) => { if($(id)) $(id).textContent = val ?? "—"; };
const pretty = obj => JSON.stringify(obj,null,2);
const deepGet = (obj,path,fallback="—") => { try { return path.split(".").reduce((a,k)=>a && a[k]!==undefined?a[k]:undefined,obj) ?? fallback } catch { return fallback }};
function logDebug(...args){ console.log(...args); const log=$("#debugLog"); if(log){ log.textContent += args.map(x=>(typeof x==='string'?x:JSON.stringify(x))).join(" ")+"\n"; log.scrollTop=log.scrollHeight; }}

// ─── Reset UI ───
function resetUI(){
  setText("statusLine","Status: Idle");
  $("progressBar").style.width="0%";
  $("#kpiSection")?.empty();
  $("#chartsSection")?.empty();
  $("#breakdownSection")?.empty();
  $("resultsArea")?.classList.add("d-none");
  $("errorBox").classList.add("d-none");
}

// ─── Charts ───
function renderChart(container,title,data,type="bar"){
  const card=create("div","card p-4 mb-4");
  card.innerHTML=`<h6 class="muted fw-semibold mb-3">${title}</h6>`;
  const canvas=create("canvas"); card.appendChild(canvas); container.appendChild(card);
  new Chart(canvas.getContext("2d"),{
    type,
    data,
    options:{
      responsive:true,
      plugins:{ legend:{ labels:{ color:"#e2e8f0" } } },
      scales:type==="bar"?{ x:{ ticks:{ color:"#93c5fd" }, grid:{ color:"#1f2937" } }, y:{ ticks:{ color:"#93c5fd" }, grid:{ color:"#1f2937" }, beginAtZero:true } }:{}
    }
  });
}

// ─── Render All ───
function renderAll(msg){
  $("resultsArea").classList.remove("d-none");
  const kpiSection=$("#kpiSection"); kpiSection.empty();
  // Auto-detect numeric / string KPIs
  Object.entries(msg).forEach(([key,val])=>{
    if(typeof val==="number" || typeof val==="string"){
      const col=create("div","col-md-3");
      const card=create("div","card p-4 text-center");
      card.innerHTML=`<div class="muted small fw-semibold mb-1">${key}</div>
        <div class="kpi">${val}</div>`;
      col.appendChild(card); kpiSection.append(col);
    }
  });

  // Charts if present
  const chartsSection=$("#chartsSection"); chartsSection.empty();
  if(msg.chart_data) Object.entries(msg.chart_data).forEach(([key,data])=> renderChart(chartsSection,key.charAt(0).toUpperCase()+key.slice(1),data));

  // Breakdown (nested objects)
  const breakdownSection=$("#breakdownSection"); breakdownSection.empty();
  Object.entries(msg).forEach(([sectionName,data])=>{
    if(typeof data==="object" && data!==null && !Array.isArray(data)){
      const section=create("div","card p-4 mb-4");
      section.innerHTML=`<h5 class="text-warning mb-3">${sectionName.charAt(0).toUpperCase()+sectionName.slice(1)}</h5>`;
      const pre=create("pre","code-block"); pre.textContent=pretty(data);
      section.appendChild(pre); breakdownSection.append(section);
    }
  });
}

// ─── WebSocket Audit ───
let socket=null;
function makeWsUrl(path){ return `${location.protocol==="https:"?"wss:":"ws:"}//${location.host}${path}`; }

function updateStatus(msg){
  if(msg.status) setText("statusLine",`Status: ${msg.status}`);
  if(typeof msg.crawl_progress==="number") $("progressBar").style.width=`${Math.min(100,Math.max(0,msg.crawl_progress))}%`;
}

function runAudit(url){
  resetUI();
  setText("statusLine","Status: Connecting to WebSocket…");
  $("progressBar").style.width="5%";

  if(socket?.readyState===WebSocket.OPEN) socket.close();

  socket=new WebSocket(makeWsUrl("/ws"));
  socket.addEventListener("open",()=>{ 
    setText("statusLine","Status: Connected. Sending URL…"); 
    socket.send(JSON.stringify({url}));
  });

  socket.addEventListener("message",ev=>{
    let msg;
    try{ msg=JSON.parse(ev.data); }catch(e){ logDebug("Parse error",e); return; }
    updateStatus(msg);
    if(msg.error){ $("errorBox").textContent=msg.error; $("errorBox").classList.remove("d-none"); }
    if(msg.finished && !msg.error){ updateStatus({status:"✅ Completed", crawl_progress:100}); renderAll(msg); }
  });

  socket.addEventListener("close",ev=>{ logDebug("WebSocket closed",ev); setText("statusLine",$("statusLine").textContent+" (closed)"); });
  socket.addEventListener("error",ev=>{ $("errorBox").textContent="Connection failed."; $("errorBox").classList.remove("d-none"); });
}

// ─── Event Listeners ───
$("runBtn").addEventListener("click",()=>{
  const url=$("urlInput").value.trim();
  if(!url){ $("errorBox").textContent="Please enter a valid URL."; $("errorBox").classList.remove("d-none"); return; }
  runAudit(url);
});
$("resetBtn").addEventListener("click",()=>{ if(socket?.readyState===WebSocket.OPEN) socket.close(); resetUI(); });

</script>
</body>
</html>
