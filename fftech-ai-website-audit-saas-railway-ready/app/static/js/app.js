
(function(){
  const themeBtn=document.getElementById('toggleTheme');
  if(themeBtn){ themeBtn.addEventListener('click',()=>{ const html=document.documentElement; html.setAttribute('data-bs-theme', html.getAttribute('data-bs-theme')==='dark'?'light':'dark'); }); }
  const btnOpen=document.getElementById('btnOpenAudit');
  if(btnOpen){ btnOpen.addEventListener('click', async ()=>{ const url=document.getElementById('openUrl').value; const res=await fetch('/api/open-audit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})}); const data=await res.json(); document.getElementById('ovScore').innerText=data.overall_score; new Chart(document.getElementById('breakdownChart'),{type:'bar', data:{labels:Object.keys(data.breakdown), datasets:[{label:'Score', data:Object.values(data.breakdown)}]}}); document.getElementById('openJson').innerText=JSON.stringify(data,null,2); document.getElementById('openResults').classList.remove('d-none'); }); }
  const btnAuth=document.getElementById('btnAuthAudit');
  if(btnAuth){ btnAuth.addEventListener('click', async ()=>{ const url=document.getElementById('authUrl').value; const res=await fetch('/api/audit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})}); const data=await res.json(); if(data.detail){ alert(data.detail); return; } document.getElementById('authOvScore').innerText=data.result_json.overall_score; document.getElementById('authGrade').innerText=data.result_json.grade; new Chart(document.getElementById('authBreakdownChart'),{type:'bar',data:{labels:Object.keys(data.result_json.breakdown),datasets:[{label:'Score',data:Object.values(data.result_json.breakdown)}]}}); document.getElementById('authJson').innerText=JSON.stringify(data.result_json,null,2); document.getElementById('authResults').classList.remove('d-none'); document.getElementById('pdfLink').href=`/api/audit/${data.id}/report.pdf`; }); }
  const btnCompare=document.getElementById('btnCompare');
  if(btnCompare){ btnCompare.addEventListener('click', async ()=>{ const baseUrl=document.getElementById('baseUrl').value.trim(); const comps=document.getElementById('competitors').value.split(',').map(s=>s.trim()).filter(Boolean); const res=await fetch('/api/competitor-audit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:baseUrl,competitors:comps})}); const data=await res.json(); if(data.detail){ alert(data.detail); return; } const labels=[data.base.url, ...data.competitors.map(c=>c.url)]; const scores=[data.base.result.overall_score, ...data.competitors.map(c=>c.result.overall_score)]; new Chart(document.getElementById('cmpOverall'),{type:'bar',data:{labels,datasets:[{label:'Overall Score',data:scores}]}}); function pickMetric(perf,key){ if(!perf) return null; const psi=perf.psi||{}; const mobile=psi.mobile||{}; const desktop=psi.desktop||{}; function val(scope,side){ const src=(side==='mobile'?mobile:desktop); const obj=src[scope]||{}; return obj[key]; } const order=[["field","mobile"],["lab","mobile"],["field","desktop"],["lab","desktop"]]; for(const [scope,side] of order){ const v=val(scope, side); if(v!==undefined&&v!==null) return v; } return perf[key]; }
      const lcpVals=[pickMetric(data.base.result.performance,'lcp_ms'), ...data.competitors.map(c=>pickMetric(c.result.performance,'lcp_ms'))];
      const clsVals=[pickMetric(data.base.result.performance,'cls'), ...data.competitors.map(c=>pickMetric(c.result.performance,'cls'))];
      const inpVals=[pickMetric(data.base.result.performance,'inp_ms'), ...data.competitors.map(c=>pickMetric(c.result.performance,'inp_ms'))];
      new Chart(document.getElementById('cmpLCP'),{type:'bar',data:{labels,datasets:[{label:'LCP (ms)',data:lcpVals}]}});
      new Chart(document.getElementById('cmpCLS'),{type:'bar',data:{labels,datasets:[{label:'CLS (score)',data:clsVals}]}});
      new Chart(document.getElementById('cmpINP'),{type:'bar',data:{labels,datasets:[{label:'INP (ms)',data:inpVals}]}});
      document.getElementById('cmpResults').classList.remove('d-none');
      const btn=document.getElementById('btnCmpPdf'); if(btn){ btn.onclick=async ()=>{ const payload={ url:data.base.url, competitors:data.competitors.map(x=>x.url)}; const r=await fetch('/api/competitor-report.pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const blob=await r.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='competitor_report.pdf'; a.click(); URL.revokeObjectURL(a.href); }; }
    }); }
})();
